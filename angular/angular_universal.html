<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="hwu96hHsSnPefhY5oj_Q2reBfC1YuVkwbsuPeuAjSls"><meta name="baidu-site-verification" content="codeva-1TKHma47RE"><script>!function(t,e,n,c,r,a){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(r=e.createElement(c)).async=1,r.src="https://www.clarity.ms/tag/cnl2uzz0vb?ref=bwt",(a=e.getElementsByTagName(c)[0]).parentNode.insertBefore(r,a)}(window,document,"clarity","script")</script><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic%7CPingFang+SC:300,300italic,400,400italic,700,700italic%7CMicrosoft+YaHei:300,300italic,400,400italic,700,700italic%7Csans-serif:300,300italic,400,400italic,700,700italic%7CLato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"www.pengtech.net","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":"enable","bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><meta name="description" content="1. 前言 2. 什么是 Angular universal 3. 为什么需要 SSR(服务器端渲染) 4. Angular Universal 如何解决 FCP 和 SEO 问题 5. 开启 SSR 6. 开启客户端水合(Client Hydration) 7. 使用 Universal 构建和运行 8. Prerender 预渲染静态 HTML 8.1. 预渲染路径配置   9. SEO 优"><meta property="og:type" content="article"><meta property="og:title" content="Angular universal服务器端渲染与预渲染"><meta property="og:url" content="https://www.pengtech.net/angular/angular_universal.html"><meta property="og:site_name" content="鹏叔的技术博客"><meta property="og:description" content="1. 前言 2. 什么是 Angular universal 3. 为什么需要 SSR(服务器端渲染) 4. Angular Universal 如何解决 FCP 和 SEO 问题 5. 开启 SSR 6. 开启客户端水合(Client Hydration) 7. 使用 Universal 构建和运行 8. Prerender 预渲染静态 HTML 8.1. 预渲染路径配置   9. SEO 优"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2023-05-02T16:00:00.000Z"><meta property="article:modified_time" content="2024-05-01T18:12:12.566Z"><meta property="article:author" content="鹏叔"><meta property="article:tag" content="Angular"><meta property="article:tag" content="javascript"><meta property="article:tag" content="SEO"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.pengtech.net/angular/angular_universal.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.pengtech.net/angular/angular_universal.html","path":"angular/angular_universal.html","title":"Angular universal服务器端渲染与预渲染"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>Angular universal服务器端渲染与预渲染 | 鹏叔的技术博客</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZZTM0Y954E"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-ZZTM0Y954E","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?1da0f55a32eb17a877b1b18efa3d0406"></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i> <span class="site-title h1">鹏叔的技术博客</span> <i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">日拱一卒，功不唐捐!</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-angular"><a href="/angular/" rel="section"><i class="fa fa-th fa-fw"></i>angular</a></li><li class="menu-item menu-item-material-design"><a href="/material-design/" rel="section"><i class="fa fa-th fa-fw"></i>material-design</a></li><li class="menu-item menu-item-linux"><a href="/linux/" rel="section"><i class="fa fa-cube fa-fw"></i>linux</a></li><li class="menu-item menu-item-gitlab"><a href="/gitlab/" rel="section"><i class="fa fa-th fa-fw"></i>gitlab</a></li><li class="menu-item menu-item-frontend"><a href="/frontend/" rel="section"><i class="fa fa-mobile fa-fw"></i>frontend</a></li><li class="menu-item menu-item-backend"><a href="/backend/" rel="section"><i class="fa fa-mobile fa-fw"></i>backend</a></li><li class="menu-item menu-item-vscode"><a href="/vscode/" rel="section"><i class="fa fa-th fa-fw"></i>vscode</a></li><li class="menu-item menu-item-hexo"><a href="/hexo/" rel="section"><i class="fa fa-sitemap fa-fw"></i>hexo</a></li><li class="menu-item menu-item-java"><a href="/java/" rel="section"><i class="fa fa-coffee fa-fw"></i>java</a></li><li class="menu-item menu-item-golang"><a href="/golang/" rel="section"><i class="fa fa-cloud fa-fw"></i>golang</a></li><li class="menu-item menu-item-v2raya"><a href="/v2rayA/" rel="section"><i class="fa fa-cloud fa-fw"></i>v2rayA</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">1. 前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%BB%80%E4%B9%88%E6%98%AF-Angular-universal"><span class="nav-number">2.</span> <span class="nav-text">2. 什么是 Angular universal</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-SSR-%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%B8%B2%E6%9F%93"><span class="nav-number">3.</span> <span class="nav-text">3. 为什么需要 SSR(服务器端渲染)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-Angular-Universal-%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3-FCP-%E5%92%8C-SEO-%E9%97%AE%E9%A2%98"><span class="nav-number">4.</span> <span class="nav-text">4. Angular Universal 如何解决 FCP 和 SEO 问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E5%BC%80%E5%90%AF-SSR"><span class="nav-number">5.</span> <span class="nav-text">5. 开启 SSR</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E5%BC%80%E5%90%AF%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B0%B4%E5%90%88-Client-Hydration"><span class="nav-number">6.</span> <span class="nav-text">6. 开启客户端水合(Client Hydration)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E4%BD%BF%E7%94%A8-Universal-%E6%9E%84%E5%BB%BA%E5%92%8C%E8%BF%90%E8%A1%8C"><span class="nav-number">7.</span> <span class="nav-text">7. 使用 Universal 构建和运行</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-Prerender-%E9%A2%84%E6%B8%B2%E6%9F%93%E9%9D%99%E6%80%81-HTML"><span class="nav-number">8.</span> <span class="nav-text">8. Prerender 预渲染静态 HTML</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#8-1-%E9%A2%84%E6%B8%B2%E6%9F%93%E8%B7%AF%E5%BE%84%E9%85%8D%E7%BD%AE"><span class="nav-number">8.1.</span> <span class="nav-text">8.1. 预渲染路径配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-SEO-%E4%BC%98%E5%8C%96"><span class="nav-number">9.</span> <span class="nav-text">9. SEO 优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-%E5%85%B3%E9%94%AE%E8%AF%8D%E4%B8%8E%E6%8F%8F%E8%BF%B0%E7%9A%84%E4%BC%98%E5%8C%96"><span class="nav-number">9.1.</span> <span class="nav-text">9.1. 关键词与描述的优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-%E5%86%85%E9%83%A8%E8%B7%B3%E8%BD%AC%E4%BC%98%E5%8C%96"><span class="nav-number">9.2.</span> <span class="nav-text">9.2. 内部跳转优化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-%E6%A0%B7%E5%BC%8F%E6%96%87%E4%BB%B6%E6%89%93%E5%8C%85"><span class="nav-number">9.3.</span> <span class="nav-text">9.3. 样式文件打包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-4-%E6%B7%BB%E5%8A%A0-robots-txt"><span class="nav-number">9.4.</span> <span class="nav-text">9.4. 添加 robots.txt</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-5-%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90-sitemap"><span class="nav-number">9.5.</span> <span class="nav-text">9.5. 自动生成 sitemap</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-%E4%BD%BF%E7%94%A8-Nginx-%E9%83%A8%E7%BD%B2"><span class="nav-number">10.</span> <span class="nav-text">10. 使用 Nginx 部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-1-%E5%AE%89%E8%A3%85-Nginx"><span class="nav-number">10.1.</span> <span class="nav-text">10.1. 安装 Nginx</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-%E5%AE%89%E8%A3%85-Node"><span class="nav-number">10.2.</span> <span class="nav-text">10.2. 安装 Node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-3-%E5%AE%89%E8%A3%85-PM2"><span class="nav-number">10.3.</span> <span class="nav-text">10.3. 安装 PM2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-4-%E9%85%8D%E7%BD%AE%E5%B9%B6%E5%90%AF%E5%8A%A8-pm2"><span class="nav-number">10.4.</span> <span class="nav-text">10.4. 配置并启动 pm2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-5-%E9%85%8D%E7%BD%AE-Nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="nav-number">10.5.</span> <span class="nav-text">10.5. 配置 Nginx 反向代理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-troubleshooting"><span class="nav-number">11.</span> <span class="nav-text">11. troubleshooting</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#11-1-%E9%97%AE%E9%A2%98-1-Configuration-%E2%80%98development%E2%80%99-is-not-set-in-the-workspace"><span class="nav-number">11.1.</span> <span class="nav-text">11.1. 问题 1: Configuration ‘development’ is not set in the workspace</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-2-%E9%97%AE%E9%A2%98-2-ReferenceError-window-is-not-defined"><span class="nav-number">11.2.</span> <span class="nav-text">11.2. 问题 2: ReferenceError: window is not defined</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-3-%E9%97%AE%E9%A2%98-3-Flex-Layout-loaded-on-the-server-without-FlexLayoutServerModule"><span class="nav-number">11.3.</span> <span class="nav-text">11.3. 问题 3: Flex Layout loaded on the server without FlexLayoutServerModule</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-4-%E9%97%AE%E9%A2%98-4-XMLHttpRequest-is-not-defined"><span class="nav-number">11.4.</span> <span class="nav-text">11.4. 问题 4: XMLHttpRequest is not defined</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#11-5-%E9%97%AE%E9%A2%98-5%EF%BC%9A-dist-demo-web-browser-ReferenceError-Image-is-not-defined"><span class="nav-number">11.5.</span> <span class="nav-text">11.5. 问题 5： \dist\demo-web\browser...ReferenceError: Image is not defined</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-%E7%9B%B8%E5%85%B3%E9%98%85%E8%AF%BB"><span class="nav-number">12.</span> <span class="nav-text">12. 相关阅读</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="nav-number">13.</span> <span class="nav-text">13. 参考文档</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="鹏叔" src="/imgs/avatar.gif"><p class="site-author-name" itemprop="name">鹏叔</p><div class="site-description" itemprop="description">鹏叔的技术博客, 鹏叔的技术博客, 收集鹏叔在日常工作中整理的技术博客, 内容包括前端javascript, material design, typescript, css, html, 后端golang, java, 数据库等.</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">249</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">35</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">76</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/guoapeng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;guoapeng" rel="noopener external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:guoapeng@gmail.com" title="E-Mail → mailto:guoapeng@gmail.com" rel="noopener external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a></span></div><div class="cc-license site-overview-item animated" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener external nofollow" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll site-overview-item animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://philoenglish.com/" title="https:&#x2F;&#x2F;philoenglish.com" target="_blank">菲利英语</a></li></ul></div></div></div><div class="back-to-top animated" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div class="sidebar-dimmer"></div></header><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.pengtech.net/angular/angular_universal.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/imgs/avatar.gif"><meta itemprop="name" content="鹏叔"><meta itemprop="description" content="鹏叔的技术博客, 鹏叔的技术博客, 收集鹏叔在日常工作中整理的技术博客, 内容包括前端javascript, material design, typescript, css, html, 后端golang, java, 数据库等."></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="鹏叔的技术博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Angular universal服务器端渲染与预渲染</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2023-05-03 00:00:00" itemprop="dateCreated datePublished" datetime="2023-05-03T00:00:00+08:00">2023-05-03</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-05-02 02:12:12" itemprop="dateModified" datetime="2024-05-02T02:12:12+08:00">2024-05-02</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/frontend/" itemprop="url" rel="index"><span itemprop="name">frontend</span></a> </span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span id="busuanzi_value_page_pv"></span> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>22k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>20 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#1-%E5%89%8D%E8%A8%80">1. 前言</a></li><li><a href="#2-%E4%BB%80%E4%B9%88%E6%98%AF-angular-universal">2. 什么是 Angular universal</a></li><li><a href="#3-%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81-ssr%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%B8%B2%E6%9F%93">3. 为什么需要 SSR(服务器端渲染)</a></li><li><a href="#4-angular-universal-%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3-fcp-%E5%92%8C-seo-%E9%97%AE%E9%A2%98">4. Angular Universal 如何解决 FCP 和 SEO 问题</a></li><li><a href="#5-%E5%BC%80%E5%90%AF-ssr">5. 开启 SSR</a></li><li><a href="#6-%E5%BC%80%E5%90%AF%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B0%B4%E5%90%88client-hydration">6. 开启客户端水合(Client Hydration)</a></li><li><a href="#7-%E4%BD%BF%E7%94%A8-universal-%E6%9E%84%E5%BB%BA%E5%92%8C%E8%BF%90%E8%A1%8C">7. 使用 Universal 构建和运行</a></li><li><a href="#8-prerender-%E9%A2%84%E6%B8%B2%E6%9F%93%E9%9D%99%E6%80%81-html">8. Prerender 预渲染静态 HTML</a><ul><li><a href="#81-%E9%A2%84%E6%B8%B2%E6%9F%93%E8%B7%AF%E5%BE%84%E9%85%8D%E7%BD%AE">8.1. 预渲染路径配置</a></li></ul></li><li><a href="#9-seo-%E4%BC%98%E5%8C%96">9. SEO 优化</a><ul><li><a href="#91-%E5%85%B3%E9%94%AE%E8%AF%8D%E4%B8%8E%E6%8F%8F%E8%BF%B0%E7%9A%84%E4%BC%98%E5%8C%96">9.1. 关键词与描述的优化</a></li><li><a href="#92-%E5%86%85%E9%83%A8%E8%B7%B3%E8%BD%AC%E4%BC%98%E5%8C%96">9.2. 内部跳转优化</a></li><li><a href="#93-%E6%A0%B7%E5%BC%8F%E6%96%87%E4%BB%B6%E6%89%93%E5%8C%85">9.3. 样式文件打包</a></li><li><a href="#94-%E6%B7%BB%E5%8A%A0-robotstxt">9.4. 添加 robots.txt</a></li><li><a href="#95-%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90-sitemap">9.5. 自动生成 sitemap</a></li></ul></li><li><a href="#10-%E4%BD%BF%E7%94%A8-nginx-%E9%83%A8%E7%BD%B2">10. 使用 Nginx 部署</a><ul><li><a href="#101-%E5%AE%89%E8%A3%85-nginx">10.1. 安装 Nginx</a></li><li><a href="#102-%E5%AE%89%E8%A3%85-node">10.2. 安装 Node</a></li><li><a href="#103-%E5%AE%89%E8%A3%85-pm2">10.3. 安装 PM2</a></li><li><a href="#104-%E9%85%8D%E7%BD%AE%E5%B9%B6%E5%90%AF%E5%8A%A8-pm2">10.4. 配置并启动 pm2</a></li><li><a href="#105-%E9%85%8D%E7%BD%AE-nginx-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86">10.5. 配置 Nginx 反向代理</a></li></ul></li><li><a href="#11-troubleshooting">11. troubleshooting</a><ul><li><a href="#111-%E9%97%AE%E9%A2%98-1-configuration-development-is-not-set-in-the-workspace">11.1. 问题 1: Configuration ‘development’ is not set in the workspace</a></li><li><a href="#112-%E9%97%AE%E9%A2%98-2-referenceerror-window-is-not-defined">11.2. 问题 2: ReferenceError: window is not defined</a></li><li><a href="#113-%E9%97%AE%E9%A2%98-3-flex-layout-loaded-on-the-server-without-flexlayoutservermodule">11.3. 问题 3: Flex Layout loaded on the server without FlexLayoutServerModule</a></li><li><a href="#114-%E9%97%AE%E9%A2%98-4-xmlhttprequest-is-not-defined">11.4. 问题 4: XMLHttpRequest is not defined</a></li><li><a href="#115-%E9%97%AE%E9%A2%98-5-distdemo-webbrowserreferenceerror-image-is-not-defined">11.5. 问题 5： <code>\dist\demo-web\browser...ReferenceError: Image is not defined</code></a></li></ul></li><li><a href="#12-%E7%9B%B8%E5%85%B3%E9%98%85%E8%AF%BB">12. 相关阅读</a></li><li><a href="#13-%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3">13. 参考文档</a></li></ul><h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>当初选择将应用做成 SPA(单页应用)的时候主要是觉得用户体验非常丝滑, 当时也知道 SPA 很难做 SEO, 还是毅然决然的选择做成 SPA 应用. 当时还是 Angularjs 1.X 的时候, 就觉得 Angular 的理念跟自己对前端的看法特别契合, 后来将框架升级到 Angular 11 继而 13, 虽然费了很多时间和精力, 但是收获非常多, 由于本文的重点是 SSR 与 prerendering,所以这里不赘述原因了. 之前也了解到 Angular Universal 是做服务器端渲染的套件(SSR), 乘最近有空刚好将其引入到项目. 实现地过程中虽然遇到问题, 但是还是有些小兴奋的感觉, 一来解决了首次访问应用时白屏的问题, 二来将当初打算舍弃的 SEO 能力也找了回来, 而且整个对引入 SSR 实现 SEO 的过程还是相当轻松的, 特写此文, 以防遗忘, 也希望给后来者有所帮助.</p><span id="more"></span><h2 id="2-什么是-Angular-universal"><a href="#2-什么是-Angular-universal" class="headerlink" title="2. 什么是 Angular universal"></a>2. 什么是 Angular universal</h2><p>Angular universal 是一个用于服务器端渲染 Angular 应用程序的框架. 它允许在服务器上生成 HTML, 以便在浏览器中更快地呈现应用程序, 这对于提高应用程序的性能和搜索引擎优化(SEO)非常有用. 在使用 Angular Universal 时, 应用程序的初始加载时间可能会增加, 但是在浏览器中呈现应用程序的速度会更快, 因为大部分工作已经在服务器上完成了.</p><h2 id="3-为什么需要-SSR-服务器端渲染"><a href="#3-为什么需要-SSR-服务器端渲染" class="headerlink" title="3. 为什么需要 SSR(服务器端渲染)"></a>3. 为什么需要 SSR(服务器端渲染)</h2><p>在深入了解 Angular universal 之前, 我们需要了解一下 SSR(服务器端渲染), 一项技术的出现并流行, 一定是它解决了一类问题或者是解决了一些痛点. 那么 SSR(Server Side Rendering)的出现解决了哪些痛点呢? 相对于 MPA(Multiple Page Application)风格来说,SPA 这种架构风格有很多的优点,但是也存在非常明显两个的缺点, 而 SSR 技术的出现就是为了解决这两个痛点的. 根据本文的主题 SPA 的优缺点列举如下, 比如:</p><ul><li>更快的用户体验</li><li>更好的交互性</li><li>更好的可维护性</li></ul><p>SPA 架构风格也存在两个非常大的痛点:</p><ul><li>初始加载时间较长</li></ul><p>未经优化的 SPA 应用在进行首次内容绘制(FCP - First Contentful Paint)时会存在非常严重的首页白屏问题, 由于用户首次访问 SPA 时需要加载大量的 JS 代码, 而且要经过解析后才能开始渲染页面, 整个过程需要耗费大量的时间, 往往会大大超过用户原意等待时间 3 秒, 而且随着应用的功能增加问题越来越严重.</p><ul><li>SEO 不友好</li></ul><p>SPA 不利于搜索引擎的抓取, 由于搜索引擎使用网络爬虫来索引网页, 这些爬虫依赖 HTML 内容来理解网页的结构和内容. 然而, 在 SPA 中, 内容是由 JavaScript 动态生成的, 这意味着发送到浏览器的初始 HTML 文件通常为空或包含非常少的内容. 这使得搜索引擎难以正确索引页面, 因为它们可能无法看到由 Javascript 生成的内容. 强如 google 这样的索引擎虽然可以索引 SPA 网页内容, 但是这并不总是可靠的. 如果你想要确保 SPA 网页内容能被搜索引擎正确索引, 最好使用服务器端渲染来生成 HTML 内容并将其发送到浏览器.</p><p>而 SSR 就是为解决以上两个痛点而是的.</p><h2 id="4-Angular-Universal-如何解决-FCP-和-SEO-问题"><a href="#4-Angular-Universal-如何解决-FCP-和-SEO-问题" class="headerlink" title="4. Angular Universal 如何解决 FCP 和 SEO 问题"></a>4. Angular Universal 如何解决 FCP 和 SEO 问题</h2><p>Angular Universal 允许我们为 Angular 应用程序进行服务器端渲染. 这意味着我们可以在服务器上生成 HTML 内容并将其发送到浏览器, 而不是在浏览器中使用 Javascript 动态生成内容. 这样, 搜索引擎可以看到页面的全部内容并正确索引它, 从而解决 SPA 应用程序的 SEO 问题.</p><p>此外, Angular Universal 还可以解决 FCP(首次内容绘制)性能问题. 由于 SPA 应用程序的初始 HTML 文件通常为空或者包含非常少的内容, 因此它们需要大量的 JavaScript 代码来生成内容. 这会导致长时间的初始加载时间, 从而影响 FCP 性能. 使用 Angular Universal 进行服务器端渲染可以解决这个问题, 因为它可以在服务器上生成完整的 HTML 内容并将其发送到浏览器, 从而在让浏览器快速展现页面轮廓, 减少白屏时间, 于此同时浏览器会加载整个应用所需的 Javascript 代码, 从而提高整体的用户体验. 读到这里读者可能会有一个疑惑, 那就是 SPA 不又变成 MPA 了吗? 其实不然, HTML 内容只是为了减少用户等待时间, 在 Javascript 完全加载完成之前,给用户展示页面内容, 一旦 Javascript 加载完成, 前端页面会被重新绘制, 然后完全接管用户的交互任务. 所以在 javascript 加载完成后页面有一个非常短的闪烁, 那就是 Javascript 重新绘制 First Content 的过程. 当然这样的闪烁动作对要求苛刻的系统来说也是不可接受的, Angular 也有相应的解决办法, 后面文章会讲到.</p><p>那么具体来讲, Angular Universal 是如何进行服务器端渲染的呢?</p><p>我们知道 Javascript 是可以通过 Node.js 在在服务器端执行的, 每错 Angular Universal 正式通过 Express 这个 Node.js 应用程序框架提供的强大功能和工具在后端处理请求, 再将生成的 HTML 页面发送到前端或者喂给爬虫, 这样前端就能快速渲染页面, 爬虫也能得到某个页面完整的 HTML 内容, 从而正确地为页面建立索引.</p><p>当然这并不是完美地解决 FCP 和 SEO 问题, 因为 Node.js 执行 javascript 仍然需要时间和占用大量的服务器资源, 一旦请求增多, 频率加快, express 将会称为瓶颈, 是一个非常影响 TTFB(Time to first byte)指标的问题.</p><p>那么怎样进一步解决该问题呢, 这里有两种思路:</p><ul><li><p>一种是采用数据库缓存例如 Redis 或 Memcached, 将页面缓存起来, 当下次访问相同页面时从缓存调取, 从而避免 express 重新执行 javascript 从而提高性能. 而此方案不是本文讲解的重点, 如果要采用此方案, 请自行百度或 google 了解相关详情.</p></li><li><p>另外一种方案叫 Prerender 技术. 它在构建时就为应用程序的每个页面生成静态 HTML 文件, 而不是依赖 JavaScript 在运行时动态生成内容. 当用户请求页面时, 这些静态 HTML 文件可以直接发送到用户浏览器, 从而提高首次内容呈现(FCP)的时间, 并使搜索引擎更容易爬取和索引内容.</p></li></ul><h2 id="5-开启-SSR"><a href="#5-开启-SSR" class="headerlink" title="5. 开启 SSR"></a>5. 开启 SSR</h2><p>您可以使用@nguniversal/express-engine 依赖包在 Angular 应用程序中启用服务器端渲染，如下:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 进入项目根目录</span></span><br><span class="line"><span class="comment"># 添加express-engine</span></span><br><span class="line">ng add @nguniversal/express-engine</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>说明: Angular Universal 需要 Node.js 的 Active LTS 版本或维护 LTS 版本。有关信息，请参阅<a target="_blank" rel="noopener" href="https://angular.io/guide/versions">版本兼容性</a>指南以了解当前支持的版本。</p></blockquote><p>该命令更新应用程序代码以启用 SSR，并向项目结构中添加额外的文件。</p><p>该命令会新增以下三个文件, 并修改以下一些文件</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">src / main.server.ts; <span class="comment">// &lt;-- * server-side application configuration (standalone app only)</span></span><br><span class="line">src / app / app.server.module.ts; <span class="comment">// &lt;-- * server-side application module (NgModule app only)</span></span><br><span class="line">server.ts; <span class="comment">// &lt;-- * express web server</span></span><br></pre></td></tr></table></figure><p>angular-universal-demo/angular.json</p><blockquote><p>注意: 此处的 angular.json 有一些手动更改, 主要在”serve-ssr”这个节点, 主要是为了解决 Angular 的一个 bug.<br>bug 详情请参考这个<a target="_blank" rel="noopener" href="https://github.com/angular/universal/issues/2158">issue report - Congiguration ‘development’ is not set in the workspace</a></p></blockquote><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">--- a/angular-universal-demo/angular.json</span></span><br><span class="line"><span class="comment">+++ b/angular-universal-demo/angular.json</span></span><br><span class="line"><span class="meta">@@ -36,7 +36,7 @@</span></span><br><span class="line">         &quot;build&quot;: &#123;</span><br><span class="line">           &quot;builder&quot;: &quot;@angular-devkit/build-angular:browser&quot;,</span><br><span class="line">           &quot;options&quot;: &#123;</span><br><span class="line"><span class="deletion">-            &quot;outputPath&quot;: &quot;dist/angular-universal-demo&quot;,</span></span><br><span class="line"><span class="addition">+            &quot;outputPath&quot;: &quot;dist/angular-universal-demo/browser&quot;,</span></span><br><span class="line">             &quot;index&quot;: &quot;src/index.html&quot;,</span><br><span class="line">             &quot;main&quot;: &quot;src/main.ts&quot;,</span><br><span class="line">             &quot;polyfills&quot;: &quot;src/polyfills.ts&quot;,</span><br><span class="line"><span class="meta">@@ -152,6 +152,73 @@</span></span><br><span class="line">               &quot;devServerTarget&quot;: &quot;angular-universal-demo:serve:dev&quot;</span><br><span class="line">             &#125;</span><br><span class="line">           &#125;</span><br><span class="line"><span class="addition">+        &#125;,</span></span><br><span class="line"><span class="addition">+        &quot;server&quot;: &#123;</span></span><br><span class="line"><span class="addition">+          &quot;builder&quot;: &quot;@angular-devkit/build-angular:server&quot;,</span></span><br><span class="line"><span class="addition">+          &quot;options&quot;: &#123;</span></span><br><span class="line"><span class="addition">+            &quot;outputPath&quot;: &quot;dist/angular-universal-demo/server&quot;,</span></span><br><span class="line"><span class="addition">+            &quot;main&quot;: &quot;server.ts&quot;,</span></span><br><span class="line"><span class="addition">+            &quot;tsConfig&quot;: &quot;tsconfig.server.json&quot;,</span></span><br><span class="line"><span class="addition">+            &quot;optimization&quot;: false,</span></span><br><span class="line"><span class="addition">+            &quot;sourceMap&quot;: true,</span></span><br><span class="line"><span class="addition">+            &quot;extractLicenses&quot;: false</span></span><br><span class="line"><span class="addition">+          &#125;,</span></span><br><span class="line"><span class="addition">+          &quot;configurations&quot;: &#123;</span></span><br><span class="line"><span class="addition">+            &quot;production&quot;: &#123;</span></span><br><span class="line"><span class="addition">+              &quot;outputHashing&quot;: &quot;media&quot;,</span></span><br><span class="line"><span class="addition">+              &quot;fileReplacements&quot;: [</span></span><br><span class="line"><span class="addition">+                &#123;</span></span><br><span class="line"><span class="addition">+                  &quot;replace&quot;: &quot;src/environments/environment.ts&quot;,</span></span><br><span class="line"><span class="addition">+                  &quot;with&quot;: &quot;src/environments/environment.prod.ts&quot;</span></span><br><span class="line"><span class="addition">+                &#125;</span></span><br><span class="line"><span class="addition">+              ],</span></span><br><span class="line"><span class="addition">+              &quot;optimization&quot;: true,</span></span><br><span class="line"><span class="addition">+              &quot;sourceMap&quot;: false,</span></span><br><span class="line"><span class="addition">+              &quot;extractLicenses&quot;: true</span></span><br><span class="line"><span class="addition">+            &#125;,</span></span><br><span class="line"><span class="addition">+            &quot;dev&quot;: &#123;</span></span><br><span class="line"><span class="addition">+              &quot;fileReplacements&quot;: [</span></span><br><span class="line"><span class="addition">+                &#123;</span></span><br><span class="line"><span class="addition">+                  &quot;replace&quot;: &quot;src/environments/environment.ts&quot;,</span></span><br><span class="line"><span class="addition">+                  &quot;with&quot;: &quot;src/environments/environment.dev.ts&quot;</span></span><br><span class="line"><span class="addition">+                &#125;</span></span><br><span class="line"><span class="addition">+              ]</span></span><br><span class="line"><span class="addition">+            &#125;</span></span><br><span class="line"><span class="addition">+          &#125;,</span></span><br><span class="line"><span class="addition">+          &quot;defaultConfiguration&quot;: &quot;production&quot;</span></span><br><span class="line"><span class="addition">+        &#125;,</span></span><br><span class="line"><span class="addition">+        &quot;serve-ssr&quot;: &#123;</span></span><br><span class="line"><span class="addition">+          &quot;builder&quot;: &quot;@nguniversal/builders:ssr-dev-server&quot;,</span></span><br><span class="line"><span class="addition">+          &quot;options&quot;: &#123;</span></span><br><span class="line"><span class="addition">+              &quot;browserTarget&quot;: &quot;angular-universal-demo:build&quot;,</span></span><br><span class="line"><span class="addition">+              &quot;serverTarget&quot;: &quot;angular-universal-demo:server&quot;</span></span><br><span class="line"><span class="addition">+          &#125;,</span></span><br><span class="line"><span class="addition">+          &quot;configurations&quot;: &#123;</span></span><br><span class="line"><span class="addition">+            &quot;production&quot;: &#123;</span></span><br><span class="line"><span class="addition">+              &quot;browserTarget&quot;: &quot;angular-universal-demo:build:production&quot;,</span></span><br><span class="line"><span class="addition">+              &quot;serverTarget&quot;: &quot;angular-universal-demo:server:production&quot;</span></span><br><span class="line"><span class="addition">+            &#125;</span></span><br><span class="line"><span class="addition">+          &#125;</span></span><br><span class="line"><span class="addition">+        &#125;,</span></span><br><span class="line"><span class="addition">+        &quot;prerender&quot;: &#123;</span></span><br><span class="line"><span class="addition">+          &quot;builder&quot;: &quot;@nguniversal/builders:prerender&quot;,</span></span><br><span class="line"><span class="addition">+          &quot;options&quot;: &#123;</span></span><br><span class="line"><span class="addition">+            &quot;routes&quot;: [</span></span><br><span class="line"><span class="addition">+              &quot;/&quot;</span></span><br><span class="line"><span class="addition">+            ]</span></span><br><span class="line"><span class="addition">+          &#125;,</span></span><br><span class="line"><span class="addition">+          &quot;configurations&quot;: &#123;</span></span><br><span class="line"><span class="addition">+            &quot;production&quot;: &#123;</span></span><br><span class="line"><span class="addition">+              &quot;browserTarget&quot;: &quot;angular-universal-demo:build:production&quot;,</span></span><br><span class="line"><span class="addition">+              &quot;serverTarget&quot;: &quot;angular-universal-demo:server:production&quot;</span></span><br><span class="line"><span class="addition">+            &#125;,</span></span><br><span class="line"><span class="addition">+            &quot;development&quot;: &#123;</span></span><br><span class="line"><span class="addition">+              &quot;browserTarget&quot;: &quot;angular-universal-demo:build:development&quot;,</span></span><br><span class="line"><span class="addition">+              &quot;serverTarget&quot;: &quot;angular-universal-demo:server:development&quot;</span></span><br><span class="line"><span class="addition">+            &#125;</span></span><br><span class="line"><span class="addition">+          &#125;,</span></span><br><span class="line"><span class="addition">+          &quot;defaultConfiguration&quot;: &quot;production&quot;</span></span><br><span class="line">         &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>angular-universal-demo/package.json</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">--- a/angular-universal-demo/package.json</span></span><br><span class="line"><span class="comment">+++ b/angular-universal-demo/package.json</span></span><br><span class="line"><span class="meta">@@ -9,7 +9,11 @@</span></span><br><span class="line">     &quot;buildProd&quot;: &quot;ng build --configuration production&quot;,</span><br><span class="line">     &quot;test&quot;: &quot;ng test&quot;,</span><br><span class="line">     &quot;lint&quot;: &quot;ng lint&quot;,</span><br><span class="line"><span class="deletion">-    &quot;e2e&quot;: &quot;ng e2e&quot;</span></span><br><span class="line"><span class="addition">+    &quot;e2e&quot;: &quot;ng e2e&quot;,</span></span><br><span class="line"><span class="addition">+    &quot;dev:ssr&quot;: &quot;ng run angular-universal-demo:serve-ssr&quot;,</span></span><br><span class="line"><span class="addition">+    &quot;serve:ssr&quot;: &quot;node dist/angular-universal-demo/server/main.js&quot;,</span></span><br><span class="line"><span class="addition">+    &quot;build:ssr&quot;: &quot;ng build &amp;&amp; ng run angular-universal-demo:server&quot;,</span></span><br><span class="line"><span class="addition">+    &quot;prerender&quot;: &quot;ng run angular-universal-demo:prerender&quot;</span></span><br><span class="line">   &#125;,</span><br><span class="line">   &quot;private&quot;: true,</span><br><span class="line">   &quot;dependencies&quot;: &#123;</span><br><span class="line"><span class="meta">@@ -18,24 +22,27 @@</span></span><br><span class="line">     &quot;@angular/cdk&quot;: &quot;13.3.1&quot;,</span><br><span class="line">     &quot;@angular/platform-browser-dynamic&quot;: &quot;13.3.1&quot;,</span><br><span class="line"><span class="addition">+    &quot;@angular/platform-server&quot;: &quot;13.3.1&quot;,</span></span><br><span class="line">     &quot;@angular/router&quot;: &quot;13.3.1&quot;,</span><br><span class="line">     &quot;@swimlane/ngx-charts&quot;: &quot;19.1.0&quot;,</span><br><span class="line">     &quot;@swimlane/ngx-datatable&quot;: &quot;20.0.0&quot;,</span><br><span class="line"><span class="addition">+    &quot;@nguniversal/express-engine&quot;: &quot;^13.1.0&quot;,</span></span><br><span class="line">     &quot;@angular/cli&quot;: &quot;13.3.1&quot;,</span><br><span class="line">     &quot;@angular/compiler-cli&quot;: &quot;13.3.1&quot;,</span><br><span class="line">     &quot;@angular/language-service&quot;: &quot;13.3.1&quot;,</span><br><span class="line"><span class="addition">+    &quot;@nguniversal/builders&quot;: &quot;^13.1.0&quot;,</span></span><br><span class="line"><span class="addition">+    &quot;@types/express&quot;: &quot;^4.17.0&quot;,</span></span><br></pre></td></tr></table></figure><p>app.module.ts</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- a/angular-universal-demo/src/app/app.module.ts</span></span><br><span class="line"><span class="comment">+++ b/angular-universal-demo/src/app/app.module.ts</span></span><br><span class="line"><span class="meta">@@ -33,7 +33,7 @@</span> const DEFAULT_PERFECT_SCROLLBAR_CONFIG: PerfectScrollbarConfigInterface = &#123;</span><br><span class="line"></span><br><span class="line"> @NgModule(&#123;</span><br><span class="line">   imports: [</span><br><span class="line"><span class="deletion">-    BrowserModule,</span></span><br><span class="line"><span class="addition">+    BrowserModule.withServerTransition(&#123; appId: &#x27;serverApp&#x27; &#125;),</span></span><br><span class="line">     BrowserAnimationsModule,</span><br><span class="line">     FormsModule,</span><br><span class="line">     HttpClientModule,</span><br></pre></td></tr></table></figure><blockquote><p>Angular 会把 appId 值（它可以是任何字符串）添加到服务端渲染页面的样式名中，以便在客户端应用启动时可以找到并移除它们。</p></blockquote><p>app.routing.ts</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- a/angular-universal-demo/src/app/app.routing.ts</span></span><br><span class="line"><span class="comment">+++ b/angular-universal-demo/src/app/app.routing.ts</span></span><br><span class="line"><span class="meta">@@ -19,10 +19,10 @@</span> export const routes: Routes = [</span><br><span class="line"> @NgModule(&#123;</span><br><span class="line">     imports: [</span><br><span class="line">         RouterModule.forRoot(routes, &#123;</span><br><span class="line"><span class="deletion">-            preloadingStrategy: PreloadAllModules,</span></span><br><span class="line"><span class="deletion">-            relativeLinkResolution: &#x27;legacy&#x27;,</span></span><br><span class="line"><span class="deletion">-            // useHash: true</span></span><br><span class="line"><span class="deletion">-        &#125;)</span></span><br><span class="line"><span class="addition">+    preloadingStrategy: PreloadAllModules,</span></span><br><span class="line"><span class="addition">+    relativeLinkResolution: &#x27;legacy&#x27;,</span></span><br><span class="line"><span class="addition">+    initialNavigation: &#x27;enabledBlocking&#x27;</span></span><br><span class="line"><span class="addition">+&#125;)</span></span><br><span class="line">     ],</span><br><span class="line">     exports: [</span><br><span class="line">         RouterModule</span><br></pre></td></tr></table></figure><p>“enabledBlocking”-在创建根组件之前开始初始化导航。引导程序将被 blocked，直到初始导航完成。此值是服务器端渲染工作所必需的。</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">--- a/angular-universal-demo/src/main.ts</span></span><br><span class="line"><span class="comment">+++ b/angular-universal-demo/src/main.ts</span></span><br><span class="line"><span class="meta">@@ -9,5 +9,15 @@</span> if (environment.production) &#123;</span><br><span class="line">   enableProdMode();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="deletion">-platformBrowserDynamic().bootstrapModule(AppModule)</span></span><br><span class="line"><span class="addition">+function bootstrap() &#123;</span></span><br><span class="line"><span class="addition">+     platformBrowserDynamic().bootstrapModule(AppModule)</span></span><br><span class="line">   .catch(err =&gt; console.error(err));</span><br><span class="line"><span class="addition">+   &#125;;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+if (document.readyState === &#x27;complete&#x27;) &#123;</span></span><br><span class="line"><span class="addition">+  bootstrap();</span></span><br><span class="line"><span class="addition">+&#125; else &#123;</span></span><br><span class="line"><span class="addition">+  document.addEventListener(&#x27;DOMContentLoaded&#x27;, bootstrap);</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="6-开启客户端水合-Client-Hydration"><a href="#6-开启客户端水合-Client-Hydration" class="headerlink" title="6. 开启客户端水合(Client Hydration)"></a>6. 开启客户端水合(Client Hydration)</h2><p>客户端水合是在客户端上恢复服务器端呈现的应用程序的过程。这包括重用服务器呈现的 DOM 结构、持久化应用程序状态、传输服务器已经检索到的应用程序数据以及其他进程。<br>您可以通过修改 app.module.ts 文件来启用水合</p><p>如果是 Angular 11 以上 16 以下的版本, 要达到 Hydration 的效果可参考如下配置, 需要引入 BrowserTransferStateModule.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; BrowserModule &#125; <span class="keyword">from</span> <span class="string">&quot;@angular/platform-browser&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; NgModule &#125; <span class="keyword">from</span> <span class="string">&quot;@angular/core&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; AppComponent &#125; <span class="keyword">from</span> <span class="string">&quot;./app.component&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; BrowserTransferStateModule &#125; <span class="keyword">from</span> <span class="string">&quot;@angular/platform-browser&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">declarations</span>: [AppComponent],</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    BrowserModule.withServerTransition(&#123; <span class="attr">appId</span>: <span class="string">&quot;serverApp&quot;</span> &#125;),</span><br><span class="line">    BrowserTransferStateModule,</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">bootstrap</span>: [AppComponent],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure><p>如果 Angular 16 为了达到 Hydration 的效果, 可以参考如下配置:<br>。从@angular/platform-browser 导入 provideClientHydration 函数，并将函数调用添加到 AppModule 的 providers 部分，如下所示。</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; provideClientHydration &#125; <span class="keyword">from</span> <span class="string">&quot;@angular/platform-browser&quot;</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="attr">providers</span>: [provideClientHydration()], <span class="comment">// add this line</span></span><br><span class="line">  <span class="attr">bootstrap</span>: [AppComponent],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AppModule</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>更新: 2023/11/10</p><p>即使升级到 Angular 15, 16 以后, 如果使用的是 NgModule 的方式引导启动应用程序, 本教程还是完全适用的.</p><p>另外 Angular 15 对 以 standalone component 启动应用并且开启 ssr 的支持没有 16 完善, 在条件许可的情况下建议升级完 15 后接着升级到 16, 如果坚持使用 15 的话, 建议不要使用 standalone component 来引导应用程序, 到 16 以后就可以放心大胆使用 standalone component 来启动应用了.</p><p>在 Angular 15, 16 中, 如果使用的是 Angular standalone component 引导启动应用程序, 以下三个文件 server.ts, src/main.server.ts, app.config.server.ts 的写法是跟本教程稍有不同, 为了不破坏文档的结构, 也避免制造一些混乱, 这里不将这种配置上差异列举出来了. 具体差异可以结合 github 上的一个示例<a target="_blank" rel="noopener" href="https://github.com/brandonroberts/angular-v16-universal-standalone">angular-v16-universal-standalone</a>, 参考本文档, 可以解决大部分的问题.</p><h2 id="7-使用-Universal-构建和运行"><a href="#7-使用-Universal-构建和运行" class="headerlink" title="7. 使用 Universal 构建和运行"></a>7. 使用 Universal 构建和运行</h2><p>构建 SSR</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run build:ssr</span><br></pre></td></tr></table></figure><p>构建完应用之后，启动服务器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run serve:ssr</span><br></pre></td></tr></table></figure><p>或者构建同时启动服务器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run dev:ssr</span><br></pre></td></tr></table></figure><h2 id="8-Prerender-预渲染静态-HTML"><a href="#8-Prerender-预渲染静态-HTML" class="headerlink" title="8. Prerender 预渲染静态 HTML"></a>8. Prerender 预渲染静态 HTML</h2><p>经过上面的步骤后，如果我们通过<code>npm run build:ssr</code> 构建项目，你会发现在 <code>dist/&lt;your project&gt;/browser</code> 下面只有 index.html 文件，打开文件查看，发现其中还有 <code>&lt;app-root&gt;&lt;/app-root&gt;</code> 这样的元素，也就是说你的网页内容并没有在 html 中生成。这是因为 Angular 使用了动态路由，比如 /product/:id 这种路由，而页面的渲染结果要经过 JS 的执行才能知道，因此，Angular 使用了 Express 作为 Web 服务器，能在服务端运行时根据用户请求（爬虫请求）使用模板引擎生成静态 HTML 界面。</p><p>而 prerender（npm run prerender）会在构建时生成静态 HTML 文件。比如我们做企业官网，只有几个页面，那么我们可以使用预渲染技术生成这几个页面的静态 HTML 文件，避免在运行时动态生成，从而进一步提升网页的访问速度和用户体验。</p><h3 id="8-1-预渲染路径配置"><a href="#8-1-预渲染路径配置" class="headerlink" title="8.1. 预渲染路径配置"></a>8.1. 预渲染路径配置</h3><p>需要进行预渲染（预编译 HTML）的网页路径，可以有几种方式进行提供：</p><ol><li>通过命令行的附加参数:</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ng run &lt;app-name&gt;:prerender --routes /product/1 /product/2</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>这里有个需要注意的地方, 即使我只指定了两个路径, Angular universal 还是会使用 guess-parser 解析 routes 猜测可能的路径帮助渲染一堆路径, 实际上这种猜测有些鸡肋, 根本不会准确, 没有太大帮助. 此时可以使用 –no-guess-routes 选项将其关闭.</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ng run &lt;app-name&gt;:prerender --no-guess-routes --routes /product/1 /product/2</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>或者修改 angular.json, 将 guessRoutes 设置为 false</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;prerender&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;builder&quot;</span>: <span class="string">&quot;@nguniversal/builders:prerender&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;routes&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;/product/1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;/product/2&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;guessRoutes&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ol><li>如果路径比较多，比如针对 product/:id 这种动态路径，则可以使用一个路径文件：</li></ol><p>routes.txt</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/products/1</span><br><span class="line">/products/23</span><br><span class="line">/products/145</span><br><span class="line">/products/555</span><br></pre></td></tr></table></figure><p>然后在命令行参数指定该文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ng run &lt;app-name&gt;:prerender --routes-file routes.txt</span><br></pre></td></tr></table></figure><p>或者在 angular.json 中指定 routes-file</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">&quot;prerender&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;builder&quot;</span>: <span class="string">&quot;@nguniversal/builders:prerender&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;guessRoutes&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;routesFile&quot;</span>: <span class="string">&quot;routes-to-prerender.txt&quot;</span> <span class="comment">// 在这里指定routes-file</span></span><br><span class="line">          &#125;,</span><br></pre></td></tr></table></figure><ol start="3"><li>在项目的 angular.json 文件配置需要的路径</li></ol><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;prerender&quot;</span>: &#123;</span><br><span class="line">  <span class="attr">&quot;builder&quot;</span>: <span class="string">&quot;@nguniversal/builders:prerender&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;options&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;routes&quot;</span>: [ <span class="comment">// 这里配置</span></span><br><span class="line">      <span class="string">&quot;/&quot;</span>,</span><br><span class="line">      <span class="string">&quot;/main/home&quot;</span>,</span><br><span class="line">      <span class="string">&quot;/main/service&quot;</span>,</span><br><span class="line">      <span class="string">&quot;/main/team&quot;</span>,</span><br><span class="line">      <span class="string">&quot;/main/contact&quot;</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure><p>配置完成后，重新执行预渲染命令（npm run prerender 或者使用命令行参数则按照上面&lt;1&gt;&lt;2&gt;中的命令执行），编译完成后，再打开 <code>dist/&lt;your project&gt;/browser</code> 下的 index.html 会发现里面没有 <code>&lt;app-root&gt;&lt;/app-root&gt;</code> 了，取而代之的是主页的实际内容。同时也生成了相应的路径目录以及各个目录下的 index.html 子页面文件。</p><h2 id="9-SEO-优化"><a href="#9-SEO-优化" class="headerlink" title="9. SEO 优化"></a>9. SEO 优化</h2><h3 id="9-1-关键词与描述的优化"><a href="#9-1-关键词与描述的优化" class="headerlink" title="9.1. 关键词与描述的优化"></a>9.1. 关键词与描述的优化</h3><p>SEO 的关键在于对网页 title，keywords 和 description 的收录，因此对于我们想要让搜索引擎收录的网页，可以修改代码提供这些内容。</p><p>在 Angular 14 中，如果路由界面通过 Routes 配置，可以将网页的静态 title 直接写在路由的配置中：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; <span class="attr">path</span>: <span class="string">&#x27;home&#x27;</span>, <span class="attr">component</span>: AbmHomeComponent, <span class="attr">title</span>: <span class="string">&#x27;&lt;你想显示在浏览器 tab 上的标题&gt;&#x27;</span> &#125;,</span><br></pre></td></tr></table></figure><p>另外，Angular 也提供了可注入的 Title 和 Meta 用于修改网页的标题和 meta 信息：</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Meta, Title &#125; <span class="keyword">from</span> <span class="string">&quot;@angular/platform-browser&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleComponent</span> <span class="title">implements</span> <span class="title">OnInit</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">constructor</span>(<span class="params"><span class="keyword">private</span> _title: Title, <span class="keyword">private</span> _meta: Meta</span>)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">ngOnInit</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>._title.setTitle(<span class="string">&quot;&lt;此页的标题&gt;&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>._meta.addTags([</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">&quot;keywords&quot;</span>, <span class="attr">content</span>: <span class="string">&quot;&lt;此页的 keywords，以英文逗号隔开&gt;&quot;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">name</span>: <span class="string">&quot;description&quot;</span>, <span class="attr">content</span>: <span class="string">&quot;&lt;此页的描述&gt;&quot;</span> &#125;,</span><br><span class="line">    ]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-2-内部跳转优化"><a href="#9-2-内部跳转优化" class="headerlink" title="9.2. 内部跳转优化"></a>9.2. 内部跳转优化</h3><p>这个是指应用内部页面跳转尽量使用 a 标签，而不是使用别的标签加(click)事件进行跳转。</p><h3 id="9-3-样式文件打包"><a href="#9-3-样式文件打包" class="headerlink" title="9.3. 样式文件打包"></a>9.3. 样式文件打包</h3><p>另外一个需要注意的地方是，如果网站的样式很多很复杂，那么网站发布的时候 angular.json 中 extractCss 需要设置为 true,即单独打包一个独立的样式文件，而不是将样式全部包含在发布后的 index.html 中。</p><p>全部包含在 index.html 中会造成抓取保存的静态 html 文件过大，百度不能正确保存快照（百度限制了缓存文件大小，好像是 100k）。</p><h3 id="9-4-添加-robots-txt"><a href="#9-4-添加-robots-txt" class="headerlink" title="9.4. 添加 robots.txt"></a>9.4. 添加 robots.txt</h3><p>在网站优化过程中，有些时候，网站中有重要及私密的内容，站长并不希望某些页面被蜘蛛抓取，比如后台的数据，测试阶段的网站，还有一种很常见的情况，搜索引擎抓取的大量没有意义的页面。</p><p>robots.txt 是一个纯文本文件，用于声明该网站中不想被蜘蛛访问的部分，或指定蜘蛛抓取的部分，当蜘蛛访问一个站点时，它会首先检查该站点是否存在，robots.txt，如果找到，蜘蛛就会按照该文件中的内容来确定抓取的范围，如果该文件不存在，那么蜘蛛就会沿着链接直接抓取。即，只有在需要禁止抓取某些内容是，写 robots.txt 才有意义.</p><p>robots 配置方法如下：</p><ul><li>在 project_root/src 路径下创建 robots.txt 文件，里面输入你的 robots 配置，如果不懂，可以百度 robots 的语法，修改后保存即可提交。</li></ul><p>下面是一个简单的 robots.txt 的例子</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User-agent: *</span><br><span class="line">Disallow:</span><br><span class="line">Sitemap: http://your_domain/sitemap.xml</span><br></pre></td></tr></table></figure><p>还需要修改 angular.json 文件, 这样 robots.txt 文件才能被访问到</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;build&quot;</span>: &#123;</span><br><span class="line">   ......</span><br><span class="line">   <span class="attr">&quot;assets&quot;</span>: [</span><br><span class="line">     <span class="string">&quot;src/favicon.ico&quot;</span>,</span><br><span class="line">     <span class="string">&quot;src/robots.txt&quot;</span>,</span><br><span class="line">     <span class="string">&quot;src/sitemap.xml&quot;</span>,</span><br><span class="line">     <span class="string">&quot;src/assets&quot;</span></span><br><span class="line">   ],</span><br></pre></td></tr></table></figure><h3 id="9-5-自动生成-sitemap"><a href="#9-5-自动生成-sitemap" class="headerlink" title="9.5. 自动生成 sitemap"></a>9.5. 自动生成 sitemap</h3><p>安装工具 ngx-sitemap</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install ngx-sitemap --save-dev</span><br></pre></td></tr></table></figure><p>在 prerendering 后运行以下命令, 就可以生成 sitemap.xml</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$./node_modules/.bin/ngx-sitemap ./dist/angular-universal-demo/browser htts://your_domain</span><br><span class="line">sitemap.xml successfully created <span class="keyword">in</span> <span class="string">&#x27;./dist/angular-universal-demo/browser/&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="10-使用-Nginx-部署"><a href="#10-使用-Nginx-部署" class="headerlink" title="10. 使用 Nginx 部署"></a>10. 使用 Nginx 部署</h2><p>整个 topo 结构是这样的, 首先要使用 pm2 将服务器端渲染程序运行起来, 然后通过 Nginx 将请求反向代理到 pm2.</p><p>这样 PM2 就会实际处理所有请求, 对于已经 prerender 过的页面 PM2 会直接去 browser 文件夹中去取, 对于没有 prerender 的页面, 首先会在服务器端渲染然后传送到浏览器端.<br>页面到达流量器端后, 首先页面有一个基本的静态呈现, 与此同时会继续向后端请求 javascript, 直到 javascript 下载完成后, 将会进行 CSR(客户端渲染), 如果没有使用到 hydration 技术, 此时页面会有一个比较明显的闪烁, 如果使用了 hydration 技术此时会 CSR 渲染会比较平滑地替代 SSR 渲染的页面, 除了页面被重新渲染以外, 前端路由也会被 javascript 接管. 此时如果用户不刷新页面, 整个应用就运行在 SPA 模式下了.</p><p>对于搜索引擎爬虫, 由于它只读取页面文本内容, 不会去执行 javascript 代码, 所以相对于浏览器访问, 爬虫只是爬取那一页的内容, 不会有 javascript 下载过程, 更不会有 CSR, 以及 hydration 的过程.</p><p>整个部署过程是这样的, 首先安装 Nginx, node 以及 PM2. 然后启动 PM2, Nginx 反向代理到 PM2.</p><h3 id="10-1-安装-Nginx"><a href="#10-1-安装-Nginx" class="headerlink" title="10.1. 安装 Nginx"></a>10.1. 安装 Nginx</h3><p>参考我的博客 <a href="https://www.pengtech.net/nginx/nginx_installation.html">鹏叔的技术博客-nginx 安装教程</a></p><h3 id="10-2-安装-Node"><a href="#10-2-安装-Node" class="headerlink" title="10.2. 安装 Node"></a>10.2. 安装 Node</h3><p>安装 Nodejs 可以参考博客 <a href="https://www.pengtech.net/nodejs/install_and_config_nodejs.html">安装并配置 nodejs | 鹏叔的技术博客</a></p><h3 id="10-3-安装-PM2"><a href="#10-3-安装-PM2" class="headerlink" title="10.3. 安装 PM2"></a>10.3. 安装 PM2</h3><p>安装 pm2 来支持 SSR</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装pm2</span></span><br><span class="line">npm install -g pm2</span><br><span class="line"><span class="comment"># 查看pm2版本</span></span><br><span class="line">pm2 --v</span><br><span class="line"><span class="comment"># 5.3.0</span></span><br></pre></td></tr></table></figure><h3 id="10-4-配置并启动-pm2"><a href="#10-4-配置并启动-pm2" class="headerlink" title="10.4. 配置并启动 pm2"></a>10.4. 配置并启动 pm2</h3><p>为了能在任意位置都能执行 pm2, 我们将 pm2 添加到 PATH 下, 添加的方法是在/usr/bin 下创建一个软连接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/node-v14.17.5-linux-x64/lib/node_modules/pm2/bin/pm2 /usr/bin/pm2</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们顺便查看一下 pm2 的版本并确保软连接创建有效</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pm2 --version</span><br><span class="line">[PM2] Spawning PM2 daemon with pm2_home=/root/.pm2</span><br><span class="line">[PM2] PM2 Successfully daemonized</span><br><span class="line">5.3.0</span><br></pre></td></tr></table></figure><p>接下来, 我们就可以使用 PM2 启动服务器端渲染了,<br>这里我们假设已经将程序部署到了服务器的/var/your_app/webapp 目录, 结构如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tree -L 1 /var/your_app/webapp</span><br><span class="line">/var/your_app/webapp</span><br><span class="line">├── browser</span><br><span class="line">└── server</span><br></pre></td></tr></table></figure><p>启动 SSR</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">pm2 start --name app_ssr /var/your_app/webapp/server/main.js</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>注意: 使用 angular cli 默认生成的 distFolder 部署到服务器, 会出现 index 文件找不到.<br>这里可以修改以下让其相对于 main.js 查找 index 而不是 process.cwd()</p></blockquote><p>vi server.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> parentFolder: <span class="built_in">string</span> = join(__dirname, <span class="string">&quot;../&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> distFolder: <span class="built_in">string</span> = join(parentFolder, <span class="string">&quot;browser&quot;</span>);</span><br></pre></td></tr></table></figure><p>设置开机自启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 保存要在机器重新启动时重新生成的列表</span></span><br><span class="line">pm2 save</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成开机自启动服务</span></span><br><span class="line">pm2 startup</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable pm2开机自启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> pm2-root</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>另外一些有用的 pm2 命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看进程</span></span><br><span class="line">pm2 list</span><br><span class="line"><span class="comment"># 关闭prcess</span></span><br><span class="line">pm2 stop process_name</span><br><span class="line"><span class="comment"># 删除进程</span></span><br><span class="line">pm2 delete process_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看process 详情</span></span><br><span class="line">pm2 show process_name</span><br></pre></td></tr></table></figure><p>至此 PM2 配置完成, ssr 默认会监听在 4000 端口, 可以通过如下命令查找端口号</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep <span class="string">&quot;process.env\[\&quot;PORT\&quot;\]&quot;</span> /var/your_app/webapp/server/main.js</span><br></pre></td></tr></table></figure><p>其他一些有用的 pm2 命令</p><p>查看日志某个任务的日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">pm2 <span class="built_in">log</span> the_process_name</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="10-5-配置-Nginx-反向代理"><a href="#10-5-配置-Nginx-反向代理" class="headerlink" title="10.5. 配置 Nginx 反向代理"></a>10.5. 配置 Nginx 反向代理</h3><p>修改/etc/nginx/conf.d/defaut.conf 将之前的配置由如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">        root   /var/your_app/webapp/;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">        try_files $uri $uri/ /index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>改成</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">       proxy_set_header Host $host;</span><br><span class="line">       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">       proxy_pass http://127.0.0.1:4000/;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="11-troubleshooting"><a href="#11-troubleshooting" class="headerlink" title="11. troubleshooting"></a>11. troubleshooting</h2><h3 id="11-1-问题-1-Configuration-‘development’-is-not-set-in-the-workspace"><a href="#11-1-问题-1-Configuration-‘development’-is-not-set-in-the-workspace" class="headerlink" title="11.1. 问题 1: Configuration ‘development’ is not set in the workspace"></a>11.1. 问题 1: Configuration ‘development’ is not set in the workspace</h3><p>描述: 当执行<code>npm run dev:ssr</code> 系统抛出如下错误 Configuration ‘development’ is not set in the workspace.</p><p>原因: 原因实际上是一个 bug, Angular 开发人员未考虑到, 我们的配置于他们期望的有差异.<br>详细原因和解决方案请参考<a target="_blank" rel="noopener" href="https://github.com/angular/angular-cli/issues/18428">this issue</a><br>也请注意, 我贴出来的<code>ng add @nguniversal/express-engine</code>自动配置的 angular.json 的 serve-ssr 部分是有修改过的, 目的就是为了解决这个问题.</p><h3 id="11-2-问题-2-ReferenceError-window-is-not-defined"><a href="#11-2-问题-2-ReferenceError-window-is-not-defined" class="headerlink" title="11.2. 问题 2: ReferenceError: window is not defined"></a>11.2. 问题 2: ReferenceError: window is not defined</h3><p>描述: 当执行’npm run dev:ssr’ 系统抛出如下错误 ReferenceError: window is not defined</p><p>原因: 问题的原因是在 Nodejs 运行时, 没有 window, document, navigator 等等浏览器端对象.</p><p>可以参考我的博客<a href="https://www.pengtech.net/angular/consideration_on_angular_universal.html">使用 Angular Universal 时的重要注意事项</a>,<br>里面提到了三种解决该问题的策略, 这里我选择了 策略 3：Shims, 相应的修改如下:</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">import &#x27;zone.js/dist/zone-node&#x27;;</span><br><span class="line"> import &#123; join &#125; from &#x27;path&#x27;;</span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="addition">+import &quot;localstorage-polyfill&quot;;</span></span><br><span class="line"> import &#123; AppServerModule &#125; from &#x27;./src/main.server&#x27;;</span><br><span class="line"> import &#123; APP_BASE_HREF &#125; from &#x27;@angular/common&#x27;;</span><br><span class="line"><span class="deletion">-import &#123; existsSync &#125; from &#x27;fs&#x27;;</span></span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="addition">+import &#123; existsSync,readFileSync &#125; from &#x27;fs&#x27;;</span></span><br><span class="line"><span class="addition">+import &#123; createWindow &#125; from &quot;domino&quot;;</span></span><br><span class="line"> // The Express app is exported so that it can be used by serverless Functions.</span><br><span class="line"> export function app(): express.Express &#123;</span><br><span class="line">   const server = express();</span><br><span class="line">   const distFolder = join(process.cwd(), &#x27;dist/angular-universal-demo/browser&#x27;);</span><br><span class="line">   const indexHtml = existsSync(join(distFolder, &#x27;index.original.html&#x27;)) ? &#x27;index.original.html&#x27; : &#x27;index&#x27;;</span><br><span class="line"></span><br><span class="line"><span class="addition">+  applyDomino(indexHtml)</span></span><br><span class="line">   // Our Universal express-engine (found @ https://github.com/angular/universal/tree/master/modules/express-engine)</span><br><span class="line">   server.engine(&#x27;html&#x27;, ngExpressEngine(&#123;</span><br><span class="line">     bootstrap: AppServerModule,</span><br><span class="line">   &#125;));</span><br><span class="line"></span><br><span class="line"><span class="meta">@@ -35,26 +36,41 @@</span> export function app(): express.Express &#123;</span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">   return server;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="addition">+function applyDomino(indexHtml: string): void &#123;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  const win = createWindow(indexHtml)</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  console.log(&quot;applying mock window &quot;)</span></span><br><span class="line"><span class="addition">+  global[&quot;localStorage&quot;] = localStorage;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+  // Polyfills</span></span><br><span class="line"><span class="addition">+  (global as any).window = win;</span></span><br><span class="line"><span class="addition">+  (global as any).document = win.document;</span></span><br><span class="line"><span class="addition">+  (global as any).navigator = win.navigator;</span></span><br><span class="line"><span class="addition">+  (global as any).location = win.location;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"><span class="addition">+&#125;</span></span><br><span class="line"><span class="addition">+</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="11-3-问题-3-Flex-Layout-loaded-on-the-server-without-FlexLayoutServerModule"><a href="#11-3-问题-3-Flex-Layout-loaded-on-the-server-without-FlexLayoutServerModule" class="headerlink" title="11.3. 问题 3: Flex Layout loaded on the server without FlexLayoutServerModule"></a>11.3. 问题 3: Flex Layout loaded on the server without FlexLayoutServerModule</h3><p>描述: 当执行<code>npm run dev:ssr</code> 或者 <code>npm run prerender</code>时, 频繁的输出警告 Warning: Flex Layout loaded on the server without FlexLayoutServerModule</p><p>原因分析: FlexLayout 需要在 js 运行时确定屏幕大小等等信息, 在 server side 由于没有 screen 的概念所以需要模拟浏览器端的行为, FlexLayout 专门为 ssr 提供了一套 Module 来模拟浏览器端的行为, 所以最好在服务器端程序引入 FlexLayoutServerModule, 也即在 app.server.module.ts 中引入 FlexLayoutServerModule</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//app.server.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123;NgModule&#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;FlexLayoutServerModule&#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/flex-layout/server&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">    ... other imports here</span><br><span class="line">    FlexLayoutServerModule,</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>以及定义在 SSR 配置渲染时模拟的屏幕大小, 修改 app.module.ts</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//app.module.ts to simulate breakpoints</span></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">imports</span>: [</span><br><span class="line">  ... other imports here</span><br><span class="line">  FlexLayoutModule.withConfig(&#123;<span class="attr">ssrObserveBreakpoints</span>: [<span class="string">&#x27;xs&#x27;</span>, <span class="string">&#x27;lt-md&#x27;</span>]&#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="11-4-问题-4-XMLHttpRequest-is-not-defined"><a href="#11-4-问题-4-XMLHttpRequest-is-not-defined" class="headerlink" title="11.4. 问题 4: XMLHttpRequest is not defined"></a>11.4. 问题 4: XMLHttpRequest is not defined</h3><p>描述: 当执行<code>npm run dev:ssr</code> 或者 <code>npm run prerender</code>时, 系统抛出如下错误 ReferenceError: XMLHttpRequest is not defined</p><p>原因分析: 原因是我的代码中调用了 ajax 这个 rxjs operator <code>import &#123; ajax, AjaxResponse &#125; from &#39;rxjs/ajax&#39;;</code>其底层实现需要 XMLHttpRequest,<br>而在 Sever side javascript 环境中没有引入 xmlhttprequest 这个包.</p><p>解决办法: 解决办法可以有多种, 我选择了将 ajax 这个 rxjs operator 全部替换成了 HttpClient call, 例如</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">concatMap(<span class="function">(<span class="params">remoteServerUri: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> headers = <span class="keyword">new</span> HttpHeaders(&#123;</span><br><span class="line">          <span class="attr">Authorization</span>: <span class="string">&quot;Basic &quot;</span> + idToken,</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.httpClient.get&lt;<span class="built_in">any</span>&gt;(remoteServerUri + url, &#123; <span class="attr">headers</span>: headers &#125;);</span><br><span class="line">      &#125;),</span><br></pre></td></tr></table></figure><p>参考文章 <a target="_blank" rel="noopener" href="https://github.com/angular/universal/issues/1835">How to resolve window is not defined on npm run serve:ssr</a></p><h3 id="11-5-问题-5：-dist-demo-web-browser-ReferenceError-Image-is-not-defined"><a href="#11-5-问题-5：-dist-demo-web-browser-ReferenceError-Image-is-not-defined" class="headerlink" title="11.5. 问题 5： \dist\demo-web\browser...ReferenceError: Image is not defined"></a>11.5. 问题 5： <code>\dist\demo-web\browser...ReferenceError: Image is not defined</code></h3><p>问题分析：</p><p>当页面使用 const bookImage = new Image(); 的时候， 在 server side rendering 时报如题错误。问题的原因是由于代码运行在 nodejs 运行时环境，而不是浏览器环境。正如我的博客<a href="https://www.pengtech.net/angular/consideration_on_angular_universal.html">使用 Angular Universal 时的重要注意事项</a>中所提到的，服务器上不存在或不支持某些功能 Canvas，image 等对象.</p><p>三次尝试：第三次成功</p><ol><li>即使我尝试使用<code>const bookImage = this.document.createElement(&#39;img&#39;);</code> 尝试使用 domino 的 document 对象的实现方式， 仍然遇到<code>dist\demo-web\browser...Error: NotYetImplemented</code>的错误。虽然这是由于 domino 仍然没有实现创建 image 对象的方法。</li></ol><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="title">constructor</span>(<span class="params"><span class="meta">@Inject</span>(DOCUMENT) <span class="keyword">private</span> <span class="built_in">document</span>: Document</span>)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">ngAfterViewInit</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> bookImage = <span class="built_in">this</span>.document.createElement(<span class="string">&#x27;img&#x27;</span>);</span><br><span class="line">    bookImage.src = <span class="string">&#x27;assets/img/wb/cover_template.png&#x27;</span></span><br><span class="line">    <span class="built_in">this</span>.ctx = <span class="built_in">this</span>.wbCoverCanvas?.nativeElement.getContext(<span class="string">&#x27;2d&#x27;</span>)</span><br><span class="line">    bookImage.onload = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.drawCover(bookImage)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="2"><li>后来尝试使用 canvas nodejs 包<code>npm install canvas</code>， 依然出现错误。参考问题<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/56306205/referenceerror-image-is-not-defined">ReferenceError: Image is not defined</a>，<a target="_blank" rel="noopener" href="https://github.com/Automattic/node-canvas">node-canvas</a>，仍然报错<code>node_modules/canvas/types/index.d.ts:3:26 - error TS2307: Cannot find module &#39;stream&#39; or its corresponding type declarations.</code></li></ol><p>尝试解决以上错误，还是遇到很多问题。</p><ol><li><p>最终还是回到 <a href="https://www.pengtech.net/angular/consideration_on_angular_universal.html">使用 Angular Universal 时的重要注意事项</a>中所提到的办法 - 策略 2：Guard</p><p>将 drawCover 抽取到一个 service 中， 当运行 server 端代码时， 专门针对 server side 注入不同的 canvas service， 跳过 canvas 创建，这样并不会影响用户体验， 当客户端水合过程中毕竟会重绘 canvas.</p></li></ol><h2 id="12-相关阅读"><a href="#12-相关阅读" class="headerlink" title="12. 相关阅读"></a>12. 相关阅读</h2><p>本技术博客原创文章位于<a href="https://www.pengtech.net/angular/angular_universal">Angular universal 服务器端渲染与预渲染 | 鹏叔的技术博客</a>, 要获取最近更新请访问原文.</p><p>更多 Angular 相关文章请访问<a href="https://www.pengtech.net/angular/">Angular 合集 | 鹏叔的技术博客</a></p><p>更多技术博客请访问: <a href="https://www.pengtech.net/archives/">鹏叔的技术博客</a></p><h2 id="13-参考文档"><a href="#13-参考文档" class="headerlink" title="13. 参考文档"></a>13. 参考文档</h2><p><a target="_blank" rel="noopener" href="https://angular.io/guide/universal">Server-side rendering (SSR) with Angular Universal</a></p><p><a target="_blank" rel="noopener" href="https://github.com/angular/universal/blob/master/docs/gotchas.md">Important Considerations when Using Angular Universal</a></p><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000041753539">2022 前端性能优化最佳实践</a></p><p><a href="https://www.pengtech.net/angular/consideration_on_angular_universal.html">使用 Angular Universal 时的重要注意事项</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/RJ0024/article/details/110490912">Angular 服务器渲染常遇的坑</a></p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jmix/p/angular_ssr_seo.html">Angular SSR 探究</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_38391672/article/details/98471035">Angular 7 SSR 之后使用 node + nginx 部署在 linux</a></p><p><a target="_blank" rel="noopener" href="https://github.com/angular/angular/issues/21471">Better Approach for Styles for SSR (Angular Universal)</a></p><p><a target="_blank" rel="noopener" href="https://github.com/angular/angular/issues/14914">Feature Request: ability to produce and load CSS via link tag in index.html</a></p><p><a target="_blank" rel="noopener" href="https://github.com/brandonroberts/angular-v16-universal-standalone">angular-v16-universal-standalone</a></p></div><footer class="post-footer"><div class="reward-container"><div>您的支持是我创作深度好文的源动力!</div><button>赞赏</button><div class="post-reward"><div><img src="/imgs/rewards/wechatpay.jpg" alt="鹏叔 微信"> <span>微信</span></div><div><img src="/imgs/rewards/alipay.jpg" alt="鹏叔 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"><strong>本文作者： </strong>鹏叔</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://www.pengtech.net/angular/angular_universal.html" title="Angular universal服务器端渲染与预渲染">https://www.pengtech.net/angular/angular_universal.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="post-tags"><a href="/tags/Angular/" rel="tag"><i class="fa fa-tag"></i> Angular</a> <a href="/tags/javascript/" rel="tag"><i class="fa fa-tag"></i> javascript</a> <a href="/tags/SEO/" rel="tag"><i class="fa fa-tag"></i> SEO</a></div><div class="post-nav"><div class="post-nav-item"><a href="/network/frp_install.html" rel="prev" title="frp内网穿透"><i class="fa fa-chevron-left"></i> frp内网穿透</a></div><div class="post-nav-item"><a href="/angular/consideration_on_angular_universal.html" rel="next" title="使用Angular Universal时的重要注意事项">使用Angular Universal时的重要注意事项 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments utterances-container"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">鹏叔</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span>站点总字数：</span> <span title="站点总字数">1.3m</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">19:54</span></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener external nofollow" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener external nofollow" target="_blank">NexT.Mist</a> 强力驱动</div><div class="addthis_inline_share_toolbox"><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-615fe625918d4f20" async></script></div></div></footer><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.13.2/dist/mermaid.min.js","integrity":"sha256-UIQPVkGifpwMvDH5yGgORJ9sSTDq38zz6BGU6dNaKhM="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"guoapeng/guoapeng.github.io","issue_term":"pathname","theme":"github-light","cdn":"https://utteranc.es/client.js"}</script><script src="/js/third-party/comments/utterances.js"></script></body></html>