<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="hwu96hHsSnPefhY5oj_Q2reBfC1YuVkwbsuPeuAjSls"><meta name="baidu-site-verification" content="codeva-1TKHma47RE"><script>!function(t,e,n,c,r,a){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(r=e.createElement(c)).async=1,r.src="https://www.clarity.ms/tag/cnl2uzz0vb?ref=bwt",(a=e.getElementsByTagName(c)[0]).parentNode.insertBefore(r,a)}(window,document,"clarity","script")</script><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic%7CPingFang+SC:300,300italic,400,400italic,700,700italic%7CMicrosoft+YaHei:300,300italic,400,400italic,700,700italic%7Csans-serif:300,300italic,400,400italic,700,700italic%7CLato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"www.pengtech.net","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":"enable","bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><meta name="description" content="1. 前言本文主要讲述配置一个最简单的 k8s 集群, 本集群由 1 个 master(master01) 和 2 个 node 节点（node01, node02）组成. 当前(2021&#x2F;02&#x2F;15) kubernetes 的最新稳定版本为 v1.20.2. 但是我依然采用的是较老的版本 v1.13.2, 因为众多参考文档使用的是这个版本，目前不清楚各组件之间的版本兼容性问题，所以依然采用这个版"><meta property="og:type" content="article"><meta property="og:title" content="创建kubernetes集群"><meta property="og:url" content="https://www.pengtech.net/k8s/setup_k8s_cluster.html"><meta property="og:site_name" content="鹏叔的技术博客"><meta property="og:description" content="1. 前言本文主要讲述配置一个最简单的 k8s 集群, 本集群由 1 个 master(master01) 和 2 个 node 节点（node01, node02）组成. 当前(2021&#x2F;02&#x2F;15) kubernetes 的最新稳定版本为 v1.20.2. 但是我依然采用的是较老的版本 v1.13.2, 因为众多参考文档使用的是这个版本，目前不清楚各组件之间的版本兼容性问题，所以依然采用这个版"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2021-10-08T16:00:00.000Z"><meta property="article:modified_time" content="2024-05-30T05:43:45.276Z"><meta property="article:author" content="鹏叔"><meta property="article:tag" content="k8s"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.pengtech.net/k8s/setup_k8s_cluster.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.pengtech.net/k8s/setup_k8s_cluster.html","path":"k8s/setup_k8s_cluster.html","title":"创建kubernetes集群"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>创建kubernetes集群 | 鹏叔的技术博客</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZZTM0Y954E"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-ZZTM0Y954E","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?1da0f55a32eb17a877b1b18efa3d0406"></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i> <span class="site-title h1">鹏叔的技术博客</span> <i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">日拱一卒，功不唐捐!</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-angular"><a href="/angular/" rel="section"><i class="fa fa-th fa-fw"></i>angular</a></li><li class="menu-item menu-item-material-design"><a href="/material-design/" rel="section"><i class="fa fa-th fa-fw"></i>material-design</a></li><li class="menu-item menu-item-linux"><a href="/linux/" rel="section"><i class="fa fa-cube fa-fw"></i>linux</a></li><li class="menu-item menu-item-gitlab"><a href="/gitlab/" rel="section"><i class="fa fa-th fa-fw"></i>gitlab</a></li><li class="menu-item menu-item-frontend"><a href="/frontend/" rel="section"><i class="fa fa-mobile fa-fw"></i>frontend</a></li><li class="menu-item menu-item-backend"><a href="/backend/" rel="section"><i class="fa fa-mobile fa-fw"></i>backend</a></li><li class="menu-item menu-item-vscode"><a href="/vscode/" rel="section"><i class="fa fa-th fa-fw"></i>vscode</a></li><li class="menu-item menu-item-hexo"><a href="/hexo/" rel="section"><i class="fa fa-sitemap fa-fw"></i>hexo</a></li><li class="menu-item menu-item-java"><a href="/java/" rel="section"><i class="fa fa-coffee fa-fw"></i>java</a></li><li class="menu-item menu-item-golang"><a href="/golang/" rel="section"><i class="fa fa-cloud fa-fw"></i>golang</a></li><li class="menu-item menu-item-v2raya"><a href="/v2rayA/" rel="section"><i class="fa fa-cloud fa-fw"></i>v2rayA</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">1. 前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E9%83%A8%E7%BD%B2%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.</span> <span class="nav-text">2. 部署工具介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E7%8E%AF%E5%A2%83%E8%A6%81%E6%B1%82"><span class="nav-number">2.1.</span> <span class="nav-text">2.1. 环境要求</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-1-%E8%AE%BE%E7%BD%AE%E5%90%84%E4%B8%BB%E6%9C%BA-ip"><span class="nav-number">2.1.1.</span> <span class="nav-text">2.1.1. 设置各主机 ip</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-2-%E8%AE%BE%E7%BD%AE%E6%97%B6%E9%92%9F%E5%90%8C%E6%AD%A5"><span class="nav-number">2.1.2.</span> <span class="nav-text">2.1.2. 设置时钟同步</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-3-%E4%B8%BB%E6%9C%BA%E5%90%8D%E7%A7%B0%E8%A7%A3%E6%9E%90"><span class="nav-number">2.1.3.</span> <span class="nav-text">2.1.3. 主机名称解析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-4-%E5%85%B3%E9%97%AD-iptables-%E6%88%96-firewalld-%E6%9C%8D%E5%8A%A1"><span class="nav-number">2.1.4.</span> <span class="nav-text">2.1.4. 关闭 iptables 或 firewalld 服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-5-%E5%85%B3%E9%97%AD%E5%B9%B6%E7%A6%81%E7%94%A8-SELinux"><span class="nav-number">2.1.5.</span> <span class="nav-text">2.1.5. 关闭并禁用 SELinux</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-6-%E7%A6%81%E7%94%A8-Swap-%E8%AE%BE%E5%A4%87"><span class="nav-number">2.1.6.</span> <span class="nav-text">2.1.6. 禁用 Swap 设备</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-7-%E5%90%AF%E7%94%A8-ipvs-%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97"><span class="nav-number">2.1.7.</span> <span class="nav-text">2.1.7. 启用 ipvs 内核模块</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%AE%89%E8%A3%85%E7%A8%8B%E5%BA%8F%E5%8C%85-%E5%9C%A8%E5%90%84%E4%B8%BB%E6%9C%BA%E4%B8%8A%E5%AE%8C%E6%88%90%E5%A6%82%E4%B8%8B%E8%AE%BE%E5%AE%9A"><span class="nav-number">3.</span> <span class="nav-text">3. 安装程序包(在各主机上完成如下设定)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E5%AE%89%E8%A3%85-docker-master01-node01-amp-node02"><span class="nav-number">3.1.</span> <span class="nav-text">3.1. 安装 docker (master01, node01 &amp; node02)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-%E9%85%8D%E7%BD%AE-docker-ce-yum-%E6%BA%90"><span class="nav-number">3.1.1.</span> <span class="nav-text">3.1.1. 配置 docker-ce yum 源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2-%E9%85%8D%E7%BD%AE-docker"><span class="nav-number">3.1.2.</span> <span class="nav-text">3.1.2. 配置 docker</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-1-2-1-%E9%85%8D%E7%BD%AE%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">3.1.2.1. 配置镜像加速</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-1-2-2-docker-iptables-FORWARD-%E7%AD%96%E7%95%A5"><span class="nav-number">3.1.2.2.</span> <span class="nav-text">3.1.2.2. docker iptables FORWARD 策略</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E5%AE%89%E8%A3%85-kubelet-master01"><span class="nav-number">3.2.</span> <span class="nav-text">3.2. 安装  kubelet (master01)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-%E9%85%8D%E7%BD%AE-kubernetes-yum-%E6%BA%90"><span class="nav-number">3.2.1.</span> <span class="nav-text">3.2.1. 配置 kubernetes yum 源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-%E5%AE%89%E8%A3%85-kubelet"><span class="nav-number">3.2.2.</span> <span class="nav-text">3.2.2. 安装 kubelet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-3-%E9%85%8D%E7%BD%AE-kubelet"><span class="nav-number">3.2.3.</span> <span class="nav-text">3.2.3. 配置 kubelet</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E9%85%8D%E7%BD%AE-Master-%E5%92%8C-Nodes"><span class="nav-number">4.</span> <span class="nav-text">4. 配置 Master 和 Nodes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85"><span class="nav-number">4.1.</span> <span class="nav-text">4.1. 插件安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E9%85%8D%E7%BD%AE-master-%E8%8A%82%E7%82%B9"><span class="nav-number">4.2.</span> <span class="nav-text">4.2. 配置 master 节点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-1-%E6%8B%89%E5%8F%96%E5%BF%85%E8%A6%81%E7%9A%84%E9%95%9C%E5%83%8F"><span class="nav-number">4.2.1.</span> <span class="nav-text">4.2.1. 拉取必要的镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-2-%E5%88%9D%E5%A7%8B%E5%8C%96-master"><span class="nav-number">4.2.2.</span> <span class="nav-text">4.2.2. 初始化 master</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-2-2-1-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%B9%E5%BC%8F%E4%B8%80"><span class="nav-number">4.2.2.1.</span> <span class="nav-text">4.2.2.1. 初始化方式一</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-2-2-2-%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%B9%E5%BC%8F%E4%BA%8C"><span class="nav-number">4.2.2.2.</span> <span class="nav-text">4.2.2.2. 初始化方式二</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-%E9%85%8D%E7%BD%AE%E7%AC%AC%E4%B8%80%E4%B8%AA-node-%E8%8A%82%E7%82%B9-%E5%B9%B6%E6%B7%BB%E5%8A%A0%E5%88%B0%E9%9B%86%E7%BE%A4"><span class="nav-number">4.3.</span> <span class="nav-text">4.3. 配置第一个 node 节点, 并添加到集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-%E9%85%8D%E7%BD%AE%E7%AC%AC%E4%BA%8C%E4%B8%AA-node-%E8%8A%82%E7%82%B9-%E5%B9%B6%E6%B7%BB%E5%8A%A0%E5%88%B0%E9%9B%86%E7%BE%A4"><span class="nav-number">4.4.</span> <span class="nav-text">4.4. 配置第二个 node 节点, 并添加到集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5-troubleshooting"><span class="nav-number">5.</span> <span class="nav-text">5. 问题排查 troubleshooting</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E5%90%8E%E8%AE%B0"><span class="nav-number">6.</span> <span class="nav-text">6. 后记</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="nav-number">7.</span> <span class="nav-text">7. 参考文档</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="鹏叔" src="/imgs/avatar.gif"><p class="site-author-name" itemprop="name">鹏叔</p><div class="site-description" itemprop="description">鹏叔的技术博客, 鹏叔的技术博客, 收集鹏叔在日常工作中整理的技术博客, 内容包括前端javascript, material design, typescript, css, html, 后端golang, java, 数据库等.</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">250</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">35</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">76</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/guoapeng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;guoapeng" rel="noopener external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:guoapeng@gmail.com" title="E-Mail → mailto:guoapeng@gmail.com" rel="noopener external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a></span></div><div class="cc-license site-overview-item animated" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener external nofollow" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll site-overview-item animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://philoenglish.com/" title="https:&#x2F;&#x2F;philoenglish.com" target="_blank">菲利英语</a></li></ul></div></div></div><div class="back-to-top animated" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div class="sidebar-dimmer"></div></header><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.pengtech.net/k8s/setup_k8s_cluster.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/imgs/avatar.gif"><meta itemprop="name" content="鹏叔"><meta itemprop="description" content="鹏叔的技术博客, 鹏叔的技术博客, 收集鹏叔在日常工作中整理的技术博客, 内容包括前端javascript, material design, typescript, css, html, 后端golang, java, 数据库等."></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="鹏叔的技术博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">创建kubernetes集群</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-10-09 00:00:00" itemprop="dateCreated datePublished" datetime="2021-10-09T00:00:00+08:00">2021-10-09</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-05-30 13:43:45" itemprop="dateModified" datetime="2024-05-30T13:43:45+08:00">2024-05-30</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/cloud/" itemprop="url" rel="index"><span itemprop="name">cloud</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/cloud/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span></a> </span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span id="busuanzi_value_page_pv"></span> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>18k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>16 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>本文主要讲述配置一个最简单的 k8s 集群, 本集群由 1 个 master(master01) 和 2 个 node 节点（node01, node02）组成. 当前(2021/02/15) kubernetes 的最新稳定版本为 v1.20.2. 但是我依然采用的是较老的版本 v1.13.2, 因为众多参考文档使用的是这个版本，目前不清楚各组件之间的版本兼容性问题，所以依然采用这个版本，后续经过多次重复安装，验证各版本的兼容性后再回头来更新版本信息。另外网上有很多的 k8s 实验平台, 只需轻松几个点击, 就可以搭建 k8s 集群, 如果只是学习目的, 可以跳过这唬人的安装过程, 直接进入概念学习阶段, 等对 k8s 玩得很溜了再回头来搭建环境. 欲练此功, 不安装 k8s 也可以. 这里推荐<a target="_blank" rel="noopener" href="https://labs.play-with-k8s.com/">play-with-k8s.com</a>, 创建过程可参考<a target="_blank" rel="noopener" href="https://www.hangge.com/blog/cache/detail_2420.html">这篇文章</a>只要有 github 账号即可以登录使用.</p><span id="more"></span><h2 id="2-部署工具介绍"><a href="#2-部署工具介绍" class="headerlink" title="2. 部署工具介绍"></a>2. 部署工具介绍</h2><p>部署工具和部署环境有很多种选项</p><ul><li><p>常用的部署环境：<br>IaaS 公有云环境：AWS, GCE, Azure，阿里云等；<br>Iaas 私有云环境: OpenStack 和 vSphere 等；<br>Baremetal 环境(裸金属环境)：物理服务器或独立的虚拟机等；</p></li><li><p>常用部署工具：<br>kubeadm<br>kops<br>kubespray<br>Kontena Pharos</p></li><li><p>其它更完善的二次封装的常用发行版<br>Rancher (Labs)<br>Tectonic (CoreOS)<br>Openshift (Redhat)</p></li></ul><p>本文主要讲述选择使用 kubeadm 采用 docker 镜像安装，目的是为了更好的掌握 kubernetes 深层次的概念和运行机制。<br>主机规划：</p><table><thead><tr><th align="left">主机名</th><th align="left">虚拟机类型</th><th>系统</th><th align="left">配置</th><th align="right">网络</th></tr></thead><tbody><tr><td align="left">master01</td><td align="left">VirtualBox</td><td>Centos7.9</td><td align="left">2U2GB SATA:100GB</td><td align="right">IP:192.168.1.71</td></tr><tr><td align="left">node01</td><td align="left">VirtualBox</td><td>Centos7.9</td><td align="left">2U2GB SATA:50GB</td><td align="right">IP:192.168.1.61</td></tr><tr><td align="left">node01</td><td align="left">VirtualBox</td><td>Centos7.9</td><td align="left">2U2GB SATA:50GB</td><td align="right">IP: 192.168.162</td></tr></tbody></table><h3 id="2-1-环境要求"><a href="#2-1-环境要求" class="headerlink" title="2.1. 环境要求"></a>2.1. 环境要求</h3><p>各主机（master01, node01, node02）所需的环境如下：</p><p>(1) 借助于 NTP 服务设定各节点时间精确同步；</p><p>(2) 借助 DNS 完成各节点的主机名称解析，测试环境主机较少时可以使用 hosts 文件进行名称解析；</p><p>(3）关闭主机的 iptables 或 firewall 服务，并确保它们被禁止随系统引导过程启动；<br>(4）各主机禁用 SELinux;</p><p>(5) 各节点禁用所有 Swap 设备</p><p>(6）若要使用 ipvs 模型的 proxy, 各节点还需要载入 ipvs 相关的各模块</p><h4 id="2-1-1-设置各主机-ip"><a href="#2-1-1-设置各主机-ip" class="headerlink" title="2.1.1. 设置各主机 ip"></a>2.1.1. 设置各主机 ip</h4><p>首先将虚拟机设置为桥接模式<br>在 x86 架构上安装 CentOs7 最小安装时，默认 ip 地址设置为 ipv6，如果需要设置为 ipv4，需要进行如下设置。<br>首先确定以 enp 打头的网卡<br>/etc/sysconfig/network-scripts/ifcfg-enp8s0</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">修改为 IPV6INIT=no</span><br><span class="line">BOOTPROTO=<span class="string">&quot;static&quot;</span>         <span class="comment"># 使用静态IP地址，默认为dhcp</span></span><br><span class="line">IPADDR=<span class="string">&quot;192.168.1.71&quot;</span>   <span class="comment"># 设置的静态IP地址</span></span><br><span class="line">NETMASK=<span class="string">&quot;255.255.255.0&quot;</span>    <span class="comment"># 子网掩码</span></span><br><span class="line">GATEWAY=<span class="string">&quot;192.168.1.1&quot;</span>    <span class="comment"># 网关地址</span></span><br><span class="line">DNS1=<span class="string">&quot;192.168.1.1&quot;</span>       <span class="comment"># DNS服务器</span></span><br><span class="line">ONBOOT=yes</span><br></pre></td></tr></table></figure><p>修改 /etc/resolv.conf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加域名解析服务</span></span><br><span class="line">nameserver 192.168.1.1</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment"># 修改后立即重启网络服务，使其生效</span></span><br><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure><h4 id="2-1-2-设置时钟同步"><a href="#2-1-2-设置时钟同步" class="headerlink" title="2.1.2. 设置时钟同步"></a>2.1.2. 设置时钟同步</h4><p>范围：master01, node01, node02<br>若各节点可直接访问互联网，直接启动 chronyd 系统服务，并设定为开机启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start chronyd.service</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> chronyd.service</span><br></pre></td></tr></table></figure><p>时钟同步后和主机不一致的解决办法<br>第一检查</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ls -ltr /etc/localtime</span><br><span class="line"><span class="comment">#如果不是上海，则修改localtime</span></span><br><span class="line">lrwxrwxrwx. 1 root root 38 Jun 19  2020 /etc/localtime -&gt; ../usr/share/zoneinfo/America/New_York</span><br></pre></td></tr></table></figure><p>如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1、vi /etc/sysconfig/clock <span class="comment">#编辑文件</span></span><br><span class="line">ZONE=<span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line">UTC=<span class="literal">false</span> <span class="comment">#设置为false，硬件时钟不与utc时间一致</span></span><br><span class="line">ARC=<span class="literal">false</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <span class="comment">#linux的时区设置为上海</span></span><br><span class="line">systemctl restart chronyd.service</span><br><span class="line">sudo hwclock --systohc <span class="comment">#设置硬件时间和系统时间一致并校准</span></span><br></pre></td></tr></table></figure><p>不过，建议用户配置使用本地的时间服务器，在节点数量众多时尤其如此。 存在可用的时间服务器时，修改节点的/etc/chrony.conf 配置文件，并将时间服务器指向相应的主机即可， 配置格式如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">server CHRONY-SERVER-NAME-OR-IP iburst prefer</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="2-1-3-主机名称解析"><a href="#2-1-3-主机名称解析" class="headerlink" title="2.1.3. 主机名称解析"></a>2.1.3. 主机名称解析</h4><p>范围：master01, node01, node02</p><p>出于简化配置步骤的目的，本教程使用 hosts 文件进行各节点名称解析，文件内容如下所示：</p><p>hostnamectl set-hostname &lt;主机名&gt;</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/hosts</span><br><span class="line"><span class="comment">#添加内容如下</span></span><br><span class="line">192.168.1.71 master01.ilinux.io master01 k8s-master k8s-master.ilinux.io</span><br><span class="line">192.168.1.61 node01.ilinux.io node01 k8s-node01 k8s-node01.ilinux.io</span><br><span class="line">192.168.1.62 node02.ilinux.io node02 k8s-node02 k8s-node02.ilinux.io</span><br></pre></td></tr></table></figure><h4 id="2-1-4-关闭-iptables-或-firewalld-服务"><a href="#2-1-4-关闭-iptables-或-firewalld-服务" class="headerlink" title="2.1.4. 关闭 iptables 或 firewalld 服务"></a>2.1.4. 关闭 iptables 或 firewalld 服务</h4><p>范围：master01, node01, node02</p><p>在 centos7 上， iptables 或 firewalld 服务通常只会安装并启动一种，在不确定具体启动状态的前提下，这里通过同时关闭并禁用二者即可简单达到设定目标。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">systemctl stop firewalld.service</span><br><span class="line"></span><br><span class="line">systemctl stop iptables.service</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">disable</span> iptables.service</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="2-1-5-关闭并禁用-SELinux"><a href="#2-1-5-关闭并禁用-SELinux" class="headerlink" title="2.1.5. 关闭并禁用 SELinux"></a>2.1.5. 关闭并禁用 SELinux</h4><p>范围：master01, node01, node02</p><p>修改 /etc/sysconfig/selinux 文件，将 SELINUX 配置设置为 disabled</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改配置文件，永久禁用selinux, 防止重启导致selinux开启</span></span><br><span class="line"></span><br><span class="line">vi /etc/sysconfig/selinux</span><br><span class="line"></span><br><span class="line">SELINUX=disabled</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 禁用SELinux 立即生效</span></span><br><span class="line"></span><br><span class="line">setenforce 0</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="2-1-6-禁用-Swap-设备"><a href="#2-1-6-禁用-Swap-设备" class="headerlink" title="2.1.6. 禁用 Swap 设备"></a>2.1.6. 禁用 Swap 设备</h4><p>范围：master01, node01, node02</p><p>部署集群时，kubeadm 默认会预先检查当前主机是否禁用了 swap 设备，并在未禁用时强制终止部署过程。因此，在主机内存资源充裕的条件下，需要禁用所有的 Swap 设备，否则，就需要在后文的 kubeadm init 及 kubeadm join 命令执行时额外使用相关的选项忽略检查错误。</p><p>关闭 Swap 设备，需要分两步。首先关闭当前已启用的所有 Swap 设备：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">swapoff -a</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>然后编辑/etc/fstab 配置文件，注释掉 swap 设备的挂载项（永久关闭 swap 分区）</p><h4 id="2-1-7-启用-ipvs-内核模块"><a href="#2-1-7-启用-ipvs-内核模块" class="headerlink" title="2.1.7. 启用 ipvs 内核模块"></a>2.1.7. 启用 ipvs 内核模块</h4><p>范围：master01, node01, node02</p><p>创建内核模块载入相关的脚本文件/etc/sysconfig/modules/ipvs.modules, 设定自动载入的内核模块。文件内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">ipvs_mods_dir=<span class="string">&quot;/usr/lib/modules/<span class="subst">$(uname -r)</span>/kernel/net/netfilter/ipvs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> mod <span class="keyword">in</span> $(ls <span class="variable">$ipvs_mods_dir</span> | grep -o <span class="string">&quot;^[^.]*&quot;</span>); <span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">    /sbin/modinfo -F filename <span class="variable">$mod</span> &amp;&gt; /dev/null</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">        /sbin/modprobe <span class="variable">$mod</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>修改文件权限，并手动为当前系统加载内核模块</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">chmod +x /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"></span><br><span class="line">bash /etc/sysconfig/modules/ipvs.modules</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="3-安装程序包-在各主机上完成如下设定"><a href="#3-安装程序包-在各主机上完成如下设定" class="headerlink" title="3. 安装程序包(在各主机上完成如下设定)"></a>3. 安装程序包(在各主机上完成如下设定)</h2><h3 id="3-1-安装-docker-master01-node01-amp-node02"><a href="#3-1-安装-docker-master01-node01-amp-node02" class="headerlink" title="3.1. 安装 docker (master01, node01 &amp; node02)"></a>3.1. 安装 docker (master01, node01 &amp; node02)</h3><p>安装 docker 之前要确定 docker 版本是否在 kubernetes 相应版本支持列表里面，以避免遇到版本兼容性问题的坑，<a target="_blank" rel="noopener" href="https://blog.csdn.net/m82_a1/article/details/98872734">这里</a> 列出了部分 kubernetes 版本与 docker 版本的兼容信息，希望对你的集群环境搭建有帮助。</p><h4 id="3-1-1-配置-docker-ce-yum-源"><a href="#3-1-1-配置-docker-ce-yum-源" class="headerlink" title="3.1.1. 配置 docker-ce yum 源"></a>3.1.1. 配置 docker-ce yum 源</h4><p>范围：master01, node01, node02</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用阿里云yum源</span></span><br><span class="line">sudo curl https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo -o /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">sudo sed -i <span class="string">&#x27;s+download.docker.com+mirrors.aliyun.com/docker-ce+&#x27;</span> /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者华为云yum源，两者选其一</span></span><br><span class="line">sudo wget -O /etc/yum.repos.d/docker-ce.repo https://repo.huaweicloud.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">sudo sed -i <span class="string">&#x27;s+download.docker.com+repo.huaweicloud.com/docker-ce+&#x27;</span> /etc/yum.repos.d/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新yum源缓存</span></span><br><span class="line">sudo yum makecache fast</span><br><span class="line"><span class="comment">#选择合适的版本</span></span><br><span class="line">yum list docker-ce --showduplicates | sort -r</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装指定版本</span></span><br><span class="line">sudo yum -y install docker-ce-18.03.1.ce-1.el7.centos.x86_64</span><br></pre></td></tr></table></figure><h4 id="3-1-2-配置-docker"><a href="#3-1-2-配置-docker" class="headerlink" title="3.1.2. 配置 docker"></a>3.1.2. 配置 docker</h4><h5 id="3-1-2-1-配置镜像加速"><a href="#3-1-2-1-配置镜像加速" class="headerlink" title="3.1.2.1. 配置镜像加速"></a>3.1.2.1. 配置镜像加速</h5><p>由于 dockerhub 镜像仓库在国外，访问速度较慢，下载镜像的过程中，多数情况下会因为超时而失败，所以强烈建议配置镜像加速。<br>另外在整个安装过程中主要需要与 internet 上三个镜像仓库打交道</p><ol><li>DockerHub,</li><li>gcr.io 这个几乎不能访问，后面会介绍到如何获得其上相应的镜像</li><li>quay.io , 主要是一些网络组件相关的镜像</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sudo</span> vi /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://&lt;你的ID&gt;.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line">    <span class="string">&quot;live-restore&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;debug&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>镜像加速列表</p><table><thead><tr><th align="right">提供者</th><th align="center">镜像地址</th></tr></thead><tbody><tr><td align="right">科大镜像</td><td align="center"><a target="_blank" rel="noopener" href="https://docker.mirrors.ustc.edu.cn/">https://docker.mirrors.ustc.edu.cn/</a></td></tr><tr><td align="right">网易</td><td align="center"><a target="_blank" rel="noopener" href="https://hub-mirror.c.163.com/">https://hub-mirror.c.163.com/</a></td></tr><tr><td align="right">阿里云</td><td align="center"><code>&lt;https://&lt;你的ID&gt;.mirror.aliyuncs.com&gt;</code></td></tr><tr><td align="right">七牛云加速器</td><td align="center"><a target="_blank" rel="noopener" href="https://reg-mirror.qiniu.com/">https://reg-mirror.qiniu.com</a></td></tr><tr><td align="right">daocloud 加速器</td><td align="center"><code>&lt;http://&lt;你的ID&gt;.m.daocloud.io/&gt;</code></td></tr></tbody></table><p>其他还有华为云镜像加速，显然是为华为云用户准备的，请参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41831919/article/details/108287617">这篇文章</a>进行配置镜像加速</p><h5 id="3-1-2-2-docker-iptables-FORWARD-策略"><a href="#3-1-2-2-docker-iptables-FORWARD-策略" class="headerlink" title="3.1.2.2. docker iptables FORWARD 策略"></a>3.1.2.2. docker iptables FORWARD 策略</h5><p>docker 自 1.13 版起会自动设置 iptables 的 FORWARD 默认策略为 DROP，这可能会影响 kubernetes 集群依赖的报文转发功能，因此，需要在 docker 服务启动后，重新将 FORWARD 链的默认策略设置为 ACCEPT，方式是修改/usr/lib/systemd/system/docker.service 文件，在 “ExecStart=/usr/bin/dockerd” 一行之后新增加一行内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ExecStartPost=/usr/sbin/iptables -P FORWARD ACCEPT</span><br></pre></td></tr></table></figure><p>重载完成后即可启动 docker 服务：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 重新加载docker服务设置</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="comment"># 重启docker服务</span></span><br><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure><p>设置为开机自启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> docker</span><br></pre></td></tr></table></figure><p>确保默认使用桥接模式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo sysctl -a | grep bridge</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br></pre></td></tr></table></figure><p>如果不是桥接模式（等号后面为 0）， 手动修改这两个参数<br>方法 1：<br>修改/etc/sysctl.conf 添加以上两个参数</p><p>方法 2：<br>在 /etc/sysctl.d 中添加一个以 conf 为后缀的文件例如 k8s.conf，将以上两项配置添加进去</p><p>手动执行 sysctl -p /etc/sysctl.conf 或者 sysctl -p /etc/sysctl.d/k8s.conf 使其立即生效</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br></pre></td></tr></table></figure><h3 id="3-2-安装-kubelet-master01"><a href="#3-2-安装-kubelet-master01" class="headerlink" title="3.2. 安装  kubelet (master01)"></a>3.2. 安装  kubelet (master01)</h3><p>范围：master01, node01, node02</p><h4 id="3-2-1-配置-kubernetes-yum-源"><a href="#3-2-1-配置-kubernetes-yum-源" class="headerlink" title="3.2.1. 配置 kubernetes yum 源"></a>3.2.1. 配置 kubernetes yum 源</h4><p>创建 /etc/yum.repos.d/kubernetes.repo</p><p>内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cat &lt;&lt;<span class="string">EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=1</span></span><br><span class="line"><span class="string">repo_gpgcheck=1</span></span><br><span class="line"><span class="string">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新yum源缓存</span></span><br><span class="line"> sudo yum -y makecache fast</span><br><span class="line"><span class="comment">#检查版本，选择合适的版本</span></span><br><span class="line">yum list kubeadm --showduplicates | sort -r</span><br><span class="line">yum list kubelet --showduplicates | sort -r</span><br><span class="line">yum list kubectl --showduplicates | sort -r</span><br><span class="line">yum list kubernetes-cni --showduplicates | sort -r</span><br></pre></td></tr></table></figure><h4 id="3-2-2-安装-kubelet"><a href="#3-2-2-安装-kubelet" class="headerlink" title="3.2.2. 安装 kubelet"></a>3.2.2. 安装 kubelet</h4><p>master 和 node 节点要安装以下软件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y kubeadm-1.18.2-0.x86_64 kubelet-1.18.2-0.x86_64 kubectl-1.18.2-0.x86_64 kubernetes-cni-0.8.7-0.x86_64</span><br></pre></td></tr></table></figure><p>并且要设置为开机启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> kubelet &amp;&amp; systemctl start kubelet</span><br></pre></td></tr></table></figure><p>说明：</p><ul><li>kubelet 为 Kubernetes 的核心守护进程之一，负责将配置清单运行为容器(Pod)</li><li>Kubeadm 相当于部署集群本身的一个工具，用于简化集群的安装工作，负责根据配置文件部署集群，升级集群等等工作。</li><li>kubectl 相当于集群的客户端，负责和集群的 API 组件交互，比如查询 node 的状态，容器的运行情况，以及提交任务等等。</li></ul><h4 id="3-2-3-配置-kubelet"><a href="#3-2-3-配置-kubelet" class="headerlink" title="3.2.3. 配置 kubelet"></a>3.2.3. 配置 kubelet</h4><p>如果未禁用 swap 设备，则需要编辑 kubelet 的配置文件/etc/sysconfig/kubelet, 设置忽略 Swap 启用的状态错误， 内容如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KUBELET_EXTRA_ARGS=<span class="string">&quot;--fail-swap-on=false&quot;</span></span><br></pre></td></tr></table></figure><h2 id="4-配置-Master-和-Nodes"><a href="#4-配置-Master-和-Nodes" class="headerlink" title="4. 配置 Master 和 Nodes"></a>4. 配置 Master 和 Nodes</h2><p>components 规划</p><table><thead><tr><th align="center">主机名</th><th align="left">组件</th><th align="center">备注</th></tr></thead><tbody><tr><td align="center">master01</td><td align="left">kubelet (yum 安装) kubadm (yum 安装) kubectl(yum 安装) docker  (yum 安装) kube-apiserver (Pod)kube-scheduler (Pod) kub-controller-manager (Pod) cni (flannel Pod) etcd  (Pod) kube-proxy (Pod)</td><td align="center"></td></tr><tr><td align="center">node01</td><td align="left">kubelet (yum 安装) docker (yum 安装) cni (flannel Pod) kube-proxy (Pod)</td><td align="center"></td></tr><tr><td align="center">node02</td><td align="left">kubelet (yum 安装) docker (yum 安装) cni (flannel Pod) kube-proxy (Pod)</td><td align="center"></td></tr></tbody></table><h3 id="4-1-插件安装"><a href="#4-1-插件安装" class="headerlink" title="4.1. 插件安装"></a>4.1. 插件安装</h3><p>Metrics-Server(Pod)<br>Dashboard (Pod)<br>CoreDNS (Pod)<br>EFK (Pod)<br>Prometheus (Pod)<br>Ingress-Controller (Pod)</p><h3 id="4-2-配置-master-节点"><a href="#4-2-配置-master-节点" class="headerlink" title="4.2. 配置 master 节点"></a>4.2. 配置 master 节点</h3><h4 id="4-2-1-拉取必要的镜像"><a href="#4-2-1-拉取必要的镜像" class="headerlink" title="4.2.1. 拉取必要的镜像"></a>4.2.1. 拉取必要的镜像</h4><p>说明：k8s.gcr.io 上的镜像由于无法描述的原因，在国内无法直接拉取。但是阿里云 registry 中共享了相应版本的 kubernetes 镜像，这里再次感谢阿里的无私贡献，敬佩阿里的企业文化（利他），不仅免费，还有消耗阿里云的大量带宽。由于 docker 镜像命名规范的原因，拉取下来后要重新打 tag 才能使用，以下脚本包含了拉取镜像，更名，清理的功能。本人把安装文档写得足够详细，向阿里致敬！</p><p>kubeadm init –kubernetes-version=1.18.1 --apiserver-advertise-address=192.168.1.71 --image-repository registry.aliyuncs.com/google_containers --service-cidr=10.1.0.0/16 --pod-network-cidr=10.244.0.0/16</p><p>注意修改 apiserver-advertise-address 为 master 节点 ip<br>参数解释：<br>–kubernetes-version: 用于指定 k8s 版本；<br>–apiserver-advertise-address：用于指定 kube-apiserver 监听的 ip 地址,就是 master 本机 IP 地址。<br>–pod-network-cidr：用于指定 Pod 的网络范围； 10.244.0.0/16<br>–service-cidr：用于指定 SVC 的网络范围；<br>–image-repository: 指定阿里云镜像仓库地址</p><p>这一步很关键，由于 kubeadm 默认从官网 k8s.grc.io 下载所需镜像，国内无法访问，因此需要通过–image-repository 指定阿里云镜像仓库地址</p><h4 id="4-2-2-初始化-master"><a href="#4-2-2-初始化-master" class="headerlink" title="4.2.2. 初始化 master"></a>4.2.2. 初始化 master</h4><p>kubeadm init 命令支持两种初始化方式， 一是通过命令行选项传递关键部署设定，另一种是基于 yaml 格式的 kubeadm 专用配置文件，后一种运行用户自定义各种部署参数。下面分别给出了两种实现方式的配置步骤，建议读者采用第二种方式进行。</p><h5 id="4-2-2-1-初始化方式一"><a href="#4-2-2-1-初始化方式一" class="headerlink" title="4.2.2.1. 初始化方式一"></a>4.2.2.1. 初始化方式一</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> kubelet.service</span><br><span class="line">systemctl start kubelet.service</span><br><span class="line">kubeadm init --kubernetes-version=v1.13.2 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --ignore-preflight-errors=Swap</span><br></pre></td></tr></table></figure><p>命令中的各选项说明：<br>（1）–kubernetes-version 选项的版本号用于指定要部署的 kubernetes 程序版本，它需要与预拉取的 kubernetes 镜像版本一致参考脚本变量（K8S_VERSION）<br>（2）–pod-network-cidr 选项用于指定 pod 网络的网段，它通常应该与要部署使用的网络插件(例如 flannel, calico 等)的默认设定保持一致， 10.244.0.0/16 是 flannel 默认使用的网络；<br>（3）–service-cidr 用于指定为 Service 分配使用的网络地址，它由 kubernetes 管理， 默认即为 10.96.0.0/12<br>(4）最后一个选项 –ignore-preflight-errors=Swap 防止未禁用 swap 设备而导致初始化失败，生产环境建议关闭 swap 设备，已获得更好的性能，请参考前述禁用 swap 分区进行设定。<br>（5）这里需要读者对 kubernetes 的三层网（node 网络，pod 网络，service 网络）知识有所了解，再来做相关参数的调整。</p><h5 id="4-2-2-2-初始化方式二"><a href="#4-2-2-2-初始化方式二" class="headerlink" title="4.2.2.2. 初始化方式二"></a>4.2.2.2. 初始化方式二</h5><p>kubeadm 也可以通过配置文件加载配置， 以定制更丰富的部署选项。以下是符合前述命令设定方式的使用示例，不过，它明确定义了 kubeProxy 的模式为 ipvs， 并支持通过修改 imageRepository 的值修改获取系统镜像时使用的镜像仓库。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: kubeadm.k8s.io/v1alpha2</span><br><span class="line">kind: MasterConfiguration</span><br><span class="line">kubernetesVersion: v1.13.2</span><br><span class="line">api:</span><br><span class="line">    advertiseAddress: 192.168.1.71</span><br><span class="line">    bindPort: 6443</span><br><span class="line">    controlPlaneEndpoint: <span class="string">&quot;&quot;</span></span><br><span class="line">imageRepository: k8s.gcr.io</span><br><span class="line">kubeProxy:</span><br><span class="line">    config:</span><br><span class="line">        mode: <span class="string">&quot;ipvs&quot;</span></span><br><span class="line">        ipvs:</span><br><span class="line">            ExcludeCIDRs: null</span><br><span class="line">            minSyncPeriod: 0s</span><br><span class="line">            scheduler: <span class="string">&quot;&quot;</span></span><br><span class="line">            syncPeriod: 30s</span><br><span class="line">kubeletConfiguration:</span><br><span class="line">    baseConfig:</span><br><span class="line">        cgroupDriver: cgroupfs</span><br><span class="line">        clusterDNS:</span><br><span class="line">        - 10.96.0.10</span><br><span class="line">        clusterDomain: cluster.local</span><br><span class="line">        failSwapOn: <span class="literal">false</span></span><br><span class="line">        resolvConf: /etc/resolv.conf</span><br><span class="line">        staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">networking:</span><br><span class="line">    dnsDomain: cluster.local</span><br><span class="line">    podSubnet: 10.244.0.0/16</span><br><span class="line">    serviceSubnet: 10.96.0.0/12</span><br></pre></td></tr></table></figure><p>将上面的内容保存于配置文件中， 例如 kuberadm-config.yaml, 而后执行相应的命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubeadm init --config kubeadm-config.yaml --ignore-prelight-errors=Swap</span></span><br></pre></td></tr></table></figure><p>注意：对于 kubernetes 系统的新用户来说，无论使用上述哪种方式，命令运行结束后，请记录最后的 kubeadm join 命令输出的最后提示的操作步骤。 下面的内容是需要用户记录的一个命令输出示例，它提示了后续需要操作的步骤：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line">    mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">    sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">    sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">you should now deploy a pod network to the cluster</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">    https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line">  you can now join any number of machines by running the following on each node as root:</span><br><span class="line">kubeadm join 172.168.0.70:6443 --token uoutlc.aknhy63zioieuw9x --discovery-toke-ca-cert-hash sha256:cd8bd32c9be6c88573c56f</span><br></pre></td></tr></table></figure><p>接下来要部署一个 podnetwork addon<br>以 flannel 为例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure><p>vi kube-flannel.yml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: policy/v1beta1</span><br><span class="line">kind: PodSecurityPolicy</span><br><span class="line">metadata:</span><br><span class="line">  name: psp.flannel.unprivileged</span><br><span class="line">  annotations:</span><br><span class="line">    seccomp.security.alpha.kubernetes.io/allowedProfileNames: docker/default</span><br><span class="line">    seccomp.security.alpha.kubernetes.io/defaultProfileName: docker/default</span><br><span class="line">    apparmor.security.beta.kubernetes.io/allowedProfileNames: runtime/default</span><br><span class="line">    apparmor.security.beta.kubernetes.io/defaultProfileName: runtime/default</span><br><span class="line">spec:</span><br><span class="line">  privileged: false</span><br><span class="line">  volumes:</span><br><span class="line">  - configMap</span><br><span class="line">  - secret</span><br><span class="line">  - emptyDir</span><br><span class="line">  - hostPath</span><br><span class="line">  allowedHostPaths:</span><br><span class="line">  - pathPrefix: &quot;/etc/cni/net.d&quot;</span><br><span class="line">  - pathPrefix: &quot;/etc/kube-flannel&quot;</span><br><span class="line">  - pathPrefix: &quot;/run/flannel&quot;</span><br><span class="line">  readOnlyRootFilesystem: false</span><br><span class="line">  # Users and groups</span><br><span class="line">  runAsUser:</span><br><span class="line">    rule: RunAsAny</span><br><span class="line">  supplementalGroups:</span><br><span class="line">    rule: RunAsAny</span><br><span class="line">  fsGroup:</span><br><span class="line">    rule: RunAsAny</span><br><span class="line">  # Privilege Escalation</span><br><span class="line">  allowPrivilegeEscalation: false</span><br><span class="line">  defaultAllowPrivilegeEscalation: false</span><br><span class="line">  # Capabilities</span><br><span class="line">  allowedCapabilities: [&#x27;NET_ADMIN&#x27;, &#x27;NET_RAW&#x27;]</span><br><span class="line">  defaultAddCapabilities: []</span><br><span class="line">  requiredDropCapabilities: []</span><br><span class="line">  # Host namespaces</span><br><span class="line">  hostPID: false</span><br><span class="line">  hostIPC: false</span><br><span class="line">  hostNetwork: true</span><br><span class="line">  hostPorts:</span><br><span class="line">  - min: 0</span><br><span class="line">    max: 65535</span><br><span class="line">  # SELinux</span><br><span class="line">  seLinux:</span><br><span class="line">    # SELinux is unused in CaaSP</span><br><span class="line">    rule: &#x27;RunAsAny&#x27;</span><br><span class="line">---</span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: flannel</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&#x27;extensions&#x27;]</span><br><span class="line">  resources: [&#x27;podsecuritypolicies&#x27;]</span><br><span class="line">  verbs: [&#x27;use&#x27;]</span><br><span class="line">  resourceNames: [&#x27;psp.flannel.unprivileged&#x27;]</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - nodes/status</span><br><span class="line">  verbs:</span><br><span class="line">  - patch</span><br><span class="line">---</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: flannel</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: flannel</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: flannel</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: flannel</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">kind: ConfigMap</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-flannel-cfg</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    tier: node</span><br><span class="line">    app: flannel</span><br><span class="line">data:</span><br><span class="line">  cni-conf.json: |</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;cbr0&quot;,</span><br><span class="line">      &quot;cniVersion&quot;: &quot;0.3.1&quot;,</span><br><span class="line">      &quot;plugins&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;type&quot;: &quot;flannel&quot;,</span><br><span class="line">          &quot;delegate&quot;: &#123;</span><br><span class="line">            &quot;hairpinMode&quot;: true,</span><br><span class="line">            &quot;isDefaultGateway&quot;: true</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          &quot;type&quot;: &quot;portmap&quot;,</span><br><span class="line">          &quot;capabilities&quot;: &#123;</span><br><span class="line">            &quot;portMappings&quot;: true</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  net-conf.json: |</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span><br><span class="line">      &quot;Backend&quot;: &#123;</span><br><span class="line">        &quot;Type&quot;: &quot;vxlan&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-flannel-ds</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    tier: node</span><br><span class="line">    app: flannel</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: flannel</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        tier: node</span><br><span class="line">        app: flannel</span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        nodeAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">            nodeSelectorTerms:</span><br><span class="line">            - matchExpressions:</span><br><span class="line">              - key: kubernetes.io/os</span><br><span class="line">                operator: In</span><br><span class="line">                values:</span><br><span class="line">                - linux</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      priorityClassName: system-node-critical</span><br><span class="line">      tolerations:</span><br><span class="line">      - operator: Exists</span><br><span class="line">        effect: NoSchedule</span><br><span class="line">      serviceAccountName: flannel</span><br><span class="line">      initContainers:</span><br><span class="line">      - name: install-cni</span><br><span class="line">        image: quay.io/coreos/flannel:v0.13.1-rc2</span><br><span class="line">        command:</span><br><span class="line">        - cp</span><br><span class="line">        args:</span><br><span class="line">        - -f</span><br><span class="line">        - /etc/kube-flannel/cni-conf.json</span><br><span class="line">        - /etc/cni/net.d/10-flannel.conflist</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: cni</span><br><span class="line">          mountPath: /etc/cni/net.d</span><br><span class="line">        - name: flannel-cfg</span><br><span class="line">          mountPath: /etc/kube-flannel/</span><br><span class="line">      containers:</span><br><span class="line">      - name: kube-flannel</span><br><span class="line">        image: quay.io/coreos/flannel:v0.13.1-rc2</span><br><span class="line">        command:</span><br><span class="line">        - /opt/bin/flanneld</span><br><span class="line">        args:</span><br><span class="line">        - --ip-masq</span><br><span class="line">        - --kube-subnet-mgr</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            cpu: &quot;100m&quot;</span><br><span class="line">            memory: &quot;50Mi&quot;</span><br><span class="line">          limits:</span><br><span class="line">            cpu: &quot;100m&quot;</span><br><span class="line">            memory: &quot;50Mi&quot;</span><br><span class="line">        securityContext:</span><br><span class="line">          privileged: false</span><br><span class="line">          capabilities:</span><br><span class="line">            add: [&quot;NET_ADMIN&quot;, &quot;NET_RAW&quot;]</span><br><span class="line">        env:</span><br><span class="line">        - name: POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">        - name: POD_NAMESPACE</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.namespace</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: run</span><br><span class="line">          mountPath: /run/flannel</span><br><span class="line">        - name: flannel-cfg</span><br><span class="line">          mountPath: /etc/kube-flannel/</span><br><span class="line">      volumes:</span><br><span class="line">      - name: run</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /run/flannel</span><br><span class="line">      - name: cni</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /etc/cni/net.d</span><br><span class="line">      - name: flannel-cfg</span><br><span class="line">        configMap:</span><br><span class="line">          name: kube-flannel-cfg</span><br></pre></td></tr></table></figure><p>注意：kubernetes 本身没有 pod 网络创建和管理功能，其本身只提供了一组依赖网络组件的接口，网络功能一般有第三方插件完成，比如 flannel, calico 等等。但是 Kubernetes 本身集成了 service 网络的管理功能，其底层实际是创建一系列 iptables 或 ipvs 规则来完成的。</p><p>部署完之后查看 kubernetes 相关的容器<br>coredns<br>etcd<br>kube-apiserver<br>kuber-controller<br>kube-flannel-ds-amd64-bbnz2<br>kube-proxy<br>kube-scheduler</p><h3 id="4-3-配置第一个-node-节点-并添加到集群"><a href="#4-3-配置第一个-node-节点-并添加到集群" class="headerlink" title="4.3. 配置第一个 node 节点, 并添加到集群"></a>4.3. 配置第一个 node 节点, 并添加到集群</h3><p>修改 ip 地址<br>修改主机名部分，改为 k8s-node01</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname k8s-node01</span><br></pre></td></tr></table></figure><p>安装软件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y kubeadm-1.18.2-0.x86_64 kubelet-1.18.2-0.x86_64 kubectl-1.18.2-0.x86_64 kubernetes-cni-0.8.7-0.x86_64</span><br></pre></td></tr></table></figure><p>并且要设置为开机启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> kubelet &amp;&amp; systemctl start kubelet</span><br></pre></td></tr></table></figure><p>下载 flannel 镜像</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/daoh/flannel:v0.12.0-amd64</span><br></pre></td></tr></table></figure><p>为镜像打 tag，保持和 yaml 文件一样。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/daoh/flannel:v0.12.0-amd64 quay.io/coreos/flannel:v0.12.0-amd64</span><br></pre></td></tr></table></figure><p>准备配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/cni/net.d/</span><br><span class="line">vi /etc/cni/net.d/10-flannel.conf</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;cbr0&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;flannel&quot;</span>,<span class="string">&quot;delegate&quot;</span>: &#123;<span class="string">&quot;isDefaultGateway&quot;</span>: <span class="literal">true</span>&#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mkdir -p /usr/share/oci-umount/oci-umount.d</span><br><span class="line"></span><br><span class="line">mkdir /run/flannel/</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/k8s</span><br><span class="line"><span class="built_in">cd</span> k8s</span><br><span class="line">wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line">kubectl apply -f kube-flannel.yml</span><br></pre></td></tr></table></figure><p>在 master 上查询 join string</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure><p>在 node 上执行查询结果, 加入集群</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.1.71:6443 --token ud6ny7.9wzcg5du5zvrbbfv \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:dffb435eb20f133a8419bd406daf79cf6e4ee6af490xyzsd0ba95f610e5b1ec3</span><br></pre></td></tr></table></figure><p>设置开机启动</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><p>查看 node 状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 k8s]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME         STATUS   ROLES    AGE     VERSION</span><br><span class="line">k8s-master   Ready    master   45h     v1.18.2</span><br><span class="line">k8s-node01   Ready    &lt;none&gt;   5m52s   v1.18.2</span><br></pre></td></tr></table></figure><h3 id="4-4-配置第二个-node-节点-并添加到集群"><a href="#4-4-配置第二个-node-节点-并添加到集群" class="headerlink" title="4.4. 配置第二个 node 节点, 并添加到集群"></a>4.4. 配置第二个 node 节点, 并添加到集群</h3><p>修改 ip 地址<br>vi /etc/sysconfig/network-scripts/ifcfg-enp0s3<br>修改 ip 地址<br>修改主机名部分，改为 k8s-node02</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname k8s-node02</span><br></pre></td></tr></table></figure><p>重新启动<br>重新登录 node2<br>重新初始化节点配置, 执行命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm reset</span><br></pre></td></tr></table></figure><p>重新加入集群</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 192.168.1.71:6443 --token ud6ny7.9wzcg5du5zvrbbfv \</span><br><span class="line">--discovery-token-ca-cert-hash sha256:dffb435eb20f133a8419bd406daf79cf6e4ee6af490xyzsd0ba95f610e5b1ec3</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node02 ~]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME         STATUS   ROLES    AGE    VERSION</span><br><span class="line">k8s-master   Ready    master   45h    v1.18.2</span><br><span class="line">k8s-node01   Ready    &lt;none&gt;   31m    v1.18.2</span><br><span class="line">k8s-node02   Ready    &lt;none&gt;   4m3s   v1.18.2</span><br></pre></td></tr></table></figure><h2 id="5-问题排查-troubleshooting"><a href="#5-问题排查-troubleshooting" class="headerlink" title="5. 问题排查 troubleshooting"></a>5. 问题排查 troubleshooting</h2><p>在 k8s 中，大部分的问题，都能通过 logs 和 describe 两个命令进行分析和定位</p><h2 id="6-后记"><a href="#6-后记" class="headerlink" title="6. 后记"></a>6. 后记</h2><p>本技术博客原创文章位于<a href="https://www.pengtech.net/k8s/setup_k8s_cluster.html">鹏叔的技术博客 - 创建 kubernetes 集群</a>, 要获取最近更新请访问原文.</p><p>更多技术博客请访问: <a href="https://www.pengtech.net/archives/">鹏叔的技术博客</a></p><h2 id="7-参考文档"><a href="#7-参考文档" class="headerlink" title="7. 参考文档"></a>7. 参考文档</h2><p><a href="%5Bhttps://kubernetes.io%5D(https://kubernetes.io/docs/tutorials/)">kubernetes 官方网站</a></p><p><a href="%5Bhttps://github.com/kubernetes/kubernetes%5D(https://github.com/kubernetes/kubernetes)">Kubernetes github</a></p><p><a href="%5Bhttps://www.cnblogs.com/xinfang520/p/11698404.html%5D(https://www.cnblogs.com/xinfang520/p/11698404.html)">k8s 记录-国内下载 k8s 组件镜像</a></p><p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1761490">Kubernetes 1.20 版本开始不推荐使用 Docker，你知道吗</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m82_a1/article/details/98872734">Kubernetes 各版本对应支持的 docker 版本列表</a></p><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42311672/article/details/113085450?utm_medium=distribute.pc_relevant.none-task-blog-baidujs_utm_term-2&spm=1001.2101.3001.4242">k8s 不再支持 docker_k8s 不支持 Docker 了？ 别慌！官方最新解释来了…</a></p><p>[<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/53256739/which-kubernetes-version-is-supported-in-docker-version-18-09">Which kubernetes version is supported in docker version 18.09</a>]<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/llinyunxia/article/details/106149566">单机版 kubernetes 1.18.2 安装</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zhizihuakai/p/12629514.html">https://www.cnblogs.com/zhizihuakai/p/12629514.html</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/llinyunxia/article/details/106160654?utm_medium=distribute.pc_relevant.none-task-blog-baidujs_title-0&spm=1001.2101.3001.4242">https://blog.csdn.net/llinyunxia/article/details/106160654?utm_medium=distribute.pc_relevant.none-task-blog-baidujs_title-0&amp;spm=1001.2101.3001.4242</a></p></div><footer class="post-footer"><div class="reward-container"><div>您的支持是我创作深度好文的源动力!</div><button>赞赏</button><div class="post-reward"><div><img src="/imgs/rewards/wechatpay.jpg" alt="鹏叔 微信"> <span>微信</span></div><div><img src="/imgs/rewards/alipay.jpg" alt="鹏叔 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"><strong>本文作者： </strong>鹏叔</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://www.pengtech.net/k8s/setup_k8s_cluster.html" title="创建kubernetes集群">https://www.pengtech.net/k8s/setup_k8s_cluster.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="post-tags"><a href="/tags/k8s/" rel="tag"><i class="fa fa-tag"></i> k8s</a></div><div class="post-nav"><div class="post-nav-item"><a href="/linux/linux_connect_wifi.html" rel="prev" title="linux命令行连接wifi"><i class="fa fa-chevron-left"></i> linux命令行连接wifi</a></div><div class="post-nav-item"><a href="/java/jdk17_installation.html" rel="next" title="JDK17安装">JDK17安装 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments utterances-container"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">鹏叔</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span>站点总字数：</span> <span title="站点总字数">1.3m</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">19:58</span></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener external nofollow" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener external nofollow" target="_blank">NexT.Mist</a> 强力驱动</div><div class="addthis_inline_share_toolbox"><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-615fe625918d4f20" async></script></div></div></footer><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.13.2/dist/mermaid.min.js","integrity":"sha256-UIQPVkGifpwMvDH5yGgORJ9sSTDq38zz6BGU6dNaKhM="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"guoapeng/guoapeng.github.io","issue_term":"pathname","theme":"github-light","cdn":"https://utteranc.es/client.js"}</script><script src="/js/third-party/comments/utterances.js"></script></body></html>