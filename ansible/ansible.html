<!doctype html><html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta><title>运维自动化之Ansible - 鹏叔的技术博客</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="鹏叔的技术博客"><meta name="msapplication-TileImage" content="/images/favicon-16x16-next.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="鹏叔的技术博客"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="1. 介绍1.1. Ansible 发展和起源Ansible 是一款开源的 IT 配置管理工具，常被 IT 界的小伙伴们用于服务部署、配置管理等工作。配置文件采用最常见的 yaml 格式，学习起来也是比较容易，并且不像 SaltStack，Ansible 并不需要也没有 agent，只有一个控制端。该工具使用简单但功能非常强大，可以解决众多工作中繁琐的服务安装、配置等问题。"><meta property="og:type" content="blog"><meta property="og:title" content="鹏叔的技术博客"><meta property="og:url" content="https://pengtech.net/"><meta property="og:site_name" content="鹏叔的技术博客"><meta property="og:description" content="1. 介绍1.1. Ansible 发展和起源Ansible 是一款开源的 IT 配置管理工具，常被 IT 界的小伙伴们用于服务部署、配置管理等工作。配置文件采用最常见的 yaml 格式，学习起来也是比较容易，并且不像 SaltStack，Ansible 并不需要也没有 agent，只有一个控制端。该工具使用简单但功能非常强大，可以解决众多工作中繁琐的服务安装、配置等问题。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://pengtech.net/img/og_image.png"><meta property="article:published_time" content="2021-10-27T16:00:00.000Z"><meta property="article:modified_time" content="2024-07-10T10:42:45.388Z"><meta property="article:author" content="eagle"><meta property="article:tag" content="linux"><meta property="article:tag" content="Ansible"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://pengtech.net/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://pengtech.net/ansible/ansible.html"},"headline":"运维自动化之Ansible","image":["https://pengtech.net/img/og_image.png"],"datePublished":"2021-10-27T16:00:00.000Z","dateModified":"2024-07-10T10:42:45.388Z","author":{"@type":"Person","name":"鹏叔"},"publisher":{"@type":"Organization","name":"鹏叔的技术博客","logo":{"@type":"ImageObject","url":{"text":"鹏叔的技术博客"}}},"description":"1. 介绍1.1. Ansible 发展和起源Ansible 是一款开源的 IT 配置管理工具，常被 IT 界的小伙伴们用于服务部署、配置管理等工作。配置文件采用最常见的 yaml 格式，学习起来也是比较容易，并且不像 SaltStack，Ansible 并不需要也没有 agent，只有一个控制端。该工具使用简单但功能非常强大，可以解决众多工作中繁琐的服务安装、配置等问题。"}</script><link rel="canonical" href="https://pengtech.net/ansible/ansible.html"><link rel="alternate" href="/atom.xml" title="鹏叔的技术博客" type="application/atom+xml"><link rel="icon" href="/images/favicon-16x16-next.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link data-pjax rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link data-pjax rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script"),t=(e.src="//hm.baidu.com/hm.js?1da0f55a32eb17a877b1b18efa3d0406",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)}()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-ZZTM0Y954E" async></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-ZZTM0Y954E")</script><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><script data-ad-client="ca-pub-9737903136672124" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async></script><meta name="follow.it-verification-code" content="FDYm0CxLRXUa9hVlR3zQ"><script>!function(){function e(){var e,t,a;location.hash&&(e="#"+CSS.escape(location.hash.substring(1)),t=document.querySelector(`.tabs a[href="${e}"]`))&&(a=t.parentElement.parentElement,Array.from(a.children).forEach(e=>e.classList.remove("is-active")),Array.from(a.querySelectorAll("a")).map(e=>document.getElementById(e.getAttribute("href").substring(1))).forEach(e=>e.classList.add("is-hidden")),t&&t.parentElement.classList.add("is-active"),a=document.querySelector(e))&&a.classList.remove("is-hidden")}e(),window.addEventListener("hashchange",e,!1)}()</script><meta name="generator" content="Hexo 7.3.0"></head><body class="is-3-column"><script type="text/javascript" src="/js/imaegoo/night.js"></script><canvas id="universe"></canvas><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">鹏叔的技术博客</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/angular">angular</a><a class="navbar-item" href="/material-design">material-design</a><a class="navbar-item" href="/linux">linux</a><a class="navbar-item" href="/gitlab">gitlab</a><a class="navbar-item" href="/frontend">frontend</a><a class="navbar-item" href="/backend">backend</a><a class="navbar-item" href="/vscode">vscode</a><a class="navbar-item" href="/java">java</a><a class="navbar-item" href="/golang">golang</a><a class="navbar-item" href="/v2rayA">v2rayA</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/tools">工具</a><a class="navbar-item" href="/friends">友链</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item night" id="night-nav" title="Night Mode" href="javascript:;"><i class="fas fa-moon" id="night-icon"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time datetime="2021-10-27T16:00:00.000Z" title="2021/10/28 00:00:00">2021-10-28</time>发表</span><span class="level-item"><time datetime="2024-07-10T10:42:45.388Z" title="2024/7/10 18:42:45">2024-07-10</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/devops/">devops</a><span> / </span><a class="link-muted" href="/categories/devops/ansible/">ansible</a></span><span class="level-item">1 小时读完 (大约11582个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">运维自动化之Ansible</h1><div class="content"><h2 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h2><h3 id="1-1-Ansible-发展和起源"><a href="#1-1-Ansible-发展和起源" class="headerlink" title="1.1. Ansible 发展和起源"></a>1.1. Ansible 发展和起源</h3><p>Ansible 是一款开源的 IT 配置管理工具，常被 IT 界的小伙伴们用于服务部署、配置管理等工作。配置文件采用最常见的 yaml 格式，学习起来也是比较容易，并且不像 SaltStack，Ansible 并不需要也没有 agent，只有一个控制端。该工具使用简单但功能非常强大，可以解决众多工作中繁琐的服务安装、配置等问题。</p><span id="more"></span><p>Ansible 的第一个版本是 0.0.1，发布于 2012 年 3 月 9 日，其作者兼创始人是 Michael DeHaan。迄今为止已经发展到了 2.9 版本。并且它的关注度、Star 数以及 Fork 的次数都位居榜首。就连强大的 SaltStack 也只能排到第二。</p><p>Michael DeHaan 在配置管理和架构设计方面有丰富的经验，曾就职于 RedHat 公司，在 RedHat 任职期间主要开发了 Cobble。在他尝试了各种自动化工具 Puppet、Chef 之后，决定自己打造一款能够结合众多优点的自动化工具。由此，便有了 Ansible 这款易理解、易上手、受众人喜爱的自动化工具。</p><h3 id="1-2-为什么需要-Ansible"><a href="#1-2-为什么需要-Ansible" class="headerlink" title="1.2. 为什么需要 Ansible"></a>1.2. 为什么需要 Ansible</h3><p>前面说过，ansible 通常用于自动化的场景，多用在服务部署、配置管理方面。随着时间推移和公司发展，项目越来越多，团队日益壮大，各种公司内部开发的应用、第三方开源的中间件等服务越来越多，那么管理起来就相对比较困难，人肉操作已经完全满足不了传统的运维工作，需要消耗相当多的时间来进行变更，进而阻碍了开发人员的速度，极大的降低了工作效率。显然可考又高效的部署和管理成为了公司的一大难点与挑战。那么一款高效且可靠的服务部署和管理工具就显得尤为重要。而在很长一段时间里，Docker 容器与 kubernetes 容器编排系统没有被广泛的普及之前，有很大一部分人在使用 Jenkins + Ansible 进行 CICD。</p><h3 id="1-3-Ansible-的主要功能"><a href="#1-3-Ansible-的主要功能" class="headerlink" title="1.3. Ansible 的主要功能"></a>1.3. Ansible 的主要功能</h3><p>批量执行远程命令：可以对任意多台主机同时进行命令的执行。</p><p>批量配置软件服务：可以进行自动化的方式部署、配置及管理服务。</p><p>编排高级的 IT 任务：Ansible 可以使用 yaml 来编写一套完整的 Playbook，用来部署维护一套完全的基础架构。</p><h3 id="1-4-Ansible-的相关特性"><a href="#1-4-Ansible-的相关特性" class="headerlink" title="1.4. Ansible 的相关特性"></a>1.4. Ansible 的相关特性</h3><p>Ansible 是基于每个模块进行工作，自身并没有批量部署的能力，ansible 自身只是提供了一种框架。</p><p>Ansible 由 Python 语言开发，没有 agent，不需要在被管理节点安装任何客户端；</p><p>模块化：基于模块工作，秩序调用特定的模块来完成特定工作；</p><p>基于 SSH 协议；</p><p>三大关键组成模块：Paramiko， PyYAML， Jinja2；</p><p>幂等性：一个任务执行 1 遍和执行 n 遍效果一样，不因重复执行带来意外情况；</p><p>可以使用命令行 ad-hoc 方式来执行批量任务，也可以使用 yaml 格式的文件来定制 Playbook 剧本实现批量任务；</p><p>可以使用 Role 组织批量任务</p><h3 id="1-5-Ansible-的优点"><a href="#1-5-Ansible-的优点" class="headerlink" title="1.5. Ansible 的优点"></a>1.5. Ansible 的优点</h3><p>容易学习且轻量：无需在被控制节点安装 agent，做批量操作时只需要在操作机操作即可(前提：需要配置好免密登录)；</p><ul><li>操作灵活：具有众多的模块，可使用命令行 ad-hoc 方式或者 Playbook 剧本的方式来实现批量任务执行；</li><li>可移植性高：可以基于 yaml 文件编写一套 Playbook，只要做好逻辑判断，就可以在多种操作系统上拿来即用；</li><li>幂等性：一个任务执行 1 遍和执行 n 遍效果一样，不因重复执行带来意外情况；</li><li>支持普通用户 sudo 提权。</li></ul><p>但是任何事物都具有两面性。SSH 虽好，但如果被管理的机器数量众多的话，执行的速度就会比较慢，就需要进行一定的优化和分批任务来缓解速度问题。</p><h3 id="1-6-Ansible-的架构"><a href="#1-6-Ansible-的架构" class="headerlink" title="1.6. Ansible 的架构"></a>1.6. Ansible 的架构</h3><p>Ansible 由以下几个核心工具组成：</p><ul><li>INVENTORY：Ansible 管理主机的清单&#x2F;etc&#x2F;anaible&#x2F;hosts；</li><li>MODULES：Ansible 执行命令的功能模块，多数为内置核心模块，也可自定义；</li><li>PLUGINS：模块功能的补充，如连接类型插件、循环插件、变量插件、过滤插件等；</li><li>APl：供第三方程序调用的应用程序编程接口。</li></ul><p>在日常工作中，我们大多数用到的且使用比较频繁的主要是：Inventory 和 Modules。通常我们会根据项目的需求来定制化我们的 Inventory，不会将它放在默认的&#x2F;etc&#x2F;anaible&#x2F;hosts 文件中。</p><h2 id="2-运维自动化和-Ansible-架构介绍"><a href="#2-运维自动化和-Ansible-架构介绍" class="headerlink" title="2. 运维自动化和 Ansible 架构介绍"></a>2. 运维自动化和 Ansible 架构介绍</h2><h3 id="2-1-运维自动化发展历程及技术应用"><a href="#2-1-运维自动化发展历程及技术应用" class="headerlink" title="2.1. 运维自动化发展历程及技术应用"></a>2.1. 运维自动化发展历程及技术应用</h3><h4 id="2-1-1-云计算运维工程师核心职能"><a href="#2-1-1-云计算运维工程师核心职能" class="headerlink" title="2.1.1. 云计算运维工程师核心职能"></a>2.1.1. 云计算运维工程师核心职能</h4><ul><li>平台架构组建<br>负责参与并审核架构设计的合理性和可运维性, 搭建运维平台技术架构, 通过开源解决方案,以确保在产品发布之后能高效稳定的运行,<br>保障并不断提升服务的可用性, 确保用户数据安全, 提升用户体验.</li><li>日常运营保障<br>负责用运维技术或者运维平台确保产品可以高效的发布上线, 负责保障产品 7*24H 稳定运行, 在此期间对出现的各种问题可以快速的定位并解决; 在日常工作中不断优化系统架构和部署的合理性, 以提升系统服务的稳定性.</li><li>性能, 效率优化<br>用自动化的工具&#x2F;平台提升软件在研发声明周期中的工作效率. 优化资源利用率支持产品的不断迭代, 需要不断的进行架构优化调整, 以确保整个产品能够在功能不断丰富和复杂的条件下, 同时保持高可用性.</li></ul><h4 id="2-1-2-软件开发阶段"><a href="#2-1-2-软件开发阶段" class="headerlink" title="2.1.2. 软件开发阶段"></a>2.1.2. 软件开发阶段</h4><p>计划&#x3D;&gt;编码&#x3D;&gt;打包&#x3D;&gt;测试&#x3D;&gt;发布&#x3D;&gt;部署&#x3D;&gt;运维&#x3D;&gt;监控</p><h5 id="2-1-2-1-相关工具"><a href="#2-1-2-1-相关工具" class="headerlink" title="2.1.2.1. 相关工具"></a>2.1.2.1. 相关工具</h5><ul><li>代码管理(SCM): GitHub, GitLab, BitBucket, SubVersion</li><li>构建工具: maven, Ant, Gradle</li><li>自动化部署: Capistrano, CodeDeploy</li><li>持续集成(CI): jenkins, Travis</li><li>配置管理: Ansible, SaltStack, Chef, Puppet</li><li>容器: Docker, Podman, LXC, 第三方厂商如 AWS</li><li>编排: Kubernetes, Cor, Apache Mesos</li><li>服务注册与发现: Zookeeper, etcd, Consul</li><li>脚本语言: python, ruby, shell</li><li>日志管理: ELK, Logentries</li><li>系统监控: Prometheus, Zabbix, Datadog, Graphite, Ganglia, Nagios</li><li>性能监控: AppDynamics, New Relic, Splunk</li><li>压力测试: JMeter, Blaze meter, loader.io</li><li>应用服务器: Tomcat, jBoss, IIS</li><li>Web 服务器: Apache, Nginx</li><li>数据库: MySQL, Oracel, PostgreSQL 等关系型数据库; mongoDB, Redis 等 NoSQL 数据库.</li><li>项目管理(PM): Jira, Asana, Taiga, Trello, Basecamp, Pivotal Tracker</li></ul><h4 id="2-1-3-运维工程师的发展路线"><a href="#2-1-3-运维工程师的发展路线" class="headerlink" title="2.1.3. 运维工程师的发展路线"></a>2.1.3. 运维工程师的发展路线</h4><p>基础运维&#x3D;&gt;监控运维&#x3D;&gt;系统运维&#x3D;&gt;应用运维&#x3D;&gt;自动化运维&#x3D;&gt;架构师&#x3D;&gt;总监或 CTO</p><h5 id="2-1-3-1-运维的未来是什么"><a href="#2-1-3-1-运维的未来是什么" class="headerlink" title="2.1.3.1. 运维的未来是什么?"></a>2.1.3.1. 运维的未来是什么?</h5><ol><li>一切皆自动化<br>“运维的未来是, 让开发人员借助工具, 自动化和流程, 并且让他们能够在运维干预极少的情况下部署和运维服务, 从而实现自助服务, 每一个角色都应该努力使工作实现自动化.” — &lt;&lt;运维的未来&gt;&gt;</li></ol><h5 id="2-1-3-2-企业实际应用场景"><a href="#2-1-3-2-企业实际应用场景" class="headerlink" title="2.1.3.2. 企业实际应用场景"></a>2.1.3.2. 企业实际应用场景</h5><h6 id="2-1-3-2-1-Dev-开发环境"><a href="#2-1-3-2-1-Dev-开发环境" class="headerlink" title="2.1.3.2.1. Dev 开发环境"></a>2.1.3.2.1. Dev 开发环境</h6><p>使用者: 程序员<br>功能: 程序员个人的办公电脑或项目的开发测试环境, 部署开发软件, 测试个人或项目整体的 BUG 的环境<br>管理者: 程序员</p><h6 id="2-1-3-2-2-测试环境"><a href="#2-1-3-2-2-测试环境" class="headerlink" title="2.1.3.2.2. 测试环境"></a>2.1.3.2.2. 测试环境</h6><p>使用者: QA 测试工程师<br>功能: 测试经过 Dev 环境测试通过的软件的功能和性能, 判断是否达到项目的预期目标, 生成测试报告.<br>管理者: 运维<br>说明: 测试环境往往有多套, 测试环境满足测试功能即可, 不易过多</p><ol><li>测试人员希望测试环境多套, 公司的产品多产品线并发, 即多个版本, 意味着多个版本同步测试.</li><li>通常测试环境有多套和产品线数量保持一样</li></ol><h6 id="2-1-3-2-3-预发布环境"><a href="#2-1-3-2-3-预发布环境" class="headerlink" title="2.1.3.2.3. 预发布环境"></a>2.1.3.2.3. 预发布环境</h6><p>使用者: 运维<br>功能: 使用和生产环境一样的数据库, 缓存服务等配置, 测试是否正常</p><h6 id="2-1-3-2-4-发布环境"><a href="#2-1-3-2-4-发布环境" class="headerlink" title="2.1.3.2.4. 发布环境"></a>2.1.3.2.4. 发布环境</h6><p>包括代码发布机, 有些公司为堡垒机(安全屏障)</p><p>使用者: 运维<br>功能: 发布代码至生产环境<br>管理者: 运维<br>发布机: 往往需要有 2 台(主备)</p><h6 id="2-1-3-2-5-生产环境"><a href="#2-1-3-2-5-生产环境" class="headerlink" title="2.1.3.2.5. 生产环境"></a>2.1.3.2.5. 生产环境</h6><p>使用者: 运维, 少数情况开放权限给核心开发人员, 极少数公司将权限完全开放给开发人员并维护<br>功能: 对用户提供公司产品的服务</p><h6 id="2-1-3-2-6-灰度环境"><a href="#2-1-3-2-6-灰度环境" class="headerlink" title="2.1.3.2.6. 灰度环境"></a>2.1.3.2.6. 灰度环境</h6><p>属于生产环境的一部分<br>使用者: 运维<br>功能: 在全量发布代码前将代码的功能面向少量精准用户发布的环境, 可基于主机或用户执行灰度发布<br>案例: 供 100 台生产服务器, 先发布其中 10 台服务器, 这 10 台服务器就是灰度服务器<br>管理者: 运维<br>灰度环境: 往往该版本功能变更较大, 为了保险起见特意先让一部分用户优化体验该功能, 待这部分用户使用没有重大问题的时候, 再全量发布至所有服务器</p><h5 id="2-1-3-3-程序发布"><a href="#2-1-3-3-程序发布" class="headerlink" title="2.1.3.3. 程序发布"></a>2.1.3.3. 程序发布</h5><p>程序发布要求:</p><p>不能导致系统故障或造成系统完全不可用<br>不能影响用户体验</p><p>预发布验证:</p><p>新版本的代码发布到服务器(跟线上环境配置完全相同, 只是未接入到调度器)</p><p>灰度发布:</p><p>基于主机, 用户, 业务</p><p>正式发布</p><p>发布过程:</p><ol><li>在调度器上下线一批主机标记为 mainttenance 状态</li><li>关闭服务</li><li>部署新版本的应用程序</li><li>启动服务</li><li>在调度器上启用这一批服务器</li></ol><p>自动化灰度发布:</p><p>脚本<br>发布平台</p><h6 id="2-1-3-3-1-自动化运维应用场景"><a href="#2-1-3-3-1-自动化运维应用场景" class="headerlink" title="2.1.3.3.1. 自动化运维应用场景"></a>2.1.3.3.1. 自动化运维应用场景</h6><p>文件传输<br>应用部署<br>配置管理<br>任务流编排</p><h5 id="2-1-3-4-常用自动化运维工具"><a href="#2-1-3-4-常用自动化运维工具" class="headerlink" title="2.1.3.4. 常用自动化运维工具"></a>2.1.3.4. 常用自动化运维工具</h5><ul><li>Ansible: python, Agentless, 中小型应用环境</li><li>Saltstack: python, 一般需要部署 Agent, 执行效率更高</li><li>Puppet: Ruby, 功能强大, 配置复杂, 重型, 适合大型环境</li><li>Fabric: python, agentless</li><li>Chef: ruby, 国内应用少</li><li>Cfengine</li><li>func</li></ul><h4 id="2-1-4-Ansible-介绍和架构"><a href="#2-1-4-Ansible-介绍和架构" class="headerlink" title="2.1.4. Ansible 介绍和架构"></a>2.1.4. Ansible 介绍和架构</h4><h5 id="2-1-4-1-Ansible-发展史"><a href="#2-1-4-1-Ansible-发展史" class="headerlink" title="2.1.4.1. Ansible 发展史"></a>2.1.4.1. Ansible 发展史</h5><p>作者: Michael DeHaan(Cobbler 与 Func 作者)<br>ansible 的名字来自&lt;&lt;安德的游戏&gt;&gt;中跨越时空的即时通信工具<br>2012-03-09, 发布 0.0.1 版, 2015-10-17, Red Hat 宣布 1.5 亿美金收购</p><p>官网: <a target="_blank" rel="noopener" href="http://www.ansible.com/">http://www.ansible.com/</a><br>官方文档: <a target="_blank" rel="noopener" href="https://docs.ansible.com/">https://docs.ansible.com/</a></p><h5 id="2-1-4-2-Ansible-特性"><a href="#2-1-4-2-Ansible-特性" class="headerlink" title="2.1.4.2. Ansible 特性"></a>2.1.4.2. Ansible 特性</h5><ul><li>模块化: 调用特定的模块, 完成特定任务</li><li>Paramiko(python 对 ssh 的实现), PyYAML, jinja2(模板语言) 三个关键模块</li><li>支持自定义模块, 可使用任何编程语言写模块</li><li>基于 Python 语言实现</li><li>部署简单, 基于 python 和 SSH(默认已安装), agentless, 无需代理不依赖 PKI(无需 ssl)</li><li>安全, 基于 OpenSSH</li><li>幂等性: 一个任务执行 1 遍和 n 遍效果一样, 不因重复执行带来意外情况</li><li>支持 playbook 编排任务, YAML 格式, 支持丰富的数据结构</li><li>较强的多层解决方案 role</li></ul><h5 id="2-1-4-3-Ansible-架构"><a href="#2-1-4-3-Ansible-架构" class="headerlink" title="2.1.4.3. Ansible 架构"></a>2.1.4.3. Ansible 架构</h5><h6 id="2-1-4-3-1-Ansible-组成"><a href="#2-1-4-3-1-Ansible-组成" class="headerlink" title="2.1.4.3.1. Ansible 组成"></a>2.1.4.3.1. Ansible 组成</h6><p>Inventory, API, Modules, Plugin 的绿框, 可以理解为是 Ansible 命令工具,<br>其为核心执行工具.</p><ul><li>Inventory: Ansible 管理主机的清单&#x2F;etc&#x2F;ansible&#x2F;hosts</li><li>Modules: Ansible 执行命令的功能模块, 多数为内置核心模块, 也可自定义</li><li>Plugins: 模块功能的补充, 如连接类型插件, 循环插件, 变量插件, 过滤插件等, 该功能不常用</li><li>API: 供第三方程序调用的应用程序接口</li></ul><h6 id="2-1-4-3-2-Ansible-命令执行来源"><a href="#2-1-4-3-2-Ansible-命令执行来源" class="headerlink" title="2.1.4.3.2. Ansible 命令执行来源"></a>2.1.4.3.2. Ansible 命令执行来源</h6><ul><li>User 普通用户, 即 System Administrator</li><li>Playbooks: 任务剧本(任务集), 编排定义 Ansible 任务集的配置文件, 由 Ansible 顺序依次执行, 通常是 Json 格式的 YML 文件</li><li>CMDB(配置管理数据库) API 调用</li><li>PUBLIC&#x2F;PRIVATE Cloud API 调用</li><li>User &#x3D;&gt; Ansible Playbook &#x3D;&gt; Ansible</li></ul><h6 id="2-1-4-3-3-注意事项"><a href="#2-1-4-3-3-注意事项" class="headerlink" title="2.1.4.3.3. 注意事项"></a>2.1.4.3.3. 注意事项</h6><ul><li>执行 ansible 的主机一般称为主控端, 中控, master 或堡垒机</li><li>主控端 Python 版本需要 2.6 或以上</li><li>被控端 Python 版本小于 2.4 需要安装 python-simplejson</li><li>被控端如开启 SELinux 需要安装 libselinux-python</li><li>Windows 不能作为主控端</li></ul><h2 id="3-Ansible-的安装和使用"><a href="#3-Ansible-的安装和使用" class="headerlink" title="3. Ansible 的安装和使用"></a>3. Ansible 的安装和使用</h2><h3 id="3-1-Ansbile-安装"><a href="#3-1-Ansbile-安装" class="headerlink" title="3.1. Ansbile 安装"></a>3.1. Ansbile 安装</h3><p>ansible 的安装方法有多种</p><h4 id="3-1-1-EPEL-yum-源安装"><a href="#3-1-1-EPEL-yum-源安装" class="headerlink" title="3.1.1. EPEL yum 源安装"></a>3.1.1. EPEL yum 源安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install ansible</span><br></pre></td></tr></table></figure><h4 id="3-1-2-编译安装"><a href="#3-1-2-编译安装" class="headerlink" title="3.1.2. 编译安装"></a>3.1.2. 编译安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum -y install python-jinja2 PyYAML python-paramiko python-babel \</span><br><span class="line"> python-crypto tar xf ansible-1.5.4.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ansible-1.5.4</span><br><span class="line">python setup.py build</span><br><span class="line">python setup.py install</span><br><span class="line"><span class="built_in">mkdir</span> /etc/ansible</span><br><span class="line"><span class="built_in">cp</span> -r examples/* /etc/ansible</span><br></pre></td></tr></table></figure><h4 id="3-1-3-Git-方式"><a href="#3-1-3-Git-方式" class="headerlink" title="3.1.3. Git 方式"></a>3.1.3. Git 方式</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">git <span class="built_in">clone</span> git://github.com/ansible/ansible.git --recursive</span><br><span class="line"><span class="built_in">cd</span> ./ansible</span><br><span class="line"><span class="built_in">source</span> ./hacking/env-setup</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="3-1-4-pip-安装"><a href="#3-1-4-pip-安装" class="headerlink" title="3.1.4. pip 安装"></a>3.1.4. pip 安装</h4><p>pip 是安装 Python 包的管理器, 类似 yum</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">yum install python-pip python-devel</span><br><span class="line">yum install gcc glibc-devel zibl-devel rpm-build openssl-devel</span><br><span class="line">pip install --upgrade pip</span><br><span class="line">pip install ansible --upgrade</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="3-1-5-确认安装"><a href="#3-1-5-确认安装" class="headerlink" title="3.1.5. 确认安装"></a>3.1.5. 确认安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible --version</span><br></pre></td></tr></table></figure><h4 id="3-1-6-Ansible-相关文件"><a href="#3-1-6-Ansible-相关文件" class="headerlink" title="3.1.6. Ansible 相关文件"></a>3.1.6. Ansible 相关文件</h4><h5 id="3-1-6-1-配置文件"><a href="#3-1-6-1-配置文件" class="headerlink" title="3.1.6.1. 配置文件"></a>3.1.6.1. 配置文件</h5><p>&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg 主配置文件, 配置 Ansible 工作特性<br>&#x2F;etc&#x2F;ansible&#x2F;hosts 主机清单<br>&#x2F;etc&#x2F;ansible&#x2F;roles&#x2F; 存放角色的目录</p><h5 id="3-1-6-2-Ansbile-主配置文件"><a href="#3-1-6-2-Ansbile-主配置文件" class="headerlink" title="3.1.6.2. Ansbile 主配置文件"></a>3.1.6.2. Ansbile 主配置文件</h5><p>Ansible 的配置文件&#x2F;etc&#x2F;ansible&#x2F;ansbile.cfg 其中大部分的配置内容无需进行修改</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[defaults]</span></span><br><span class="line"><span class="comment"># inventory = /etc/ansbile/hosts # 主机列表配置文件</span></span><br><span class="line"><span class="comment"># libaray = /usr/share/my_modules # 库文件存放位置</span></span><br><span class="line"><span class="comment"># remote_tmp = $HOME/.ansbile/tmp # 临时py命令文件存放在远程主机目录</span></span><br><span class="line"><span class="comment"># local_tmp = $HOME/.ansible/tmp # 本机的临时命令执行目录</span></span><br><span class="line"><span class="comment"># forks = 5 # 默认并发数</span></span><br><span class="line"><span class="comment"># sudo_user = root # 默认sudo用户</span></span><br><span class="line"><span class="comment"># ask_sudo_pass = True # 每次执行ansible命令是否询问ssh密码</span></span><br><span class="line"><span class="comment"># ssk_pass = True</span></span><br><span class="line"><span class="comment"># remote_port = 22</span></span><br><span class="line"><span class="comment"># host_key_checking = False # 检查对应服务器的host_key, 建议取消注释</span></span><br><span class="line"><span class="comment"># log_path=/var/log/ansible.log # 日志文件, 建议启用</span></span><br><span class="line"><span class="comment"># module_name = command # 默认模块, 可以修改为shell模块</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="3-1-6-3-ansible-cfg-文件的优先级顺序"><a href="#3-1-6-3-ansible-cfg-文件的优先级顺序" class="headerlink" title="3.1.6.3. ansible.cfg 文件的优先级顺序"></a>3.1.6.3. ansible.cfg 文件的优先级顺序</h5><p>ansible 获取 ansible.cfg 文件的优先级顺序</p><p>ansible 运行时会先检查 ansible 命令的目录中是否有 ansible.cfg 文件，如果不存在该文件，则检查用户的主目录（~&#x2F;）中是否有 ansible.cfg 文件，在找不到其他配置文件时，使用全局&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg 文件，如果都不存在，ansible 包含它使用的默认值。</p><p>使用 ANSIBLE_CONFIG 环境变量指定配置文件位置，而此时指定的任何文件将覆盖所有其他配置文件</p><h5 id="3-1-6-4-Inventory-主机清单"><a href="#3-1-6-4-Inventory-主机清单" class="headerlink" title="3.1.6.4. Inventory 主机清单"></a>3.1.6.4. Inventory 主机清单</h5><p>ansible 的主要功用在于批量主机操作, 为了便捷地使用其中的部分主机, 可以在 inventory file 中将其分组命名默认的 inventory file 为&#x2F;etc&#x2F;ansible&#x2F;hosts<br>inventory file 可以有多个, 且也可以通过 Dynamic Inventory 来动态生成</p><h6 id="3-1-6-4-1-主机清单文件格式"><a href="#3-1-6-4-1-主机清单文件格式" class="headerlink" title="3.1.6.4.1. 主机清单文件格式"></a>3.1.6.4.1. 主机清单文件格式</h6><p>inventory 文件遵循 INI 文件风格, 中括号中的字符为组名, 可以将同一个主机<br>同时归并到多个不同的组中,<br>此外, 当如若目标主机使用了非默认的 SSH 端口, 还可以在主机名称之后使用冒号加端口号来标明如果主机名称遵循相似的命名模式, 还可以使用列表的方式标识各主机</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># Ex 1: ungrouped hosts, specify before any group headers</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## green.example.com</span></span><br><span class="line"><span class="comment">## bluce.example.com</span></span><br><span class="line"><span class="comment">## 192.168.100.1</span></span><br><span class="line"><span class="comment">## 192.168.100.10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Ex 2: A collection of hosts belonging to the &#x27;webservers&#x27; group</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## [webservers]</span></span><br><span class="line"><span class="comment">## alpha.example.org</span></span><br><span class="line"><span class="comment">## beta.example.org</span></span><br><span class="line"><span class="comment">## 192.168.1.100</span></span><br><span class="line"><span class="comment">## 192.168.1.110</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If you have multiple hosts following a pattern you can specify</span></span><br><span class="line"><span class="comment"># them lik this:</span></span><br><span class="line"></span><br><span class="line"><span class="section">[dbservers]</span></span><br><span class="line"><span class="comment">## db-[99:101]-node.example.com</span></span><br><span class="line"><span class="comment">## db-[a:f].example.com</span></span><br><span class="line"></span><br><span class="line"><span class="section">[appservers]</span></span><br><span class="line">10.0.0.<span class="section">[1:100]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如何主机没有使用默认的22端口作为ssh的监听端口</span></span><br><span class="line"><span class="comment"># 定义host时可以指定其端口号</span></span><br><span class="line">www.example.com:2222</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="3-1-6-5-Ansible-相关工具"><a href="#3-1-6-5-Ansible-相关工具" class="headerlink" title="3.1.6.5. Ansible 相关工具"></a>3.1.6.5. Ansible 相关工具</h5><p>&#x2F;usr&#x2F;bin&#x2F;ansible 主程序, 临时命令执行工具<br>&#x2F;usr&#x2F;bin&#x2F;ansible-doc 查看配置文档, 模块功能查看工具<br>&#x2F;usr&#x2F;bin&#x2F;ansible-galaxy 下载&#x2F;上传优秀代码或 Roles 模块的官网平台<br>&#x2F;usr&#x2F;bin&#x2F;ansible-playbook 定制自动化任务, 编排剧本工具<br>&#x2F;usr&#x2F;bin&#x2F;ansible-pull 远程执行命令的工具<br>&#x2F;usr&#x2F;bin&#x2F;ansible-vault 文件加密工具<br>&#x2F;usr&#x2F;bin&#x2F;ansible-console 基于 Console 界面与用户交互的执行工具</p><h5 id="3-1-6-6-利用-ansible-实现管理的主要方式"><a href="#3-1-6-6-利用-ansible-实现管理的主要方式" class="headerlink" title="3.1.6.6. 利用 ansible 实现管理的主要方式"></a>3.1.6.6. 利用 ansible 实现管理的主要方式</h5><p>Ad-Hoc 即利用 Ansible 命令, 主要用于临时命令使用场景<br>Ansible-playbook 主要用于长期规划好的, 大型项目的场景, 需要有前期的规划过程</p><h5 id="3-1-6-7-ansible-doc"><a href="#3-1-6-7-ansible-doc" class="headerlink" title="3.1.6.7. ansible-doc"></a>3.1.6.7. ansible-doc</h5><p>此工具用来显示模块帮助<br>格式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ansible-doc [options] [module...]</span><br><span class="line">-l, --list   <span class="comment"># 列出可用模块</span></span><br><span class="line">-s, --snippet <span class="comment"># 显示指定模块的playbook片段</span></span><br></pre></td></tr></table></figure><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出所有模块</span></span><br><span class="line">ansible-doc -l</span><br><span class="line"><span class="comment"># 查看指定模块帮助用法</span></span><br><span class="line">ansible-doc ping</span><br><span class="line"><span class="comment"># 查看指定模块帮助用法</span></span><br><span class="line">ansible-doc -s ping</span><br></pre></td></tr></table></figure><h5 id="3-1-6-8-ansible-命令"><a href="#3-1-6-8-ansible-命令" class="headerlink" title="3.1.6.8. ansible 命令"></a>3.1.6.8. ansible 命令</h5><p>此工具通过 ssh 协议, 实现对远程主机的配置管理, 应用部署, 任务执行等功能<br>建议: 使用此工具前, 先配置 ansible 主控端能基于密钥认证的方式联系各个被管理节点</p><p>范例: 利用 sshpass 批量实现基于 key 验证</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -f /root/.ssh/id_rsa -P <span class="string">&#x27;&#x27;</span></span><br><span class="line">NET=192.168.100</span><br><span class="line"><span class="built_in">export</span> SSHPASS=<span class="built_in">test</span></span><br><span class="line"><span class="keyword">for</span> IP <span class="keyword">in</span> (1..200); <span class="keyword">do</span></span><br><span class="line">  sshpass -e ssh-copy-id <span class="variable">$NET</span>.<span class="variable">$IP</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>格式:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ansible &lt;host-pattern&gt; [-m module_name] [-a args]</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>选项说明</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">--version <span class="comment"># 显示版本号</span></span><br><span class="line">-m module <span class="comment"># 指定模块, 默认为command</span></span><br><span class="line">-v        <span class="comment"># 详细过程 -vv -vvv更详细</span></span><br><span class="line">--list-hosts  <span class="comment"># 显示主机列表, 可简写 --list</span></span><br><span class="line">-k, --ask-pass <span class="comment"># 提升输入ssh连接密码, 默认是key验证</span></span><br><span class="line">-C, --check   <span class="comment"># 检查, 并不执行</span></span><br><span class="line">-T --<span class="built_in">timeout</span>=TIMEOUT <span class="comment">#执行命令的超时时间, 默认10s</span></span><br><span class="line">-u --user=REMOT_USER <span class="comment"># 执行远程执行的用户</span></span><br><span class="line">-b, --become   <span class="comment"># 代替旧版的sudo切换</span></span><br><span class="line">--become-user=USERNAME <span class="comment">#指定sudo的runas用户, 默认root</span></span><br><span class="line">-K, --ask-become-pass <span class="comment"># 提示输入sudo时的口令</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="3-1-6-9-ansible-pull"><a href="#3-1-6-9-ansible-pull" class="headerlink" title="3.1.6.9. ansible-pull"></a>3.1.6.9. ansible-pull</h5><p>此工具会推送 ansible 的命令至远程, 效率无限提升, 对运维要求较高.</p><h5 id="3-1-6-10-ansible-playbook"><a href="#3-1-6-10-ansible-playbook" class="headerlink" title="3.1.6.10. ansible-playbook"></a>3.1.6.10. ansible-playbook</h5><p>此工具用于执行编写好的 playbook 任务</p><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook hello.yml</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> hello.yml</span><br><span class="line">---</span><br><span class="line"><span class="comment">#hello world from yml file</span></span><br><span class="line">- hosts: websrvs</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello world</span><br><span class="line">      <span class="built_in">command</span>: /usr/bin/wall hello world</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="3-1-6-11-ansible-valt"><a href="#3-1-6-11-ansible-valt" class="headerlink" title="3.1.6.11. ansible-valt"></a>3.1.6.11. ansible-valt</h5><p>此工具可用于加密解密 yml 文件</p><p>格式:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-vault [create|decrypt|edit|encrypt|rekey|view]</span><br></pre></td></tr></table></figure><p>范例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ansible-vault encrypt hello.yml <span class="comment"># 加密</span></span><br><span class="line">ansible-vault decrypt hello.yml <span class="comment"># 解密</span></span><br><span class="line">ansible-vault view hello.yml</span><br><span class="line">ansible-vault edit hello.yml</span><br><span class="line">ansible-vault rekey hello.yml</span><br><span class="line">ansible-vault create hello.yml</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="3-1-6-12-ansible-console"><a href="#3-1-6-12-ansible-console" class="headerlink" title="3.1.6.12. ansible-console"></a>3.1.6.12. ansible-console</h5><p>此工具是可交互执行命令, 支持 tab, ansible 2.0+新增</p><p>提示符格式:</p><p>执行用户@当前操作的主机组(当前的主机数量)[f:并发数]$</p><p>常用子命令:</p><p>设置并发数: forks n 例如: forks 10<br>切换组: cd 主机组 例如: cd web<br>列出当前组主机列表: list<br>列出所有的内置命令: ?或 help</p><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">root@all (2)[f:5]$ list</span><br><span class="line">root@all (2)[f:5]$ <span class="built_in">cd</span> appsrvs</span><br><span class="line">root@all (2)[f:5]$ list</span><br><span class="line">root@all (2)[f:5]$ yum name=httpd state=present</span><br><span class="line">root@all (2)[f:5]$ service name=httpd state=started</span><br><span class="line">root@all (2)[f:5]$ forks 10</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="3-1-7-Ansible-常用模块"><a href="#3-1-7-Ansible-常用模块" class="headerlink" title="3.1.7. Ansible 常用模块"></a>3.1.7. Ansible 常用模块</h4><p>2015 年底 270 多个模块, 2016 年达到 540 个, 2018 年 01 月 12 日 1378 个模块, 2018 年 07 月 15 日 1852 个模块, 2019 年 5 月 25 日(ansible 2.7.10)时 2080 个, 2020 年 0302 日有 3387 个模块</p><p>虽然模块众多, 但常用的模块也就 2,30 个而已, 针对特定业务只有 10 几个模块</p><p>常用模块帮助文档参考:</p><p><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/modules/modules_by_category.html">https://docs.ansible.com/ansible/latest/modules/modules_by_category.html</a></p><h5 id="3-1-7-1-Command-模块"><a href="#3-1-7-1-Command-模块" class="headerlink" title="3.1.7.1. Command 模块"></a>3.1.7.1. Command 模块</h5><p>功能: 在远程主机执行命令, 此为默认模块, 可忽略-m 选项<br>注意: 此命令不支持 $VARNAME &lt;&gt; | ; &amp; 等, 用 shell 模块实现</p><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ansible srvs -m <span class="built_in">command</span> -a <span class="string">&#x27;service vsftpd start&#x27;</span></span><br><span class="line">ansible srvs -m <span class="built_in">command</span> -a <span class="string">&#x27;echo hello world | passwd -stdin user_name&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看操作系统版本</span></span><br><span class="line">ansible srvs -m <span class="built_in">command</span> -a <span class="string">&#x27;cat /etc/centos-release&#x27;</span></span><br><span class="line">ansible srvs -m <span class="built_in">command</span> -a <span class="string">&#x27;chdir=/etc cat centos-release&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="3-1-7-2-shell-模块"><a href="#3-1-7-2-shell-模块" class="headerlink" title="3.1.7.2. shell 模块"></a>3.1.7.2. shell 模块</h5><p>功能: 和 command 相似, 用 shell 执行命令<br>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ansible srv -m shell -a <span class="string">&#x27;echo test | passwd -stdin wang&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>注意: 调用 bash 执行命令, 类似 cat &#x2F;tmp&#x2F;test&#x2F;md | awk -F ‘|’ ‘{print 1,2}’ &amp;&gt; &#x2F;tmp&#x2F;example.txt 这些复杂命令, 即使使用 shell 也可能会失效, 解决办法: 写到脚本时, copy 到远程, 执行, 再把需要的结果拉回执行命令的机器</p><p>范例: 将 shell 模块代替 command, 设为默认模块</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/ansible/ansible.cfg</span><br><span class="line"><span class="comment">#修改下面一行</span></span><br><span class="line">module_name = shell</span><br></pre></td></tr></table></figure><h5 id="3-1-7-3-script-模块"><a href="#3-1-7-3-script-模块" class="headerlink" title="3.1.7.3. script 模块"></a>3.1.7.3. script 模块</h5><p>功能: 再远程主机上运行 ansible 服务器上的脚本</p><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible websrvs -m script -a /data/test.sh</span><br></pre></td></tr></table></figure><h5 id="3-1-7-4-copy-模块"><a href="#3-1-7-4-copy-模块" class="headerlink" title="3.1.7.4. copy 模块"></a>3.1.7.4. copy 模块</h5><p>功能: 从 ansible 服务器主控端复制文件到远程主机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如目标存在, 默认覆盖, 此处指定先备份</span></span><br><span class="line">ansible srv -m copy -a <span class="string">&quot;src=/root/test1.sh dest=/tmp/test2.sh owner=test mode=600 backup=yes&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定内容, 直接生成目标文件</span></span><br><span class="line">ansible srv -m copy -a <span class="string">&quot;content=&#x27;test content\n&#x27; dest=/tmp/test.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制/etc/下的文件, 不包括/etc/目录本身</span></span><br><span class="line">ansible srv -m copy -a <span class="string">&quot;src=/etc/ dest=/backup&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="3-1-7-5-fetch-模块"><a href="#3-1-7-5-fetch-模块" class="headerlink" title="3.1.7.5. fetch 模块"></a>3.1.7.5. fetch 模块</h5><p>功能: 从远程主机拷贝文件到 ansible 的主控端, 与 copy 相反, 目前不支持目录</p><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible srv -m fetch -a <span class="string">&quot;src=/root/test.sh dest=/data/scripts&quot;</span></span><br></pre></td></tr></table></figure><h5 id="3-1-7-6-File-模块"><a href="#3-1-7-6-File-模块" class="headerlink" title="3.1.7.6. File 模块"></a>3.1.7.6. File 模块</h5><p>功能: 设置文件属性</p><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建空文件</span></span><br><span class="line"></span><br><span class="line">ansible srv -m file -a <span class="string">&#x27;path=/data/test.txt state=touch&#x27;</span></span><br><span class="line">ansible srv -m file -a <span class="string">&#x27;path=/data/test.txt state=absent&#x27;</span></span><br><span class="line">ansible srv -m file -a <span class="string">&#x27;path=/data/test.txt owner=wang mode=755&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line">ansible srv -m file -a <span class="string">&#x27;path=/data/mysql state=directory owner=mysql group=mysql&#x27;</span></span><br><span class="line"><span class="comment"># 创建软连接</span></span><br><span class="line">ansible srv -m file -a <span class="string">&#x27;src=/data/testfile dest=/data/testfile-link state=link&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="3-1-7-7-unarchieve-模块"><a href="#3-1-7-7-unarchieve-模块" class="headerlink" title="3.1.7.7. unarchieve 模块"></a>3.1.7.7. unarchieve 模块</h5><p>功能: 解包解压缩</p><p>实现有两种用法:</p><ol><li>将 ansible 主机上的压缩包传到远程主机后解压缩至特定目录, 设置 copy&#x3D;yes</li><li>将远程主机上的某个压缩包解压缩到指定路径下, 设置 copy&#x3D;no</li></ol><p>常见参数:</p><p>copy: 默认为 yes, 当 copy&#x3D;yes, 拷贝的文件是从 ansible 主机复制到远程主机上, 如果没有设置为 copy&#x3D;no, 会在主机上寻找 src 源文件<br>remote_src: 和 copy 功能一样且互斥, yes 表示在远程主机, 不在 ansible 主机, no 表示文件在 ansible 主机上<br>src: 源路径, 可以是 ansible 主机上的路径, 也可以是远程主机上的路径, 如果是远程主机上的路径, 则需要设置 copy&#x3D;no</p><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible srv -m unarchive -a <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure><h5 id="3-1-7-8-archive-模块"><a href="#3-1-7-8-archive-模块" class="headerlink" title="3.1.7.8. archive 模块"></a>3.1.7.8. archive 模块</h5><p>功能: 打包压缩</p><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ansible websrvs -m archive -a <span class="string">&quot;path=/var/log/ dest=/data/log.tar.bz2 format=bz2 owner=wang mode=0600&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="3-1-7-9-Hostname-模块"><a href="#3-1-7-9-Hostname-模块" class="headerlink" title="3.1.7.9. Hostname 模块"></a>3.1.7.9. Hostname 模块</h5><p>功能: 管理主机名</p><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ansible node1 -m hostname -a <span class="string">&quot;name=websrv&quot;</span></span><br><span class="line">ansible 192.168.100.18 -m hostname -a <span class="string">&#x27;name=node18&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="3-1-7-10-Cron-模块"><a href="#3-1-7-10-Cron-模块" class="headerlink" title="3.1.7.10. Cron 模块"></a>3.1.7.10. Cron 模块</h5><p>功能: 计划任务<br>支持时间: minute, hour, day, month, weekday</p><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份数据库脚本</span></span><br><span class="line"><span class="comment">#cat mysql_backup.sh</span></span><br><span class="line">mysqldump -A -F --single-transaction --master-data=2 -q -uroot | gzip &gt;mysql_`<span class="built_in">date</span> +%F_%T`.sql.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建任务</span></span><br><span class="line">ansible dbsrv -m cron -a <span class="string">&#x27;hour=2 minute=30 weekday=1-5 name=&quot;backup mysql&quot; job=/root/mysql_backup.sh&#x27;</span></span><br><span class="line"></span><br><span class="line">ansible srv -m cron -a <span class="string">&#x27;minute=/5 job=/usr/sbin/ntupdate 172.20.0.1 &amp;&gt;/dev/null name=Synctime&#x27;</span></span><br><span class="line"><span class="comment"># 禁用计划任务</span></span><br><span class="line">ansible srv -m cron -a <span class="string">&#x27;minute=/5 job=/usr/sbin/ntupdate 172.20.0.1 &amp;&gt;/dev/null name=Synctime disabled=yes&#x27;</span></span><br><span class="line"><span class="comment"># 启用计划任务</span></span><br><span class="line">ansible srv -m cron -a <span class="string">&#x27;minute=/5 job=/usr/sbin/ntupdate 172.20.0.1 &amp;&gt;/dev/null name=Synctime disabled=no&#x27;</span></span><br><span class="line"><span class="comment"># 删除计划任务</span></span><br><span class="line">ansible srv -m cron -a <span class="string">&#x27;name=Synctime state=absent&#x27;</span></span><br><span class="line">ansible srv -m cron -a <span class="string">&#x27;name=&quot;backup mysql&quot; state=absent&#x27;</span></span><br></pre></td></tr></table></figure><h5 id="3-1-7-11-Yum-模块"><a href="#3-1-7-11-Yum-模块" class="headerlink" title="3.1.7.11. Yum 模块"></a>3.1.7.11. Yum 模块</h5><p>功能: 管理软件包</p><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ansible srv -m yum -a <span class="string">&#x27;name=httpd state=present&#x27;</span> <span class="comment"># 安装</span></span><br><span class="line">ansible srv -m yum -a <span class="string">&#x27;name=httpd state=absent&#x27;</span>  <span class="comment"># 删除</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="3-1-7-12-Service-模块"><a href="#3-1-7-12-Service-模块" class="headerlink" title="3.1.7.12. Service 模块"></a>3.1.7.12. Service 模块</h5><p>功能: 管理服务</p><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ansible srv -m service -a <span class="string">&#x27;name=httpd state=started enable=yes&#x27;</span></span><br><span class="line">ansible srv -m service -a <span class="string">&#x27;name=httpd state=stopped&#x27;</span></span><br><span class="line">ansible srv -m service -a <span class="string">&#x27;name=httpd state=reloaded&#x27;</span></span><br><span class="line">ansible srv -m shell -a <span class="string">&quot;sed -i &#x27;s/^Listen 80/Listen 8080/&#x27; /etc/httpd/conf/httpd.conf&quot;</span></span><br><span class="line">ansible srv -m service -a <span class="string">&#x27;name=httpd state=restarted&#x27;</span></span><br></pre></td></tr></table></figure><h5 id="3-1-7-13-User-模块"><a href="#3-1-7-13-User-模块" class="headerlink" title="3.1.7.13. User 模块"></a>3.1.7.13. User 模块</h5><p>功能: 管理用户<br>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 创建用户</span></span><br><span class="line">ansible srv -m user -a <span class="string">&#x27;name=user1 comment=&quot;test user&quot; uid=2048 home=/app/user1 group=root&#x27;</span></span><br><span class="line">ansible srv -m user -a <span class="string">&#x27;name=nginx comment=nginx uid=88 group=&quot;root, deamon&quot; shell=/sbin/nologin system=yes create_home=no home=/data/nginx non_unique=yes&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除用户及家目录等数据</span></span><br><span class="line">ansible srv -m user -a <span class="string">&#x27;name=nginx state=absent remove=yes&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="3-1-7-14-Group-模块"><a href="#3-1-7-14-Group-模块" class="headerlink" title="3.1.7.14. Group 模块"></a>3.1.7.14. Group 模块</h5><p>功能: 管理组</p><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 创建组</span></span><br><span class="line">ansible websrvs -m group -a <span class="string">&#x27;name=nginx gid=88 system=yes&#x27;</span></span><br><span class="line"><span class="comment"># 删除组</span></span><br><span class="line">ansible websrvs -a group -a <span class="string">&#x27;name=nginx state=absent&#x27;</span></span><br></pre></td></tr></table></figure><h5 id="3-1-7-15-Lineinfile-模块"><a href="#3-1-7-15-Lineinfile-模块" class="headerlink" title="3.1.7.15. Lineinfile 模块"></a>3.1.7.15. Lineinfile 模块</h5><p>ansible 在使用 sed 进行替换时, 经常会遇到需要转义的问题, 而且 ansible 在遇到特殊符号进行替换时, 存在问题, 无法正常进行替换, 其实在 ansible 自身提供了两个模块: lineinfile 模块和 replace 模块, 可以方便地进行替换</p><p>功能: 相当于 sed, 可以修改文件内容</p><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible all -m lineinfile -a <span class="string">&quot;path=/etc/selinux/config regexp=&#x27;^SELINUX=&#x27; line=&#x27;SELINUX=enforcing&#x27;&quot;</span></span><br><span class="line">ansible all -m lineinfile -a <span class="string">&#x27;dest=/etc/fstab state=absent regexp=&quot;^#&quot;&#x27;</span></span><br></pre></td></tr></table></figure><h5 id="3-1-7-16-Replace-模块"><a href="#3-1-7-16-Replace-模块" class="headerlink" title="3.1.7.16. Replace 模块"></a>3.1.7.16. Replace 模块</h5><p>该模块有点类似于 sed 命令, 主要也是基于正则进行匹配和替换</p><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 将以UUID开头的行注释掉, \1表示正则表达式匹配的内容</span></span><br><span class="line">ansible all -m replace -a <span class="string">&quot;path=/etc/fstab regexp=&#x27;^(UUID.*)&#x27; replace=&#x27;#\1&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 恢复以上操作</span></span><br><span class="line">ansible all -m replace -a <span class="string">&quot;path=/etc/fstab regexp=&#x27;^#(UUID.*)&#x27; replace=&#x27;\1&#x27;&quot;</span></span><br></pre></td></tr></table></figure><h5 id="3-1-7-17-Setup-模块"><a href="#3-1-7-17-Setup-模块" class="headerlink" title="3.1.7.17. Setup 模块"></a>3.1.7.17. Setup 模块</h5><p>功能: setup 模块来收集主机的系统信息, 这些 facts 信息可以直接以变量的形式使用, 但是如果主机较多, 会影响执行速度, 可以使用 gather_facts: no 来禁止收集 facts 信息</p><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ansible srv -m setup</span><br><span class="line">ansible srv -m setup -a <span class="string">&quot;filter=ansible_nodename&quot;</span></span><br><span class="line">ansible srv -m setup -a <span class="string">&quot;filter=ansible_hostname&quot;</span></span><br><span class="line">ansible srv -m setup -a <span class="string">&quot;filter=ansible_domain&quot;</span></span><br><span class="line">ansible srv -m setup -a <span class="string">&quot;filter=ansible_memtotal_mb&quot;</span></span><br><span class="line">ansible srv -m setup -a <span class="string">&quot;filter=ansible_memory_mb&quot;</span></span><br><span class="line">ansible srv -m setup -a <span class="string">&quot;filter=ansible_memfree_mb&quot;</span></span><br><span class="line">ansible srv -m setup -a <span class="string">&quot;filter=ansible_os_family&quot;</span></span><br><span class="line">ansible srv -m setup -a <span class="string">&quot;filter=ansible_distribution_major_version&quot;</span></span><br><span class="line">ansible srv -m setup -a <span class="string">&quot;filter=ansible_distribution_version&quot;</span></span><br><span class="line">ansible srv -m setup -a <span class="string">&quot;filter=ansible_processor_vcpus&quot;</span></span><br><span class="line">ansible srv -m setup -a <span class="string">&quot;filter=ansible_all_ipv4_addresses&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用通配符</span></span><br><span class="line">ansible srv -m setup -a <span class="string">&quot;filter=ansible_processor_*&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="4-Playbook"><a href="#4-Playbook" class="headerlink" title="4. Playbook"></a>4. Playbook</h2><h3 id="4-1-playbook-介绍"><a href="#4-1-playbook-介绍" class="headerlink" title="4.1. playbook 介绍"></a>4.1. playbook 介绍</h3><p>playbook 剧本是由一个或多个 play 组成的列表</p><p>play 的主要功能在于将预定义的一组主机, 装扮成事先通过 ansible 中的 task 定义好的角色. Task 实际是用 ansible 的一个 module, 将多个 play 组织在一个 playbook 中, 即可以让它们联合起来, 按事先编排的机制执行预定义的动作</p><p>playbook 文件是采用 YAML 语言编写的</p><h3 id="4-2-YAML-语言"><a href="#4-2-YAML-语言" class="headerlink" title="4.2. YAML 语言"></a>4.2. YAML 语言</h3><h4 id="4-2-1-YAML-语言介绍"><a href="#4-2-1-YAML-语言介绍" class="headerlink" title="4.2.1. YAML 语言介绍"></a>4.2.1. YAML 语言介绍</h4><p>YAML 是一个可读性高的用来表达资料序列的格式. YAML 参考了其他多种语言,包括: XML, C 语言, Python, Perl 以及电子邮件格式 RFC2822 等. Clark Evans 在 2001 年首次发表了这种语言, 另外 Ingy dot net 与 Oren Ben-kiki 是这种语言的共同设计者, 目前很多软件中采用此格式的文件, 如 ubuntu, ansible, docker, k8s 等.<br>YAML: YAML aint markup language, 即 YAML 不是标记语言, 不过, 在开发这种语言时, YAML 的意思其实是: “Yet Another Markup Language” (仍是一种标记语言)</p><p>YAML 官方网站: <a target="_blank" rel="noopener" href="http://www.yaml.org/">http://www.yaml.org</a></p><h4 id="4-2-2-YAML-语言特性"><a href="#4-2-2-YAML-语言特性" class="headerlink" title="4.2.2. YAML 语言特性"></a>4.2.2. YAML 语言特性</h4><p>YAML 的可读性好<br>YAML 和脚本语言的交互性好<br>YAML 使用实现语言的数据类型<br>YAML 有一个一致的信息模型<br>YAML 易于实现<br>YAML 可以基于流来处理<br>YAML 表达能力强, 扩展性好</p><h4 id="4-2-3-YAML-语法简介"><a href="#4-2-3-YAML-语法简介" class="headerlink" title="4.2.3. YAML 语法简介"></a>4.2.3. YAML 语法简介</h4><p>在单一文件第一行, 用连续三个连字号”-“开始, 还有选择性的连续三个点号(…)用来表示文件的结束<br>次行开始正常写 playbook 的内容, 一般建议写明该 playbook 的功能<br>使用#号注释代码<br>缩进必须是统一的, 不能空格和 tab 混合使用<br>缩进的级别也必须是一致的, 同样的缩进代表同样的级别, 程序判别配置的级别是通过缩进结合换行来实现的, YAML 文件内容是区分大小写的, key&#x2F;value 的值均需要大小写敏感<br>多个 k&#x2F;v 可同行写也可换行写, 同行使用,分割<br>v 可是个字符串, 也可是另一个列表<br>一个完整的代码块功能需最少元素需包括 name 和 task<br>一个 name 只能包括一个 task<br>YAML 文件扩展名通常为 yml 或 yaml</p><p>YAML 的语法和其他高阶语言类似, 并且可以简单表达清单, 散列表, 标量等数据结构, 其结构(structure)通过空格来展示, 序列(sequence)里的项用”-“来代表, Map 里的键值对用”:”分割, 下面介绍常用的数据结构.</p><h5 id="4-2-3-1-List-列表"><a href="#4-2-3-1-List-列表" class="headerlink" title="4.2.3.1. List 列表"></a>4.2.3.1. List 列表</h5><p>列表由多个元素组成, 且所有元素前均使用”-“打头</p><p>范例:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A list of tasty fruits</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Apple</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Orange</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Strawberry</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">Mango</span></span><br><span class="line"></span><br><span class="line">[<span class="string">Apply</span>, <span class="string">Orange</span>, <span class="string">Strawberry</span>, <span class="string">Mango</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="4-2-3-2-Dictionary-字典"><a href="#4-2-3-2-Dictionary-字典" class="headerlink" title="4.2.3.2. Dictionary 字典"></a>4.2.3.2. Dictionary 字典</h5><p>字典通常由多个 key 与 value 构成</p><p>范例:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># An example record</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">Example</span> <span class="string">Developer</span></span><br><span class="line"><span class="attr">job:</span> <span class="string">Developer</span></span><br><span class="line"><span class="attr">skill:</span> <span class="string">Elite</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以将key:value置于&#123;&#125;中进行表示, 用,分割多个key:value</span></span><br><span class="line"><span class="comment"># An example record</span></span><br><span class="line">&#123;<span class="attr">name:</span> <span class="string">&quot;Example developer&quot;</span>, <span class="attr">job:</span> <span class="string">&quot;developer&quot;</span>, <span class="attr">skill:</span> <span class="string">&quot;Elite&quot;</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-3-Playbook-核心元素"><a href="#4-3-Playbook-核心元素" class="headerlink" title="4.3. Playbook 核心元素"></a>4.3. Playbook 核心元素</h3><p>Hosts 执行的远程主机列表<br>Tasks 任务集<br>Variable 内置变量或自定义变量在 playbook 中调用<br>Templates 模板, 可替换模板文件中的变量并实现一些简单逻辑的文件<br>Handler 和 Notify 结合使用, 由特定条件触发的操作, 满足条件方才执行, 否则不执行<br>tags 标签, 指定某条任务执行, 用于选择运行 playbook 中的部分代码, ansible 具有幂等性, 因此会自动跳过没有变化的部分, 即便如此, 有些代码为测试其确实没有发生变化的时间依然会非常地长, 此时如果确信没有变化, 就可以通过 tags 跳过此些代码片段</p><h4 id="4-3-1-hosts-组件"><a href="#4-3-1-hosts-组件" class="headerlink" title="4.3.1. hosts 组件"></a>4.3.1. hosts 组件</h4><p>Hosts: playbook 中的每一个 play 的目的都是为了让特定主机以某个指定的用户身份执行任务. hosts 用于指定要执行指定任务的主机, 须事先定义在主机清单中</p><p>案例</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs:appsrvs</span></span><br></pre></td></tr></table></figure><h4 id="4-3-2-remote-user-组件"><a href="#4-3-2-remote-user-组件" class="headerlink" title="4.3.2. remote_user 组件"></a>4.3.2. remote_user 组件</h4><p>remote_user: 可用于 host 和 task 中, 也可以通过指定其通过 sudo 的方式在远程主机上执行任务, 其可用于 play 全局或某个任务; 此外, 甚至可以在 sudo 时使用 sudo_user 指定 sudo 时切换的用户</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span> <span class="string">connection</span></span><br><span class="line">      <span class="attr">ping:</span></span><br><span class="line">      <span class="attr">remote_user:</span> <span class="string">test_user</span></span><br><span class="line">      <span class="attr">sudo:</span> <span class="literal">yes</span> <span class="comment"># 默认sudo为root</span></span><br><span class="line">      <span class="attr">sudo_user:</span> <span class="string">wang</span> <span class="comment"># sudo为wang</span></span><br></pre></td></tr></table></figure><h4 id="4-3-3-task-列表和-action-组件"><a href="#4-3-3-task-列表和-action-组件" class="headerlink" title="4.3.3. task 列表和 action 组件"></a>4.3.3. task 列表和 action 组件</h4><p>play 的主体部分是 task list, task list 中有一个或多个 task, 各个 task 按次序逐个在 hosts 中指定的所有主机上执行, 即在所有主机上完成第一个 task 后, 再开始第二个 task.<br>task 的目的是使用指定的参数执行模块, 而再模块参数中可以使用变量. 模块执行是幂等的, 这意味着多次执行是安全的, 因为其结果均一致.<br>每个 task 都应该有其 name, 用于 playbook 的执行结果输出, 建议其内容能清晰地描述任务执行步骤. 如果未提供 name, 则 action 的结果将用于输出</p><p>task 两种格式</p><p>(1) action: moudule arguments<br>(2) module: arguments 建议使用</p><p>注意: shell 和 command 模块后面跟命令, 而非 key&#x3D;value</p><p>范例:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=httpd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">start=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure><h4 id="4-3-4-其它组件"><a href="#4-3-4-其它组件" class="headerlink" title="4.3.4. 其它组件"></a>4.3.4. 其它组件</h4><p>某任务的状态在运行后为 changed 时, 可以通过 notify 通知给相应的 handlers 任务可以通过 tags 打标签, 可在 ansible-playbook 命令上使用-t 指定进行调用</p><h4 id="4-3-5-ShellScript-VS-Playbook-案例"><a href="#4-3-5-ShellScript-VS-Playbook-案例" class="headerlink" title="4.3.5. ShellScript VS Playbook 案例"></a>4.3.5. ShellScript VS Playbook 案例</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SHELL脚本实现</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 安装apache</span></span><br><span class="line">yum install --quiet -y httpd</span><br><span class="line"><span class="comment"># 复制配置文件</span></span><br><span class="line"><span class="built_in">cp</span> /tmp/httpd.conf /etc/httpd/conf/httpd.conf</span><br><span class="line"><span class="built_in">cp</span> /tmp/vhosts.conf /etc/httpd/conf.d/</span><br><span class="line">systemctl <span class="built_in">enable</span> --now httpd</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>playbook 实现</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;安装Apache&quot;</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=httpd</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;复制配置文件&quot;</span></span><br><span class="line">      <span class="attr">copy:</span> <span class="string">src=/tmp/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;复制配置文件&quot;</span></span><br><span class="line">      <span class="attr">copy:</span> <span class="string">src=/tmp/vhosts.conf</span> <span class="string">dest=/etc/httpd/conf.d/</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;启动Apache, 并设置开机启动&quot;</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure><h3 id="4-4-playbook-命令"><a href="#4-4-playbook-命令" class="headerlink" title="4.4. playbook 命令"></a>4.4. playbook 命令</h3><p>格式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook &lt;filename.yml&gt; ... [options]</span><br></pre></td></tr></table></figure><p>常见选项:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">--check -C <span class="comment"># 只检查可能发生的改变, 但不真正执行操作</span></span><br><span class="line">--list-hosts <span class="comment"># 列出运行任务的主机</span></span><br><span class="line">--list-tags  <span class="comment"># 列出tag</span></span><br><span class="line">--list-tasks <span class="comment"># 列出task</span></span><br><span class="line">--<span class="built_in">limit</span> 主机列表 <span class="comment"># 只针对列表中的主机执行</span></span><br><span class="line">-v -vv -vvv   <span class="comment"># 显示过程</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>范例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ansible-playbook file.yml --check <span class="comment">#只检测</span></span><br><span class="line">ansible-playbook file.yml</span><br><span class="line">ansible-playbook file.yml --<span class="built_in">limit</span> websrvs</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-5-Playbook-初步"><a href="#4-5-Playbook-初步" class="headerlink" title="4.5. Playbook 初步"></a>4.5. Playbook 初步</h3><h4 id="4-5-1-利用-playbook-创建-mysql-用户"><a href="#4-5-1-利用-playbook-创建-mysql-用户" class="headerlink" title="4.5.1. 利用 playbook 创建 mysql 用户"></a>4.5.1. 利用 playbook 创建 mysql 用户</h4><p>范例: mysql_user.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">dbsrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span> <span class="comment"># 不收集主机信息</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">create</span> <span class="string">group</span>, <span class="attr">group:</span> <span class="string">name=mysql</span> <span class="string">system=yes</span> <span class="string">gid=306</span> &#125;</span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=mysql</span> <span class="string">shell=/sbin/nologin</span> <span class="string">system=yes</span> <span class="string">group=mysql</span> <span class="string">uid=306</span> <span class="string">home=/data/mysql</span> <span class="string">create_home=no</span></span><br></pre></td></tr></table></figure><h4 id="4-5-2-利用-playbook-安装-nginx"><a href="#4-5-2-利用-playbook-安装-nginx" class="headerlink" title="4.5.2. 利用 playbook 安装 nginx"></a>4.5.2. 利用 playbook 安装 nginx</h4><p>范例: install_nginx.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install nginx</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gater_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">group</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span> <span class="string">page</span></span><br><span class="line">      <span class="attr">copy:</span> <span class="string">src=files/index.html</span> <span class="string">dest=/usr/share/nginx/html/index.html</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure><h4 id="4-5-3-利用-playbook-安装和卸载-httpd"><a href="#4-5-3-利用-playbook-安装和卸载-httpd" class="headerlink" title="4.5.3. 利用 playbook 安装和卸载 httpd"></a>4.5.3. 利用 playbook 安装和卸载 httpd</h4><p>范例: install_httpd.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># install httpd</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">copy:</span> <span class="string">src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure><p>范例: remove_httpd.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">remove</span> <span class="string">httpd</span> <span class="string">package</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=absent</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">remove</span> <span class="string">apache</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=apache</span> <span class="string">state=absent</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">remove</span> <span class="string">data</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">name=/etc/httpd</span> <span class="string">state=absent</span></span><br></pre></td></tr></table></figure><h4 id="4-5-4-利用-playbook-安装-mysql"><a href="#4-5-4-利用-playbook-安装-mysql" class="headerlink" title="4.5.4. 利用 playbook 安装 mysql"></a>4.5.4. 利用 playbook 安装 mysql</h4><p>范例: 安装 mysql-5.6.46-linux-glibc2.12</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">packages</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=libaio,perl-Data-Dumper,per-Getopt-Long</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">mysql</span> <span class="string">group</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">name=mysql</span> <span class="string">gid=306</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">mysql</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=mysql</span> <span class="string">uid=306</span> <span class="string">group=mysql</span> <span class="string">shell=/sbin/nologin</span> <span class="string">system=yes</span> <span class="string">create_home=no</span> <span class="string">home=/data/mysql</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">tar</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">host</span> <span class="string">and</span> <span class="string">file</span> <span class="string">mode</span></span><br><span class="line">      <span class="attr">unarchive:</span> <span class="string">src=/data/ansible/files/mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz</span> <span class="string">dest=/usr/local/</span> <span class="string">owner=root</span> <span class="string">group=root</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">crate</span> <span class="string">link</span> <span class="string">/usr/local/mysql</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">src=/usr/local/mysql-5.6.46-linux-glibc2.12-x86_64</span> <span class="string">dest=/usr/local/mysql</span> <span class="string">state=link</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span> <span class="string">dir</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">chdir=/usr/local/mysql/</span> <span class="string">./script/mysql_install_db</span> <span class="string">--datadir=/data/mysql</span> <span class="string">--</span> <span class="string">user=mysql</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">data</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span> <span class="string">my.conf</span></span><br><span class="line">      <span class="attr">copy:</span> <span class="string">src=/data/ansible/files/my.conf</span> <span class="string">dest=/etc/my.cnf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">service</span> <span class="string">script</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">/bin/cp</span> <span class="string">/usr/local/mysql/support-files/mysql.server</span> <span class="string">/etc/init.d/mysqld</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">enable</span> <span class="string">service</span></span><br><span class="line">      <span class="attr">shell: /etc/init.d/mysqld start:</span> <span class="string">chkconfig</span> <span class="string">--add</span> <span class="string">mysqld;</span> <span class="string">chkconfig</span> <span class="string">mysql</span> <span class="string">on</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">service</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PATH</span> <span class="string">variable</span></span><br><span class="line">      <span class="attr">copy:</span> <span class="string">content=&#x27;PATH=/usr/local/mysql/bin:$PATH&#x27;</span> <span class="string">dest=/etc/profile.d/mysql.sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secure</span> <span class="string">script</span></span><br><span class="line">      <span class="attr">script:</span> <span class="string">/data/ansible/files/secure_mysql.sh</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">script</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-6-Playbook-中使用-handlers-和-notify"><a href="#4-6-Playbook-中使用-handlers-和-notify" class="headerlink" title="4.6. Playbook 中使用 handlers 和 notify"></a>4.6. Playbook 中使用 handlers 和 notify</h3><p>Handlers 本质是 task list, 类似于 mysql 中的触发器触发行为, 其中的 task 与前述的 task 并没有本质上的不同, 主要用于当关注的资源发生变化时, 才会采取一定的操作, 而 Notify 对应的 action 可用于在每个 play 的最后触发, 这样可以避免多次有改变发生时每次都执行指定的操作, 尽在所有的变化发生完成后一次性地执行指定操作. 在 notify 中列出的操作称为 handler, 也即 notify 中调用 handler 中定义的操作</p><p>案例:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">copy:</span> <span class="string">src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure><h3 id="4-7-playbook-中使用-tags-组件"><a href="#4-7-playbook-中使用-tags-组件" class="headerlink" title="4.7. playbook 中使用 tags 组件"></a>4.7. playbook 中使用 tags 组件</h3><p>在 playbook 文件中, 可以利用 tags 组件, 为特定 task 指定标签, 当在执行 playbook 时, 可以只执行特定 tags 的 task, 而非整个 playbook 文件</p><p>案例:<br>httpd.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># tags example</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gater_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">configure</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">copy:</span> <span class="string">src=files/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">httpd</span> <span class="string">service</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">service</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure><p>执行指定的 tags</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ansible-playbook -t conf,service httpd.yml</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-8-playbook-中使用变量"><a href="#4-8-playbook-中使用变量" class="headerlink" title="4.8. playbook 中使用变量"></a>4.8. playbook 中使用变量</h3><p>变量名: 仅能由字母, 数字和下划线, 且只能以字母开头</p><p>变量定义</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">key=value</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>范例:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http_port=80</span><br></pre></td></tr></table></figure><p>变量调用方式:</p><p>通过 调用变量, 且变量名前后建议加空格, 有时用”“ 才生效</p><p>变量来源:</p><ol><li>ansible 的 setup facts 远程主机的所有变量都可直接调用</li><li>通过命令行指定变量, 优先级最高</li></ol><h4 id="4-8-1-在-playbook-文件中定义变量"><a href="#4-8-1-在-playbook-文件中定义变量" class="headerlink" title="4.8.1. 在 playbook 文件中定义变量"></a>4.8.1. 在 playbook 文件中定义变量</h4><p>范例: var2.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">host:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">username:</span> <span class="string">user1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">groupname:</span> <span class="string">group1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">group</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">name=</span> &#123;&#123;<span class="string">groupname</span>&#125;&#125; <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=</span> &#123;&#123; <span class="string">username</span> &#125;&#125; <span class="string">state=present</span></span><br></pre></td></tr></table></figure><h4 id="4-8-2-在-playbook-文件中定义变量"><a href="#4-8-2-在-playbook-文件中定义变量" class="headerlink" title="4.8.2. 在 playbook 文件中定义变量"></a>4.8.2. 在 playbook 文件中定义变量</h4><p>范例:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">username:</span> <span class="string">user1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">groupname:</span> <span class="string">group1</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">group</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">name=&#123;&#123;groupname&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=&#123;&#123;username&#125;&#125;</span> <span class="string">group=&#123;&#123;</span> <span class="string">groupname</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ansible-playbook -e <span class="string">&quot;username=user2 groupname=group2&quot;</span> var3.yml</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="4-8-3-使用变量文件"><a href="#4-8-3-使用变量文件" class="headerlink" title="4.8.3. 使用变量文件"></a>4.8.3. 使用变量文件</h4><p>可以在一个独立的 playbook 文件中定义变量, 在另一个 playbook 文件中引用变量文件中的变量,比 playbook 中定义的变量优先级更高</p><p>vars.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">package_name:</span> <span class="string">vsfpd</span></span><br><span class="line"><span class="attr">service_name:</span> <span class="string">vsfpd</span></span><br></pre></td></tr></table></figure><p>install_app.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install app and configure</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">appsrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">var_files:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vars.yml</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=&#123;&#123;package_name&#125;&#125;</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">install</span></span><br></pre></td></tr></table></figure><h4 id="4-8-4-主机清单中定义变量"><a href="#4-8-4-主机清单中定义变量" class="headerlink" title="4.8.4. 主机清单中定义变量"></a>4.8.4. 主机清单中定义变量</h4><p>主机变量</p><p>在 inventory 主机清单文件中为指定的主机定义变量以便于在 playbook 中使用</p><p>范例:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="section">[websrvs]</span></span><br><span class="line">www1.example.com <span class="attr">http_port</span>=<span class="number">80</span> maxRequestPerChild=<span class="number">808</span></span><br><span class="line">www2.example.com <span class="attr">http_port</span>=<span class="number">8080</span> maxRequestPerChild=<span class="number">909</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>组(公共)变量</p><p>在 inventory 主机清单文件中赋予给指定组内所有主机上的在 playbook 中可用的变量</p><p>范例:</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[websrvs]</span></span><br><span class="line">www1.example.com</span><br><span class="line">www2.example.com</span><br><span class="line"></span><br><span class="line"><span class="section">[websrvs:vars]</span></span><br><span class="line"><span class="attr">domain</span>=example.com</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-9-template-模板"><a href="#4-9-template-模板" class="headerlink" title="4.9. template 模板"></a>4.9. template 模板</h3><p>模板是一个文本文件, 可以作为生成文件的模板, 并且模板文件中可以嵌套 jinja2 语法</p><h4 id="4-9-1-jinja2-语法"><a href="#4-9-1-jinja2-语法" class="headerlink" title="4.9.1. jinja2 语法"></a>4.9.1. jinja2 语法</h4><p>jinja2 语言使用字面量, 有下面形式</p><p>字符串: 使用单引号或双引号</p><p>数字: 整数, 浮点数<br>列表: [item1, item2, …]<br>元组: (item1, item2, …)<br>字典: {key1:value1, key2:value2}<br>布尔型: true&#x2F;false<br>算术运算: +,-,*,&#x2F;,&#x2F;&#x2F;,%,**<br>比较操作: &#x3D;&#x3D;, !&#x3D; &gt;, &gt;&#x3D;, &lt;,&gt;&#x3D;<br>逻辑运算: and, or, not<br>流表达式: For, IF, When</p><p>字面量:</p><p>表达式最简单的形式是字面量, 字面量表示诸如字符串和数值的 python 对象, 如”hello world”, 双引号或单引号中间的一切都是字符串. 无论何时你需要在模板中使用一个字符串(比如函数调用,过滤器或只是包含或继承一个模板的参数), 如 42, 42.23<br>数值可以为整数和浮点数, 如果有小数点, 则为浮点数, 否则为整数, 在 python 里, 42 和 42.0 是一样的</p><p>jinja 语法详细语法可参考<a target="_blank" rel="noopener" href="https://doc.yonyoucloud.com/doc/jinja2-docs-cn/index.html">https://doc.yonyoucloud.com/doc/jinja2-docs-cn/index.html</a></p><h4 id="4-9-2-template"><a href="#4-9-2-template" class="headerlink" title="4.9.2. template"></a>4.9.2. template</h4><p>template 功能: 可以根据和参考模块文件, 动态生成相似的配置文件<br>template 文件必须存放于 template 目录下, 且命名为.j2 结尾<br>yaml&#x2F;yml 文件需和 template 目录平级, 目录结构如下:</p><p>.&#x2F;<br>|—temnginx.yml<br>|—templates<br>|___nginx.conf.j2</p><p>范例: 利用 template 同步 nginx 配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">准备templates/nginx.conf.j2文件</span></span><br><span class="line"><span class="string">vim</span> <span class="string">temnginx.yam</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">template</span> <span class="string">config</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">hosts</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=nginx.conf.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br></pre></td></tr></table></figure><blockquote><p>template 模块只能在 playbook 中使用，不能在 ansible 命令中单独使用<br>template 的作用根据模板生成文件并拷贝到目标位置</p></blockquote><p>执行:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook temnginx.yml</span><br></pre></td></tr></table></figure><p>template 变更替换</p><p>范例:</p><p>修改文件 nginx.conf.j2</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">vim templates/nginx.conf.j2</span><br><span class="line">worker_processes &#123;&#123; ansible_processor_vcpus &#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>变量来源：</p><ol><li>setup 模块的变量(系统变量)</li><li>主机清单中的变量</li><li>变量文件中的变量</li><li>yaml 文件中定义的变量</li><li>ansible-playbook 中使用-e 选项传递的变量</li><li>角色中定义的变量</li></ol></blockquote><p>vim temnginx2.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=nginx</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">template</span> <span class="string">config</span> <span class="string">to</span> <span class="string">remote</span> <span class="string">hosts</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=nginx.conf.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line"><span class="attr">handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook temnginx2.yml</span><br></pre></td></tr></table></figure><h3 id="4-10-playbook-使用-when"><a href="#4-10-playbook-使用-when" class="headerlink" title="4.10. playbook 使用 when"></a>4.10. playbook 使用 when</h3><p>when 语句，可以实现条件测试，如果需要根据变量，facts 或此前任务的执行结果来作为某 task 执行与否的前提时，</p><p>要用到条件测试，通过在 task 后添加 when 子局即可使用条件测试，jinja2 的语法格式</p><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;shutdown RedHat flavored systems&quot;</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/sbin/shutdown</span> <span class="string">-h</span> <span class="string">now</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_os_family</span> <span class="string">==</span> <span class="string">&quot;RedHat&quot;</span></span><br></pre></td></tr></table></figure><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">group</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">user</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=nginx</span> <span class="string">state=present</span> <span class="string">group=nginx</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=nginx</span> <span class="string">state=present</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">&quot;6&quot;</span></span><br></pre></td></tr></table></figure><h3 id="4-11-playbook-使用迭代-with-items"><a href="#4-11-playbook-使用迭代-with-items" class="headerlink" title="4.11. playbook 使用迭代 with_items"></a>4.11. playbook 使用迭代 with_items</h3><p>迭代：当有需要重复性执行的任务时，可以使用迭代机制<br>对迭代项的引用，固定变量名为”item”<br>要在 task 中使用 with items 给定要迭代的元素列表</p><p>列表元素格式：</p><ul><li>字符串</li><li>字典</li></ul><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">serveral</span> <span class="string">users</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span> <span class="string">group=wheel</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">testuser1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">testuser2</span></span><br></pre></td></tr></table></figure><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">some</span> <span class="string">groups</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">apache</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">some</span> <span class="string">users</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item.name</span> <span class="string">&#125;&#125;</span> <span class="string">group=&#123;&#123;</span> <span class="string">item.group</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">&quot;nginx&quot;</span>, <span class="attr">group:</span> <span class="string">&quot;nginx&quot;</span> &#125;</span><br><span class="line">        <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">&quot;mysql&quot;</span>, <span class="attr">group:</span> <span class="string">&quot;mysql&quot;</span> &#125;</span><br><span class="line">        <span class="bullet">-</span> &#123; <span class="attr">name:</span> <span class="string">&quot;apache&quot;</span>, <span class="attr">group:</span> <span class="string">&quot;apache&quot;</span> &#125;</span><br></pre></td></tr></table></figure><h2 id="5-Roles-角色"><a href="#5-Roles-角色" class="headerlink" title="5. Roles 角色"></a>5. Roles 角色</h2><p>角色是 Ansible 自 1.2 版本引入的新特性, 用于层次性, 结构化地组织 playbook, roles 能够根据层次型结构自动装载变量文件, tasks 以及 handlers 等, 要使用 roles 只需要在 playbook 中使用 include 指令即可, 简单来讲, roles 就是通过分别将变量, 文件, 任务, 模板以及处理器放置于单独的目录中, 并可以便捷地 include 它们的一种机制, 角色一般用于基于主机构建服务的场景中, 但也可以用于构建守护进程等场景中</p><p>运维复杂的场景: 建议使用 roles, 代码复用度高</p><p>roles: 多个角色的集合, 可以将多个的 role, 分别放至 roles 目录下的独立目录中</p><p>roles&#x2F;<br>mysql&#x2F;<br>httpd&#x2F;<br>nginx&#x2F;<br>redis&#x2F;</p><h3 id="5-1-Ansible-Roles-目录编排"><a href="#5-1-Ansible-Roles-目录编排" class="headerlink" title="5.1. Ansible Roles 目录编排"></a>5.1. Ansible Roles 目录编排</h3><p>Roles 目录结构如下所示</p><p>roles&#x2F;project&#x2F;: 项目名称, 有以下子目录</p><p>files&#x2F;: 存放由 copy 或 script 模块等调用的文件<br>templates&#x2F;: template 模块查找所需要模板文件的目录<br>tasks&#x2F;: 定义 task, role 的基本元素, 至少应该包含一个名为 main.yml 的文件; 其它的文件需要在此文件中通过 include 进行包含<br>handlers&#x2F;: 至少应该包含一个名为 main.yml 的文件; 其它的文件需要在此文件中通过 include 进行包含<br>vars&#x2F;: 定义变量, 至少应该包含一个名为 main.yml 的文件; 其它的文件需要在此文件中通过 include 进行包含<br>meta&#x2F;: 定义当前角色的特殊设定及其依赖关系, 至少应该包含一个名为 main.yml 的文件, 其它文件需要在此文件中通过 include 进行包含<br>default&#x2F;: 设定默认变量时使用此目录中的 main.yml 文件, 比 vars 的优先级低</p><h3 id="5-2-创建-role"><a href="#5-2-创建-role" class="headerlink" title="5.2. 创建 role"></a>5.2. 创建 role</h3><p>创建 role 的步骤</p><p>(1) 创建以 role 命名的目录<br>(2) 在 roles 目录中分别创建以各角色名称命名的目录, 如 webservers 等<br>(3) 在每个角色命名的目录中分别创建 files, handlers, met, tasks, templates 和 vars 目录; 用不到的目录可以创建为空目录, 也可以不创建<br>(4) 在 playbook 文件中, 调用各角色</p><p>针对大型项目使用 Roles 进行编排<br>范例: roles 的目录结构</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">nginx-role.yml</span><br><span class="line">roles/</span><br><span class="line">|----nginx</span><br><span class="line">      |----files</span><br><span class="line">      |     |--main.yml</span><br><span class="line">      |----tasks</span><br><span class="line">      |     |--groupadd.yml</span><br><span class="line">      |     |--install.yml</span><br><span class="line">      |     |--main.yml</span><br><span class="line">      |     |--restart.yml</span><br><span class="line">      |     |--useradd.yml</span><br><span class="line">      |----vars</span><br><span class="line">            |--main.yml</span><br></pre></td></tr></table></figure><h3 id="5-3-playbook-调用角色"><a href="#5-3-playbook-调用角色" class="headerlink" title="5.3. playbook 调用角色"></a>5.3. playbook 调用角色</h3><p>调用角色方法 1:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">memcached</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><p>调用角色方法 2:</p><p>键 role 用于指定角色名称, 后续的 k&#x2F;v 用于传递变量给角色</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">(role:</span> <span class="string">nginx,</span> <span class="attr">username:</span> <span class="string">nginx)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>调用角色方法 3:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">(role:</span> <span class="string">nginx,</span> <span class="attr">username:</span> <span class="string">nginx,</span> <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">&#x27;7&#x27;</span><span class="string">)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="5-4-roles-中的-tags-使用"><a href="#5-4-roles-中的-tags-使用" class="headerlink" title="5.4. roles 中的 tags 使用"></a>5.4. roles 中的 tags 使用</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> &#123;</span><br><span class="line">        <span class="attr">role:</span> <span class="string">nginx</span>,</span><br><span class="line">        <span class="attr">tags:</span> [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;web&quot;</span>],</span><br><span class="line">        <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">&#x27;6&#x27;</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">role:</span> <span class="string">httpd</span>, <span class="attr">tags:</span> [<span class="string">&quot;httpd&quot;</span>, <span class="string">&quot;web&quot;</span>] &#125;</span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">role:</span> <span class="string">mysql</span>, <span class="attr">tags:</span> [<span class="string">&quot;mysql&quot;</span>, <span class="string">&quot;db&quot;</span>] &#125;</span><br><span class="line">    <span class="bullet">-</span> &#123; <span class="attr">role:</span> <span class="string">mariadb</span>, <span class="attr">tags:</span> [<span class="string">&quot;mariadb&quot;</span>, <span class="string">&quot;db&quot;</span>] &#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ansible-playbook可以挑标签执行</span></span><br><span class="line">ansible-playbook --tags=<span class="string">&quot;nginx,httpd,mysql&quot;</span> nginx-role.yml</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="5-5-实战案例"><a href="#5-5-实战案例" class="headerlink" title="5.5. 实战案例"></a>5.5. 实战案例</h3><h4 id="5-5-1-案例-1：-实现-httpd-角色"><a href="#5-5-1-案例-1：-实现-httpd-角色" class="headerlink" title="5.5.1. 案例 1： 实现 httpd 角色"></a>5.5.1. 案例 1： 实现 httpd 角色</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 创建角色相关的目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -pv /data/ansible/roles/httpd/&#123;tasks, files, handlers&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建角色相关的文件</span></span><br><span class="line"><span class="built_in">cd</span> /data/ansible/roles/httpd/</span><br><span class="line">vim tasks/main.yml</span><br><span class="line">- include: install.yml</span><br><span class="line">- include: config.yml</span><br><span class="line">- include: index.yml</span><br><span class="line">- include: service.yml</span><br><span class="line"></span><br><span class="line">vim tasks/install.yml</span><br><span class="line">- name: install httpd package</span><br><span class="line">  yum: name=httpd</span><br><span class="line"></span><br><span class="line">vim tasks/config.yml</span><br><span class="line">- name: config file</span><br><span class="line">  copy: src=httpd.conf dest=/etc/httpd/conf/ backup=<span class="built_in">yes</span></span><br><span class="line">  notify: restart</span><br><span class="line"></span><br><span class="line">vim tasks/index.yml</span><br><span class="line">- name: index.html</span><br><span class="line">  copy: src=index.html dest=/var/www/html/</span><br><span class="line"></span><br><span class="line">vim tasks/service.yml</span><br><span class="line">- name: start service</span><br><span class="line">  service: name=httpd state=started enabled=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">vim handlers/main.yml</span><br><span class="line">- name: restart</span><br><span class="line">  service: name=httpd state=restarted</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在files目录下创建两个文件</span></span><br><span class="line">httpd.conf index.html</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在 playbook 中调用 httpd 角色</p><p>vim &#x2F;data&#x2F;ansible&#x2F;role_httpd.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># httpd role</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">httpd</span></span><br></pre></td></tr></table></figure><h4 id="5-5-2-案例-2：实现-nginx-角色"><a href="#5-5-2-案例-2：实现-nginx-角色" class="headerlink" title="5.5.2. 案例 2：实现 nginx 角色"></a>5.5.2. 案例 2：实现 nginx 角色</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 创建角色相关的目录</span></span><br><span class="line"><span class="built_in">mkdir</span> -pv /data/ansible/roles/nginx/&#123;tasks, files, templates, handlers, vars&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建角色相关的文件</span></span><br><span class="line"><span class="built_in">cd</span> /data/ansible/roles/nginx/</span><br><span class="line">vim tasks/main.yml</span><br><span class="line">- include: install.yml</span><br><span class="line">- include: config.yml</span><br><span class="line">- include: index.yml</span><br><span class="line">- include: service.yml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vim tasks/install.yml</span><br><span class="line">- name: install nginx package</span><br><span class="line">  yum: name=nginx</span><br><span class="line"></span><br><span class="line">vim tasks/config.yml</span><br><span class="line">- name: config file <span class="keyword">for</span> centos7</span><br><span class="line">  copy: src=nginx7.conf.j2 dest=/etc/nginx/nginx.conf</span><br><span class="line">  when: ansible_distribution_major_version==<span class="string">&quot;7&quot;</span></span><br><span class="line">  notify: restart</span><br><span class="line">- name: config file <span class="keyword">for</span> centos8</span><br><span class="line">  copy: src=nginx8.conf.j2 dest=/etc/nginx/nginx.conf</span><br><span class="line">  when: ansible_distribution_major_version==<span class="string">&quot;8&quot;</span></span><br><span class="line">  notify: restart</span><br><span class="line"></span><br><span class="line">vim tasks/index.yml</span><br><span class="line">- name: index.html</span><br><span class="line"><span class="comment"># 跨角色调用文件</span></span><br><span class="line">  copy: src=roles/httpd/files/index.yml dest=/usr/share/nginx/html/</span><br><span class="line"></span><br><span class="line">vim tasks/service.yml</span><br><span class="line">- name: start service</span><br><span class="line">  service: name=nginx state=started enabled=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">vim handlers/main.yml</span><br><span class="line">- name: restart</span><br><span class="line">  service: name=nginx state=restarted</span><br><span class="line"></span><br><span class="line">vim vars/main.yml</span><br><span class="line">user: daemon</span><br><span class="line"></span><br><span class="line">vim templates/nginx7.conf.j2</span><br><span class="line">......</span><br><span class="line">user: &#123;&#123; user &#125;&#125;</span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line">vim templates/nginx8.conf.j2</span><br><span class="line">......</span><br><span class="line">user: &#123;&#123; user &#125;&#125;</span><br><span class="line">.......</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>在 playbook 中调用 nginx 角色</p><p>vim &#x2F;data&#x2F;ansible&#x2F;role_nginx.yml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># httpd role</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">role_nginx</span></span><br></pre></td></tr></table></figure><h4 id="5-5-3-案例-3：实现-mysql-角色"><a href="#5-5-3-案例-3：实现-mysql-角色" class="headerlink" title="5.5.3. 案例 3：实现 mysql 角色"></a>5.5.3. 案例 3：实现 mysql 角色</h4><p>40”51’</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /data/ansible/roles/mysql/files/my.conf</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">user=mysql</span><br><span class="line">symbolic-links=0</span><br><span class="line">datadir=/data/mysql</span><br><span class="line">innodb_file_per_table=1</span><br><span class="line">log-bin</span><br><span class="line">pid-file=/data/mysql/mysqld.pid</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">port=3306</span><br><span class="line">socket=/tmp/mysqld.log</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">log-error=/var/log/mysqld.log</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /data/ansible/roles/mysql/files/secure_mysql.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">/usr/local/mysql/bin/mysql_secure_installation &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">y</span></span><br><span class="line"><span class="string">philoenglish</span></span><br><span class="line"><span class="string">philoenglish</span></span><br><span class="line"><span class="string">y</span></span><br><span class="line"><span class="string">y</span></span><br><span class="line"><span class="string">y</span></span><br><span class="line"><span class="string">y</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">ls</span> /data/ansible/roles/mysql/files/</span><br><span class="line">my.conf mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz secure_mysql.sh</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /data/ansible/roles/mysql/tasks/main.yml</span><br><span class="line">- include: install.yml</span><br><span class="line">- include: group.yml</span><br><span class="line">- include: user.yml</span><br><span class="line">- include: unarchive.yml</span><br><span class="line">- include: link.yml</span><br><span class="line">- include: data.yml</span><br><span class="line">- include: config.yml</span><br><span class="line">- include: service.yml</span><br><span class="line">- include: path.yml</span><br><span class="line">- include: secure.yml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /data/ansible/roles/mysql/tasks/install.yml</span><br><span class="line">- name: install packages</span><br><span class="line">  yum: name=libaio, perl-Data-Dumper, perl-Getopt-Long</span><br><span class="line">  </span><br><span class="line"><span class="built_in">cat</span> /data/ansible/roles/mysql/tasks/group.yml</span><br><span class="line">- name: create mysql group</span><br><span class="line">  group: name=mysql gid=306</span><br><span class="line">  </span><br><span class="line"><span class="built_in">cat</span> /data/ansible/roles/mysql/tasks/user.yml</span><br><span class="line">- name: create mysql user</span><br><span class="line">  user: name=mysql uid=306 group=mysql shell=/sbin/nologin system=<span class="built_in">yes</span> create_home=no home=/data/mysql</span><br><span class="line">  </span><br><span class="line"><span class="built_in">cat</span> /data/ansible/roles/mysql/tasks/unarchive.yml</span><br><span class="line">- name: copy tar to remote host and file mode</span><br><span class="line">  unarchive: src=mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz dest=/usr/local owner=root group=root</span><br><span class="line">  </span><br><span class="line"><span class="built_in">cat</span> /data/ansible/roles/mysql/tasks/link.yml</span><br><span class="line">- name: <span class="built_in">mkdir</span> /usr/local/mysql</span><br><span class="line">  file: src=/usr/local/mysql-5.6.46-linux-glibc2.12-x86_64.tar.gz dest=/usr/local/mysql state=<span class="built_in">link</span></span><br><span class="line">  </span><br><span class="line"><span class="built_in">cat</span> /data/ansible/roles/mysql/tasks/data.yml</span><br><span class="line">- name: data <span class="built_in">dir</span></span><br><span class="line">  shell: <span class="built_in">chdir</span>=/usr/local/mysql ./scripts/mysql_install_db --datadir=/data/mysql --user=mysql</span><br><span class="line">   </span><br><span class="line"><span class="built_in">cat</span> /data/ansible/roles/mysql/tasks/conf.yml</span><br><span class="line">- name: conf my.cnf</span><br><span class="line">  copy: src=my.cnf dest=/etc/my.cnf</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /data/ansible/roles/mysql/tasks/service.yml</span><br><span class="line">- name: service script</span><br><span class="line">  shell: /bin/cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld;/etc/init.d/mysqld;/etc/init.d/mysqld start; chkconfig mysqld on</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /data/ansible/roles/mysql/tasks/path.yml</span><br><span class="line">- name: PATH variable</span><br><span class="line">  copy: content=<span class="string">&#x27;PATH=/usr/local/mysql/bin:$PATH&#x27;</span> dest=/etc/profile.d/mysql.sh</span><br><span class="line">  </span><br><span class="line"><span class="built_in">cat</span> /data/ansible/roles/mysql/tasks/secure.yml</span><br><span class="line">- name: secure script</span><br><span class="line">  script: secure_mysql.sh</span><br></pre></td></tr></table></figure><h2 id="6-参考教程"><a href="#6-参考教程" class="headerlink" title="6. 参考教程"></a>6. 参考教程</h2><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1HZ4y1p7Bf">ansible 入门到精通及企业实战</a></p><p><a target="_blank" rel="noopener" href="http://www.ansible.com.cn/docs/intro.html">Ansible 中文权威指南</a></p><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/564381327">Ansible 介绍</a></p><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/louis1986/ansible/544331">Ansible指南</a></p></div><div class="article-licensing box"><div class="licensing-title"><p>运维自动化之Ansible</p><p><a href="https://pengtech.net/ansible/ansible.html">https://pengtech.net/ansible/ansible.html</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>鹏叔</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-10-28</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2024-07-10</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/linux/">linux</a><a class="link-muted mr-2" rel="tag" href="/tags/Ansible/">Ansible</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=668dd7bacc04fc0019b762dc&amp;product=inline-share-buttons" defer></script></article></div><div class="card"><nav class="post-navigation mt-4 level is-mobile card-content"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/hexo/hexo_cli.html"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Hexo命令详解</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/ansible/install_ansible_on_windows.html"><span class="level-item">在Windows上安装Ansible</span><i class="level-item fas fa-chevron-right"></i></a></div></nav></div><div class="card" id="comments"><div class="card-content"><span class="title is-5">评论</span><script src="https://utteranc.es/client.js" repo="guoapeng/guoapeng.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen order-1 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="鹏叔的技术博客"></figure><p class="title is-size-4 is-block" style="line-height:inherit">鹏叔的技术博客</p><p class="is-size-6 is-block">日拱一卒，功不唐捐!</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Earth, Solar System, Galaxy.</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">255</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">52</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">80</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/guoapeng" target="_blank" rel="me noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Github" href="https://github.com/guoapeng"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="Mail" href="mailto:guoapeng@gmail.com"><i class="fas fa-envelope"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="me noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">follow.it</h3><form action="https://api.follow.it/subscription-form/WmRzSTRLOENhYXVqeVBHRTVyT2wrR0hrdDhDL0JIWDBBNmovOUJXRE1oZExjV1haM0c3cGxHNlhBV3NvQkFOVC9INHF6aGZlUGpwTzcrTGFDRnZEL3NQck9IYzFiYkxiTVVTb2hnL1VaVmJKY09VTHVpbnVBYjJEVXQwNGZMN3R8cWhjVW1qVStTNlBWWGpMM1UydWpHOUNMcGUzbS9PcHgrZEI1UWpqckZYRT0=/8" method="post" target="_blank"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">友情链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://philoenglish.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">菲利英语</span></span><span class="level-right"><span class="level-item tag">philoenglish.com</span></span></a></li><li><a class="level is-mobile" href="https://ngrevive.com" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Angular复兴</span></span><span class="level-right"><span class="level-item tag">ngrevive.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/AI/"><span class="level-start"><span class="level-item">AI</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/OS/"><span class="level-start"><span class="level-item">OS</span></span><span class="level-end"><span class="level-item tag">44</span></span></a><ul><li><a class="level is-mobile" href="/categories/OS/android/"><span class="level-start"><span class="level-item">android</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/OS/linux/"><span class="level-start"><span class="level-item">linux</span></span><span class="level-end"><span class="level-item tag">37</span></span></a></li><li><a class="level is-mobile" href="/categories/OS/windows/"><span class="level-start"><span class="level-item">windows</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/database/"><span class="level-start"><span class="level-item">database</span></span><span class="level-end"><span class="level-item tag">9</span></span></a><ul><li><a class="level is-mobile" href="/categories/database/mariadb/"><span class="level-start"><span class="level-item">mariadb</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/database/postgresql/"><span class="level-start"><span class="level-item">postgresql</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/devops/"><span class="level-start"><span class="level-item">devops</span></span><span class="level-end"><span class="level-item tag">20</span></span></a><ul><li><a class="level is-mobile" href="/categories/devops/ansible/"><span class="level-start"><span class="level-item">ansible</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/devops/docker/"><span class="level-start"><span class="level-item">docker</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/devops/frontend/"><span class="level-start"><span class="level-item">frontend</span></span><span class="level-end"><span class="level-item tag">1</span></span></a><ul><li><a class="level is-mobile" href="/categories/devops/frontend/backend/"><span class="level-start"><span class="level-item">backend</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/devops/gitlab/"><span class="level-start"><span class="level-item">gitlab</span></span><span class="level-end"><span class="level-item tag">11</span></span></a></li><li><a class="level is-mobile" href="/categories/devops/k8s/"><span class="level-start"><span class="level-item">k8s</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/language/"><span class="level-start"><span class="level-item">language</span></span><span class="level-end"><span class="level-item tag">17</span></span></a><ul><li><a class="level is-mobile" href="/categories/language/golang/"><span class="level-start"><span class="level-item">golang</span></span><span class="level-end"><span class="level-item tag">10</span></span></a></li><li><a class="level is-mobile" href="/categories/language/java/"><span class="level-start"><span class="level-item">java</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/language/rust/"><span class="level-start"><span class="level-item">rust</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/language/typescript/"><span class="level-start"><span class="level-item">typescript</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/network/"><span class="level-start"><span class="level-item">network</span></span><span class="level-end"><span class="level-item tag">7</span></span></a><ul><li><a class="level is-mobile" href="/categories/network/dns/"><span class="level-start"><span class="level-item">dns</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/network/frp/"><span class="level-start"><span class="level-item">frp</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/network/v2rayA/"><span class="level-start"><span class="level-item">v2rayA</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/network/v2rayN/"><span class="level-start"><span class="level-item">v2rayN</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/network/v2rayNG/"><span class="level-start"><span class="level-item">v2rayNG</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/network/vpn/"><span class="level-start"><span class="level-item">vpn</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/others/"><span class="level-start"><span class="level-item">others</span></span><span class="level-end"><span class="level-item tag">6</span></span></a><ul><li><a class="level is-mobile" href="/categories/others/English/"><span class="level-start"><span class="level-item">English</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/others/marketing/"><span class="level-start"><span class="level-item">marketing</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/others/movies/"><span class="level-start"><span class="level-item">movies</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/tools/"><span class="level-start"><span class="level-item">tools</span></span><span class="level-end"><span class="level-item tag">16</span></span></a><ul><li><a class="level is-mobile" href="/categories/tools/git/"><span class="level-start"><span class="level-item">git</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/tools/hexo/"><span class="level-start"><span class="level-item">hexo</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/categories/tools/maven/"><span class="level-start"><span class="level-item">maven</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/tools/vscode/"><span class="level-start"><span class="level-item">vscode</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></li><li><a class="level is-mobile" href="/categories/web/"><span class="level-start"><span class="level-item">web</span></span><span class="level-end"><span class="level-item tag">133</span></span></a><ul><li><a class="level is-mobile" href="/categories/web/CMS/"><span class="level-start"><span class="level-item">CMS</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/web/SEO/"><span class="level-start"><span class="level-item">SEO</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/web/angular/"><span class="level-start"><span class="level-item">angular</span></span><span class="level-end"><span class="level-item tag">61</span></span></a></li><li><a class="level is-mobile" href="/categories/web/angularjs/"><span class="level-start"><span class="level-item">angularjs</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/web/browser/"><span class="level-start"><span class="level-item">browser</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/categories/web/build-tools/"><span class="level-start"><span class="level-item">build tools</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/web/components/"><span class="level-start"><span class="level-item">components</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/web/css/"><span class="level-start"><span class="level-item">css</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/categories/web/design/"><span class="level-start"><span class="level-item">design</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/categories/web/html/"><span class="level-start"><span class="level-item">html</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/web/javascript/"><span class="level-start"><span class="level-item">javascript</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/web/material-design/"><span class="level-start"><span class="level-item">material design</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li><li><a class="level is-mobile" href="/categories/web/nodejs/"><span class="level-start"><span class="level-item">nodejs</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/categories/web/others/"><span class="level-start"><span class="level-item">others</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/web/tauri/"><span class="level-start"><span class="level-item">tauri</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li></ul></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/AI/"><span class="tag">AI</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Angular/"><span class="tag">Angular</span><span class="tag">68</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ansible/"><span class="tag">Ansible</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/CMS/"><span class="tag">CMS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/English/"><span class="tag">English</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Fedora/"><span class="tag">Fedora</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Gemini-AI/"><span class="tag">Gemini AI</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Golang/"><span class="tag">Golang</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Hexo/"><span class="tag">Hexo</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/tags/IDEA/"><span class="tag">IDEA</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Material/"><span class="tag">Material</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NAS/"><span class="tag">NAS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NPM/"><span class="tag">NPM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Nodejs/"><span class="tag">Nodejs</span><span class="tag">13</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OS/"><span class="tag">OS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Rust/"><span class="tag">Rust</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SEO/"><span class="tag">SEO</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Seo/"><span class="tag">Seo</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ubuntu/"><span class="tag">Ubuntu</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Windows/"><span class="tag">Windows</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/angularjs/"><span class="tag">angularjs</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/backend/"><span class="tag">backend</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/bootstrap/"><span class="tag">bootstrap</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/browser/"><span class="tag">browser</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/chartjs/"><span class="tag">chartjs</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/chrome/"><span class="tag">chrome</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/css/"><span class="tag">css</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/database/"><span class="tag">database</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/design/"><span class="tag">design</span><span class="tag">16</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/fedora/"><span class="tag">fedora</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/firefox/"><span class="tag">firefox</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/git/"><span class="tag">git</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gitlab/"><span class="tag">gitlab</span><span class="tag">11</span></a></div><div class="control"><a class="tags has-addons" href="/tags/golang/"><span class="tag">golang</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/gradle/"><span class="tag">gradle</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/html/"><span class="tag">html</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/java/"><span class="tag">java</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/javascript/"><span class="tag">javascript</span><span class="tag">62</span></a></div><div class="control"><a class="tags has-addons" href="/tags/k8s/"><span class="tag">k8s</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/less/"><span class="tag">less</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/life/"><span class="tag">life</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">43</span></a></div><div class="control"><a class="tags has-addons" href="/tags/macOS/"><span class="tag">macOS</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/marketing/"><span class="tag">marketing</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/material-design/"><span class="tag">material design</span><span class="tag">17</span></a></div><div class="control"><a class="tags has-addons" href="/tags/maven/"><span class="tag">maven</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/network/"><span class="tag">network</span><span class="tag">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/nginx/"><span class="tag">nginx</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pgadmin/"><span class="tag">pgadmin</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/pnpm/"><span class="tag">pnpm</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/product/"><span class="tag">product</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sass/"><span class="tag">sass</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/sentry/"><span class="tag">sentry</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/shell/"><span class="tag">shell</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/source-control/"><span class="tag">source_control</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spring/"><span class="tag">spring</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spring-boot/"><span class="tag">spring boot</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/springboot/"><span class="tag">springboot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/strapi/"><span class="tag">strapi</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tailwindcss/"><span class="tag">tailwindcss</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tauri/"><span class="tag">tauri</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/tmux/"><span class="tag">tmux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/typescript/"><span class="tag">typescript</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/v2ray/"><span class="tag">v2ray</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/v2rayA/"><span class="tag">v2rayA</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/v2rayN/"><span class="tag">v2rayN</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/v2rayNG/"><span class="tag">v2rayNG</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/virualbox/"><span class="tag">virualbox</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vmware/"><span class="tag">vmware</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vpn/"><span class="tag">vpn</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/vscode/"><span class="tag">vscode</span><span class="tag">6</span></a></div><div class="control"><a class="tags has-addons" href="/tags/web/"><span class="tag">web</span><span class="tag">60</span></a></div><div class="control"><a class="tags has-addons" href="/tags/webpack/"><span class="tag">webpack</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/websocket/"><span class="tag">websocket</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/windows/"><span class="tag">windows</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/wordpress/"><span class="tag">wordpress</span><span class="tag">1</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#1-介绍"><span class="level-left"><span class="level-item">1. 介绍</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-Ansible-发展和起源"><span class="level-left"><span class="level-item">1.1. Ansible 发展和起源</span></span></a></li><li><a class="level is-mobile" href="#1-2-为什么需要-Ansible"><span class="level-left"><span class="level-item">1.2. 为什么需要 Ansible</span></span></a></li><li><a class="level is-mobile" href="#1-3-Ansible-的主要功能"><span class="level-left"><span class="level-item">1.3. Ansible 的主要功能</span></span></a></li><li><a class="level is-mobile" href="#1-4-Ansible-的相关特性"><span class="level-left"><span class="level-item">1.4. Ansible 的相关特性</span></span></a></li><li><a class="level is-mobile" href="#1-5-Ansible-的优点"><span class="level-left"><span class="level-item">1.5. Ansible 的优点</span></span></a></li><li><a class="level is-mobile" href="#1-6-Ansible-的架构"><span class="level-left"><span class="level-item">1.6. Ansible 的架构</span></span></a></li></ul></li><li><a class="level is-mobile" href="#2-运维自动化和-Ansible-架构介绍"><span class="level-left"><span class="level-item">2. 运维自动化和 Ansible 架构介绍</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-运维自动化发展历程及技术应用"><span class="level-left"><span class="level-item">2.1. 运维自动化发展历程及技术应用</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-1-云计算运维工程师核心职能"><span class="level-left"><span class="level-item">2.1.1. 云计算运维工程师核心职能</span></span></a></li><li><a class="level is-mobile" href="#2-1-2-软件开发阶段"><span class="level-left"><span class="level-item">2.1.2. 软件开发阶段</span></span></a></li><li><a class="level is-mobile" href="#2-1-3-运维工程师的发展路线"><span class="level-left"><span class="level-item">2.1.3. 运维工程师的发展路线</span></span></a></li><li><a class="level is-mobile" href="#2-1-4-Ansible-介绍和架构"><span class="level-left"><span class="level-item">2.1.4. Ansible 介绍和架构</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#3-Ansible-的安装和使用"><span class="level-left"><span class="level-item">3. Ansible 的安装和使用</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-Ansbile-安装"><span class="level-left"><span class="level-item">3.1. Ansbile 安装</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-1-EPEL-yum-源安装"><span class="level-left"><span class="level-item">3.1.1. EPEL yum 源安装</span></span></a></li><li><a class="level is-mobile" href="#3-1-2-编译安装"><span class="level-left"><span class="level-item">3.1.2. 编译安装</span></span></a></li><li><a class="level is-mobile" href="#3-1-3-Git-方式"><span class="level-left"><span class="level-item">3.1.3. Git 方式</span></span></a></li><li><a class="level is-mobile" href="#3-1-4-pip-安装"><span class="level-left"><span class="level-item">3.1.4. pip 安装</span></span></a></li><li><a class="level is-mobile" href="#3-1-5-确认安装"><span class="level-left"><span class="level-item">3.1.5. 确认安装</span></span></a></li><li><a class="level is-mobile" href="#3-1-6-Ansible-相关文件"><span class="level-left"><span class="level-item">3.1.6. Ansible 相关文件</span></span></a></li><li><a class="level is-mobile" href="#3-1-7-Ansible-常用模块"><span class="level-left"><span class="level-item">3.1.7. Ansible 常用模块</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#4-Playbook"><span class="level-left"><span class="level-item">4. Playbook</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-1-playbook-介绍"><span class="level-left"><span class="level-item">4.1. playbook 介绍</span></span></a></li><li><a class="level is-mobile" href="#4-2-YAML-语言"><span class="level-left"><span class="level-item">4.2. YAML 语言</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-2-1-YAML-语言介绍"><span class="level-left"><span class="level-item">4.2.1. YAML 语言介绍</span></span></a></li><li><a class="level is-mobile" href="#4-2-2-YAML-语言特性"><span class="level-left"><span class="level-item">4.2.2. YAML 语言特性</span></span></a></li><li><a class="level is-mobile" href="#4-2-3-YAML-语法简介"><span class="level-left"><span class="level-item">4.2.3. YAML 语法简介</span></span></a></li></ul></li><li><a class="level is-mobile" href="#4-3-Playbook-核心元素"><span class="level-left"><span class="level-item">4.3. Playbook 核心元素</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-3-1-hosts-组件"><span class="level-left"><span class="level-item">4.3.1. hosts 组件</span></span></a></li><li><a class="level is-mobile" href="#4-3-2-remote-user-组件"><span class="level-left"><span class="level-item">4.3.2. remote_user 组件</span></span></a></li><li><a class="level is-mobile" href="#4-3-3-task-列表和-action-组件"><span class="level-left"><span class="level-item">4.3.3. task 列表和 action 组件</span></span></a></li><li><a class="level is-mobile" href="#4-3-4-其它组件"><span class="level-left"><span class="level-item">4.3.4. 其它组件</span></span></a></li><li><a class="level is-mobile" href="#4-3-5-ShellScript-VS-Playbook-案例"><span class="level-left"><span class="level-item">4.3.5. ShellScript VS Playbook 案例</span></span></a></li></ul></li><li><a class="level is-mobile" href="#4-4-playbook-命令"><span class="level-left"><span class="level-item">4.4. playbook 命令</span></span></a></li><li><a class="level is-mobile" href="#4-5-Playbook-初步"><span class="level-left"><span class="level-item">4.5. Playbook 初步</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-5-1-利用-playbook-创建-mysql-用户"><span class="level-left"><span class="level-item">4.5.1. 利用 playbook 创建 mysql 用户</span></span></a></li><li><a class="level is-mobile" href="#4-5-2-利用-playbook-安装-nginx"><span class="level-left"><span class="level-item">4.5.2. 利用 playbook 安装 nginx</span></span></a></li><li><a class="level is-mobile" href="#4-5-3-利用-playbook-安装和卸载-httpd"><span class="level-left"><span class="level-item">4.5.3. 利用 playbook 安装和卸载 httpd</span></span></a></li><li><a class="level is-mobile" href="#4-5-4-利用-playbook-安装-mysql"><span class="level-left"><span class="level-item">4.5.4. 利用 playbook 安装 mysql</span></span></a></li></ul></li><li><a class="level is-mobile" href="#4-6-Playbook-中使用-handlers-和-notify"><span class="level-left"><span class="level-item">4.6. Playbook 中使用 handlers 和 notify</span></span></a></li><li><a class="level is-mobile" href="#4-7-playbook-中使用-tags-组件"><span class="level-left"><span class="level-item">4.7. playbook 中使用 tags 组件</span></span></a></li><li><a class="level is-mobile" href="#4-8-playbook-中使用变量"><span class="level-left"><span class="level-item">4.8. playbook 中使用变量</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-8-1-在-playbook-文件中定义变量"><span class="level-left"><span class="level-item">4.8.1. 在 playbook 文件中定义变量</span></span></a></li><li><a class="level is-mobile" href="#4-8-2-在-playbook-文件中定义变量"><span class="level-left"><span class="level-item">4.8.2. 在 playbook 文件中定义变量</span></span></a></li><li><a class="level is-mobile" href="#4-8-3-使用变量文件"><span class="level-left"><span class="level-item">4.8.3. 使用变量文件</span></span></a></li><li><a class="level is-mobile" href="#4-8-4-主机清单中定义变量"><span class="level-left"><span class="level-item">4.8.4. 主机清单中定义变量</span></span></a></li></ul></li><li><a class="level is-mobile" href="#4-9-template-模板"><span class="level-left"><span class="level-item">4.9. template 模板</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-9-1-jinja2-语法"><span class="level-left"><span class="level-item">4.9.1. jinja2 语法</span></span></a></li><li><a class="level is-mobile" href="#4-9-2-template"><span class="level-left"><span class="level-item">4.9.2. template</span></span></a></li></ul></li><li><a class="level is-mobile" href="#4-10-playbook-使用-when"><span class="level-left"><span class="level-item">4.10. playbook 使用 when</span></span></a></li><li><a class="level is-mobile" href="#4-11-playbook-使用迭代-with-items"><span class="level-left"><span class="level-item">4.11. playbook 使用迭代 with_items</span></span></a></li></ul></li><li><a class="level is-mobile" href="#5-Roles-角色"><span class="level-left"><span class="level-item">5. Roles 角色</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#5-1-Ansible-Roles-目录编排"><span class="level-left"><span class="level-item">5.1. Ansible Roles 目录编排</span></span></a></li><li><a class="level is-mobile" href="#5-2-创建-role"><span class="level-left"><span class="level-item">5.2. 创建 role</span></span></a></li><li><a class="level is-mobile" href="#5-3-playbook-调用角色"><span class="level-left"><span class="level-item">5.3. playbook 调用角色</span></span></a></li><li><a class="level is-mobile" href="#5-4-roles-中的-tags-使用"><span class="level-left"><span class="level-item">5.4. roles 中的 tags 使用</span></span></a></li><li><a class="level is-mobile" href="#5-5-实战案例"><span class="level-left"><span class="level-item">5.5. 实战案例</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#5-5-1-案例-1：-实现-httpd-角色"><span class="level-left"><span class="level-item">5.5.1. 案例 1： 实现 httpd 角色</span></span></a></li><li><a class="level is-mobile" href="#5-5-2-案例-2：实现-nginx-角色"><span class="level-left"><span class="level-item">5.5.2. 案例 2：实现 nginx 角色</span></span></a></li><li><a class="level is-mobile" href="#5-5-3-案例-3：实现-mysql-角色"><span class="level-left"><span class="level-item">5.5.3. 案例 3：实现 mysql 角色</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#6-参考教程"><span class="level-left"><span class="level-item">6. 参考教程</span></span></a></li></ul></div></div><style>#toc .menu-list>li>a.is-active+.menu-list{display:block}#toc .menu-list>li>a+.menu-list{display:none}</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time datetime="2024-07-14T16:00:00.000Z">2024-07-15</time></p><p class="title"><a href="/database/postgresql_upgrade.html">PostgreSQL 数据库版本升级实战</a></p><p class="categories"><a href="/categories/database/">database</a> / <a href="/categories/database/postgresql/">postgresql</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2024-07-14T16:00:00.000Z">2024-07-15</time></p><p class="title"><a href="/hexo/hexo_theme_recommendation.html">13 个精美的 hexo 博客主题推荐</a></p><p class="categories"><a href="/categories/tools/">tools</a> / <a href="/categories/tools/hexo/">hexo</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2024-07-10T16:00:00.000Z">2024-07-11</time></p><p class="title"><a href="/network/install_v2rayA_on_Windows.html">2024最新 v2rayA 安装与配置教程 for Windows</a></p><p class="categories"><a href="/categories/network/">network</a> / <a href="/categories/network/v2rayA/">v2rayA</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2024-07-08T16:00:00.000Z">2024-07-09</time></p><p class="title"><a href="/hexo/hexo_apply_icarus_theme.html">Hexo配置Icarus主题</a></p><p class="categories"><a href="/categories/tools/">tools</a> / <a href="/categories/tools/hexo/">hexo</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time datetime="2024-07-06T16:00:00.000Z">2024-07-07</time></p><p class="title"><a href="/angular/angular_debug.html">如何调试Angular应用程序</a></p><p class="categories"><a href="/categories/web/">web</a> / <a href="/categories/web/angular/">angular</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2024/07/"><span class="level-start"><span class="level-item">七月 2024</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/06/"><span class="level-start"><span class="level-item">六月 2024</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/05/"><span class="level-start"><span class="level-item">五月 2024</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/04/"><span class="level-start"><span class="level-item">四月 2024</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/03/"><span class="level-start"><span class="level-item">三月 2024</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/02/"><span class="level-start"><span class="level-item">二月 2024</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2024/01/"><span class="level-start"><span class="level-item">一月 2024</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/12/"><span class="level-start"><span class="level-item">十二月 2023</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/11/"><span class="level-start"><span class="level-item">十一月 2023</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/10/"><span class="level-start"><span class="level-item">十月 2023</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/09/"><span class="level-start"><span class="level-item">九月 2023</span></span><span class="level-end"><span class="level-item tag">14</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/08/"><span class="level-start"><span class="level-item">八月 2023</span></span><span class="level-end"><span class="level-item tag">25</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/07/"><span class="level-start"><span class="level-item">七月 2023</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/06/"><span class="level-start"><span class="level-item">六月 2023</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/05/"><span class="level-start"><span class="level-item">五月 2023</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/04/"><span class="level-start"><span class="level-item">四月 2023</span></span><span class="level-end"><span class="level-item tag">12</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/03/"><span class="level-start"><span class="level-item">三月 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/02/"><span class="level-start"><span class="level-item">二月 2023</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2023/01/"><span class="level-start"><span class="level-item">一月 2023</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/12/"><span class="level-start"><span class="level-item">十二月 2022</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/11/"><span class="level-start"><span class="level-item">十一月 2022</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/09/"><span class="level-start"><span class="level-item">九月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/08/"><span class="level-start"><span class="level-item">八月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/05/"><span class="level-start"><span class="level-item">五月 2022</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/03/"><span class="level-start"><span class="level-item">三月 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">一月 2022</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">十二月 2021</span></span><span class="level-end"><span class="level-item tag">8</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">十一月 2021</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">29</span></span></a></li></ul></div></div></div><div class="card widget" data-type="adsense"><div class="card-content"><div class="menu"><h3 class="menu-label">广告</h3><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9737903136672124" data-ad-slot="9469284888" data-ad-format="auto" data-full-width-responsive="true"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">鹏叔的技术博客</a><p class="is-size-7"><span>&copy; 2024 鹏叔</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Follow on GitHub" href="https://github.com/guoapeng"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn")</script><script>var IcarusThemeSettings={article:{highlight:{clipboard:!0,fold:"unfolded"}}}</script><script data-pjax src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script data-pjax src="/js/back_to_top.js" defer></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load",()=>{"function"==typeof $.fn.lightGallery&&$(".article").lightGallery({selector:".gallery-item"}),"function"==typeof $.fn.justifiedGallery&&($(".justified-gallery > p > .gallery-item").length&&$(".justified-gallery > p > .gallery-item").unwrap(),$(".justified-gallery").justifiedGallery())})</script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script src="/js/pjax.js"></script><script data-pjax src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container" id="algolia-input"></div><div id="algolia-poweredby" style="display:flex;margin:0 .5em 0 1em;align-items:center;line-height:0"></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div><div class="searchbox-footer"></div></div></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch@4.0.3/dist/algoliasearch-lite.umd.js" crossorigin="anonymous" defer></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4.3.1/dist/instantsearch.production.min.js" crossorigin="anonymous" defer></script><script src="/js/algolia.js" defer></script><script>document.addEventListener("DOMContentLoaded",function(){loadAlgolia({applicationId:"FF7977TBCM",apiKey:"e19d2357dac0b28a1a905765619e673a",indexName:"FF7977TBCM"},{hint:"想要查找什么...",no_result:"未找到搜索结果",untitled:"(无标题)",empty_preview:"(无内容预览)"})})</script><script type="text/javascript" src="/js/imaegoo/universe.js"></script></body></html>