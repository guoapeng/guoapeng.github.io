<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="google-site-verification" content="hwu96hHsSnPefhY5oj_Q2reBfC1YuVkwbsuPeuAjSls"><meta name="baidu-site-verification" content="codeva-1TKHma47RE"><script>!function(t,e,n,c,r,a){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(r=e.createElement(c)).async=1,r.src="https://www.clarity.ms/tag/cnl2uzz0vb?ref=bwt",(a=e.getElementsByTagName(c)[0]).parentNode.insertBefore(r,a)}(window,document,"clarity","script")</script><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.loli.net/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic%7CPingFang+SC:300,300italic,400,400italic,700,700italic%7CMicrosoft+YaHei:300,300italic,400,400italic,700,700italic%7Csans-serif:300,300italic,400,400italic,700,700italic%7CLato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"><script class="next-config" data-name="main" type="application/json">{"hostname":"www.pengtech.net","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":"enable","bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script><meta name="description" content="1. gitlab简介 2. 安装环境介绍 3. gitlab 安装 4. 系统要求 4.1. 安装准备工作 4.2. 开始安装gitlab   5. gitlab升级 5.1. 升级前备份 5.2. 开启yum缓存 5.3. 开始升级   6. gitlab迁移 6.1. 备份数据 6.2. 在新服务器上安装gitlab 6.3. 还原备份   7. 如何彻底卸载gitlab? 7.1. 卸载"><meta property="og:type" content="article"><meta property="og:title" content="gitlab安装升级及迁移"><meta property="og:url" content="https://www.pengtech.net/gitlab/gitlab_installation_upgrade.html"><meta property="og:site_name" content="鹏叔的技术博客"><meta property="og:description" content="1. gitlab简介 2. 安装环境介绍 3. gitlab 安装 4. 系统要求 4.1. 安装准备工作 4.2. 开始安装gitlab   5. gitlab升级 5.1. 升级前备份 5.2. 开启yum缓存 5.3. 开始升级   6. gitlab迁移 6.1. 备份数据 6.2. 在新服务器上安装gitlab 6.3. 还原备份   7. 如何彻底卸载gitlab? 7.1. 卸载"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2021-11-05T16:00:00.000Z"><meta property="article:modified_time" content="2024-05-01T18:12:12.568Z"><meta property="article:author" content="鹏叔"><meta property="article:tag" content="gitlab"><meta name="twitter:card" content="summary"><link rel="canonical" href="https://www.pengtech.net/gitlab/gitlab_installation_upgrade.html"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.pengtech.net/gitlab/gitlab_installation_upgrade.html","path":"gitlab/gitlab_installation_upgrade.html","title":"gitlab安装升级及迁移"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>gitlab安装升级及迁移 | 鹏叔的技术博客</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZZTM0Y954E"></script><script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-ZZTM0Y954E","only_pageview":false}</script><script src="/js/third-party/analytics/google-analytics.js"></script><script src="/js/third-party/analytics/baidu-analytics.js"></script><script async src="https://hm.baidu.com/hm.js?1da0f55a32eb17a877b1b18efa3d0406"></script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i> <span class="site-title h1">鹏叔的技术博客</span> <i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">日拱一卒，功不唐捐!</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-angular"><a href="/angular/" rel="section"><i class="fa fa-th fa-fw"></i>angular</a></li><li class="menu-item menu-item-material-design"><a href="/material-design/" rel="section"><i class="fa fa-th fa-fw"></i>material-design</a></li><li class="menu-item menu-item-linux"><a href="/linux/" rel="section"><i class="fa fa-cube fa-fw"></i>linux</a></li><li class="menu-item menu-item-gitlab"><a href="/gitlab/" rel="section"><i class="fa fa-th fa-fw"></i>gitlab</a></li><li class="menu-item menu-item-frontend"><a href="/frontend/" rel="section"><i class="fa fa-mobile fa-fw"></i>frontend</a></li><li class="menu-item menu-item-backend"><a href="/backend/" rel="section"><i class="fa fa-mobile fa-fw"></i>backend</a></li><li class="menu-item menu-item-vscode"><a href="/vscode/" rel="section"><i class="fa fa-th fa-fw"></i>vscode</a></li><li class="menu-item menu-item-hexo"><a href="/hexo/" rel="section"><i class="fa fa-sitemap fa-fw"></i>hexo</a></li><li class="menu-item menu-item-java"><a href="/java/" rel="section"><i class="fa fa-coffee fa-fw"></i>java</a></li><li class="menu-item menu-item-golang"><a href="/golang/" rel="section"><i class="fa fa-cloud fa-fw"></i>golang</a></li><li class="menu-item menu-item-v2raya"><a href="/v2rayA/" rel="section"><i class="fa fa-cloud fa-fw"></i>v2rayA</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-gitlab%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">1. gitlab简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%AE%89%E8%A3%85%E7%8E%AF%E5%A2%83%E4%BB%8B%E7%BB%8D"><span class="nav-number">2.</span> <span class="nav-text">2. 安装环境介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-gitlab-%E5%AE%89%E8%A3%85"><span class="nav-number">3.</span> <span class="nav-text">3. gitlab 安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E7%B3%BB%E7%BB%9F%E8%A6%81%E6%B1%82"><span class="nav-number">4.</span> <span class="nav-text">4. 系统要求</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-%E5%AE%89%E8%A3%85%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-number">4.1.</span> <span class="nav-text">4.1. 安装准备工作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-%E5%BC%80%E5%A7%8B%E5%AE%89%E8%A3%85gitlab"><span class="nav-number">4.2.</span> <span class="nav-text">4.2. 开始安装gitlab</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-gitlab%E5%8D%87%E7%BA%A7"><span class="nav-number">5.</span> <span class="nav-text">5. gitlab升级</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-%E5%8D%87%E7%BA%A7%E5%89%8D%E5%A4%87%E4%BB%BD"><span class="nav-number">5.1.</span> <span class="nav-text">5.1. 升级前备份</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-%E5%BC%80%E5%90%AFyum%E7%BC%93%E5%AD%98"><span class="nav-number">5.2.</span> <span class="nav-text">5.2. 开启yum缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-%E5%BC%80%E5%A7%8B%E5%8D%87%E7%BA%A7"><span class="nav-number">5.3.</span> <span class="nav-text">5.3. 开始升级</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-gitlab%E8%BF%81%E7%A7%BB"><span class="nav-number">6.</span> <span class="nav-text">6. gitlab迁移</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#6-1-%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE"><span class="nav-number">6.1.</span> <span class="nav-text">6.1. 备份数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-2-%E5%9C%A8%E6%96%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E5%AE%89%E8%A3%85gitlab"><span class="nav-number">6.2.</span> <span class="nav-text">6.2. 在新服务器上安装gitlab</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-3-%E8%BF%98%E5%8E%9F%E5%A4%87%E4%BB%BD"><span class="nav-number">6.3.</span> <span class="nav-text">6.3. 还原备份</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-%E5%A6%82%E4%BD%95%E5%BD%BB%E5%BA%95%E5%8D%B8%E8%BD%BDgitlab"><span class="nav-number">7.</span> <span class="nav-text">7. 如何彻底卸载gitlab?</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-%E5%8D%B8%E8%BD%BD%E5%89%8D%E5%A4%87%E4%BB%BD"><span class="nav-number">7.1.</span> <span class="nav-text">7.1. 卸载前备份</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-%E6%89%A7%E8%A1%8C%E5%8D%B8%E8%BD%BD"><span class="nav-number">7.2.</span> <span class="nav-text">7.2. 执行卸载</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5"><span class="nav-number">8.</span> <span class="nav-text">8. 问题排查</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-%E5%85%B3%E8%81%94%E9%98%85%E8%AF%BB"><span class="nav-number">9.</span> <span class="nav-text">9. 关联阅读</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="鹏叔" src="/imgs/avatar.gif"><p class="site-author-name" itemprop="name">鹏叔</p><div class="site-description" itemprop="description">鹏叔的技术博客, 鹏叔的技术博客, 收集鹏叔在日常工作中整理的技术博客, 内容包括前端javascript, material design, typescript, css, html, 后端golang, java, 数据库等.</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">249</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">35</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">76</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/guoapeng" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;guoapeng" rel="noopener external nofollow" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:guoapeng@gmail.com" title="E-Mail → mailto:guoapeng@gmail.com" rel="noopener external nofollow" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a></span></div><div class="cc-license site-overview-item animated" itemprop="license"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener external nofollow" target="_blank"><img src="https://cdn.jsdelivr.net/npm/@creativecommons/vocabulary@2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a></div><div class="links-of-blogroll site-overview-item animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> 友情链接</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://philoenglish.com/" title="https:&#x2F;&#x2F;philoenglish.com" target="_blank">菲利英语</a></li></ul></div></div></div><div class="back-to-top animated" role="button" aria-label="返回顶部"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div class="sidebar-dimmer"></div></header><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://www.pengtech.net/gitlab/gitlab_installation_upgrade.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/imgs/avatar.gif"><meta itemprop="name" content="鹏叔"><meta itemprop="description" content="鹏叔的技术博客, 鹏叔的技术博客, 收集鹏叔在日常工作中整理的技术博客, 内容包括前端javascript, material design, typescript, css, html, 后端golang, java, 数据库等."></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="鹏叔的技术博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">gitlab安装升级及迁移</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-11-06 00:00:00" itemprop="dateCreated datePublished" datetime="2021-11-06T00:00:00+08:00">2021-11-06</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-05-02 02:12:12" itemprop="dateModified" datetime="2024-05-02T02:12:12+08:00">2024-05-02</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/backend/" itemprop="url" rel="index"><span itemprop="name">backend</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/backend/devops/" itemprop="url" rel="index"><span itemprop="name">devops</span></a> </span>， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/backend/devops/git/" itemprop="url" rel="index"><span itemprop="name">git</span></a> </span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">阅读次数：</span> <span id="busuanzi_value_page_pv"></span> </span><span class="post-meta-break"></span> <span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">本文字数：</span> <span>8k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span>7 分钟</span></span></div></div></header><div class="post-body" itemprop="articleBody"><ul><li><a href="#1-gitlab%E7%AE%80%E4%BB%8B">1. gitlab简介</a></li><li><a href="#2-%E5%AE%89%E8%A3%85%E7%8E%AF%E5%A2%83%E4%BB%8B%E7%BB%8D">2. 安装环境介绍</a></li><li><a href="#3-gitlab-%E5%AE%89%E8%A3%85">3. gitlab 安装</a></li><li><a href="#4-%E7%B3%BB%E7%BB%9F%E8%A6%81%E6%B1%82">4. 系统要求</a><ul><li><a href="#41-%E5%AE%89%E8%A3%85%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">4.1. 安装准备工作</a></li><li><a href="#42-%E5%BC%80%E5%A7%8B%E5%AE%89%E8%A3%85gitlab">4.2. 开始安装gitlab</a></li></ul></li><li><a href="#5-gitlab%E5%8D%87%E7%BA%A7">5. gitlab升级</a><ul><li><a href="#51-%E5%8D%87%E7%BA%A7%E5%89%8D%E5%A4%87%E4%BB%BD">5.1. 升级前备份</a></li><li><a href="#52-%E5%BC%80%E5%90%AFyum%E7%BC%93%E5%AD%98">5.2. 开启yum缓存</a></li><li><a href="#53-%E5%BC%80%E5%A7%8B%E5%8D%87%E7%BA%A7">5.3. 开始升级</a></li></ul></li><li><a href="#6-gitlab%E8%BF%81%E7%A7%BB">6. gitlab迁移</a><ul><li><a href="#61-%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AE">6.1. 备份数据</a></li><li><a href="#62-%E5%9C%A8%E6%96%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E5%AE%89%E8%A3%85gitlab">6.2. 在新服务器上安装gitlab</a></li><li><a href="#63-%E8%BF%98%E5%8E%9F%E5%A4%87%E4%BB%BD">6.3. 还原备份</a></li></ul></li><li><a href="#7-%E5%A6%82%E4%BD%95%E5%BD%BB%E5%BA%95%E5%8D%B8%E8%BD%BDgitlab">7. 如何彻底卸载gitlab?</a><ul><li><a href="#71-%E5%8D%B8%E8%BD%BD%E5%89%8D%E5%A4%87%E4%BB%BD">7.1. 卸载前备份</a></li><li><a href="#72-%E6%89%A7%E8%A1%8C%E5%8D%B8%E8%BD%BD">7.2. 执行卸载</a></li></ul></li><li><a href="#8-%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5">8. 问题排查</a></li><li><a href="#9-%E5%85%B3%E8%81%94%E9%98%85%E8%AF%BB">9. 关联阅读</a></li></ul><h2 id="1-gitlab简介"><a href="#1-gitlab简介" class="headerlink" title="1. gitlab简介"></a>1. gitlab简介</h2><p>GitLab 是一个用于仓库管理系统的开源项目，使用Git作为代码管理工具，并在此基础上搭建起来的Web服务。<br>GitLab是由GitLabInc.开发，使用MIT许可证的基于网络的Git仓库管理工具，且具有wiki和issue跟踪功能。使用Git作为代码管理工具，并在此基础上搭建起来的web服务。<br>GitLab由乌克兰程序员DmitriyZaporozhets和ValerySizov开发，它使用Ruby语言写成。后来，一些部分用Go语言重写。截止2018年5月，该公司约有290名团队成员，以及2000多名开源贡献者。GitLab被IBM，Sony，JülichResearchCenter，NASA，Alibaba，Invincea，O’ReillyMedia，Leibniz-Rechenzentrum(LRZ)，CERN，SpaceX等组织使用。</p><span id="more"></span><h2 id="2-安装环境介绍"><a href="#2-安装环境介绍" class="headerlink" title="2. 安装环境介绍"></a>2. 安装环境介绍</h2><p>服务器的操作系统为CentOS Linux release 7.9.2009<br>包管理工具yum.<br>这里安装的是gitlab企业版，本教程可以作为社区版安装的参考资料，社区版安装稍有不同，在了解社区版的差异后，安装步骤稍作调整．</p><h2 id="3-gitlab-安装"><a href="#3-gitlab-安装" class="headerlink" title="3. gitlab 安装"></a>3. gitlab 安装</h2><p>gitlab的安装方式有很多种，比如docker镜像安装，Helm charts安装，源代码安装，GET(GitLab Environment Toolkit)安装, 本文主要讲述使用ceontos或redhat系列中通过yum安装使用rpm包安装．安装前需要对yum和rpm命令有一定的了解．</p><h2 id="4-系统要求"><a href="#4-系统要求" class="headerlink" title="4. 系统要求"></a>4. 系统要求</h2><p>空闲硬盘空间：　2.5G+<br>CPU: 4core+ (4核最多支持500用户，8核最多支持1000用户)<br>内存：4GB+</p><h3 id="4-1-安装准备工作"><a href="#4-1-安装准备工作" class="headerlink" title="4.1. 安装准备工作"></a>4.1. 安装准备工作</h3><ul><li><p>更新yum源<br>这里采用南京大学镜像(主要处于下载速度考虑)，如果你访问外网的速度够快, 可以考虑使用官方镜像．<br>将下面一段代码拷贝到/etc/yum.repos.d, 命名为gitlab_gitlab-ee.repo, 当然你也可以根据自己的喜好命名，只要文件后缀为.repo即可，符合yum源文件命名规范即可</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[gitlab_gitlab-ee]</span></span><br><span class="line"> <span class="attr">name</span>=Gitlab EE Repository</span><br><span class="line"> <span class="attr">baseurl</span>=https://mirrors.nju.edu.cn/gitlab-ee/yum/el<span class="variable">$releasever</span>/</span><br><span class="line"> <span class="attr">gpgcheck</span>=<span class="number">0</span></span><br><span class="line"> <span class="attr">enabled</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure></li><li><p>更新yum缓存，以便快速查询，确保缓存中有最新安装包信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache</span><br></pre></td></tr></table></figure></li></ul><h3 id="4-2-开始安装gitlab"><a href="#4-2-开始安装gitlab" class="headerlink" title="4.2. 开始安装gitlab"></a>4.2. 开始安装gitlab</h3><ul><li><p>开始安装前可以使用yum命令查看有哪些可用的版本，以及当前最新版本是哪个．</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum list gitlab-ee --showduplicates | sort -r</span><br></pre></td></tr></table></figure><blockquote><p>通过以上命令，确定当前列表中包含最新版本，如果列表中最新版本不是最新的，可能需要执行yum makecache 更新缓存，或者yum源本身就不包含最新版本，那么要考虑更换yum源．如果要安装指定版本，需要确保需要安装的版本包含在列表中．</p></blockquote></li><li><p>安装最新版本的方法</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gitlab-ee</span><br></pre></td></tr></table></figure></li><li><p>安装特定版本的方法<br>以centos7为例, 后面的版本号x.y.z-ee.0.el7根据实际情况进行替换．</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y gitlab-ee-x.y.z-ee.0.el7</span><br></pre></td></tr></table></figure></li><li><p>配置gitlab<br>安装完成后执行以下命令gitlab将会自动帮我们完成一些必要的配置，切记如果你手动完成一些配置后不要重复执行以下命令，否则手动配置的参数会被清除，严重时会导致用户访问时出现http 500错误．</p><p>修改external_url<br>编辑文件/etc/gitlab/gitlab.rb</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#replace gitlab.example.com with your domain or your ip</span></span><br><span class="line"><span class="comment"># for instance external_url &#x27;http://192.168.1.100&#x27;</span></span><br><span class="line">external_url <span class="string">&#x27;your_domain&#x27;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure></li><li><p>启动gitlab</p><p>gitlab默认运行在80端口<br>需要检查防火墙状态, 如何防火墙已开启, 需要放行80端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查防火墙是否开启</span></span><br><span class="line">sudo firewall-cmd --state</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果开启, 需放行80端口</span></span><br><span class="line">sudo firewall-cmd --add-port=80/tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure><p>如果一切顺利，我们就可以启动gitlab了，启动命令为</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl start</span><br></pre></td></tr></table></figure><p>启动成功后, 可以使用浏览器访问gitlab web页面，默认端口是80, 所以可以打开<a target="_blank" rel="noopener" href="http://your_server_address/">http://your_server_address</a>访问．</p><p>如果没有设置密码，系统将为root用户生成一个随机密码，该随机密码可以在/etc/gitlab/initial_root_password文件中找到．<br>建议修改该随机密码，方式为</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-rake <span class="string">&quot;gitlab:password:reset[root]&quot;</span></span><br></pre></td></tr></table></figure><blockquote><p>参数说明: 命令中的root即为root用户，该命令也可以用来为其他用户设置密码．</p><p>关于gitlab的高级配置，可以参考<a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/install/">gitlab的官网</a></p><p>如果要配置gitlab ci/cd还需要安装gitlab-runner, gitlab-runner的安装和配置可以参考我的博客<a href="https://www.pengtech.net/gitlab/gitlab_runner_installation.html">gitlab-runner安装与配置</a>, 更多关于gitlab的文章请访问<a href="https://www.pengtech.net/gitlab/">gitlab合集</a></p></blockquote><p>这里补充几点如何启动，关闭，查看gitlab状态的命令，方便troubleshooting<br>关闭gitlab</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl stop</span><br></pre></td></tr></table></figure><p>重启gitlab</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl restart</span><br></pre></td></tr></table></figure><p>查看gitlab状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl status</span><br></pre></td></tr></table></figure><p>查看gitlab滚动日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl tail</span><br></pre></td></tr></table></figure><p>想了解更多命令，可以查看帮助</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl --<span class="built_in">help</span></span><br></pre></td></tr></table></figure><p>命令行查看gitlab版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /opt/gitlab/embedded/service/gitlab-rails/VERSION</span><br></pre></td></tr></table></figure><p>查看日志文件</p><p>日志文件位于/var/log/gitlab下, 日志是按照服务分类存放</p><p>Gitlab 日志文件位于 /var/log/gitlab/gitlab-rails/production.log</p></li></ul><h2 id="5-gitlab升级"><a href="#5-gitlab升级" class="headerlink" title="5. gitlab升级"></a>5. gitlab升级</h2><p>Gitlab的更新速度还是挺快的, 每隔一个月就会发布一个release. 如果要使用一些新特性或修补一些安全漏洞, 掌握升级技巧是必不可少的. 这里个人建议收藏文档, 原文在文章末尾有链接地址, 以备升级时使用, 知道系统是如何安装的, 又该如何升级. 原文实时更新, 踩过的坑都会记录下来.</p><p>更多关于Gitlab的release政策, 请参考gitlab官方文档<a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/policy/maintenance.html">GitLab release and maintenance policy</a></p><h3 id="5-1-升级前备份"><a href="#5-1-升级前备份" class="headerlink" title="5.1. 升级前备份"></a>5.1. 升级前备份</h3><ul><li>备份数据</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-rake gitlab:backup:create</span><br></pre></td></tr></table></figure><ul><li>备份敏感数据</li></ul><p>手动备份两个具有敏感数据的文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp  /etc/gitlab/gitlab.rb  /var/opt/gitlab/backups</span><br><span class="line"><span class="comment"># and</span></span><br><span class="line">cp  /etc/gitlab/gitlab-secrets.json  /var/opt/gitlab/backups</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>说明：</p><ul><li>备份被保存在/var/opt/gitlab/backups目录下</li><li>备份文件名格式如下: 例如1665044212_2022_10_06_14.4.1-ee_gitlab_backup.tar, 命名规则为:备份编号+日期+gitlab版本号+后缀</li><li>备份恢复的原则是对应版本的备份文件只能使用对应版本的gitlab程序进行恢复</li><li>跨版本恢复备份文件会出现恢复失败或未知错误</li><li>如果要在高版本中使用低版本的备份文件<ul><li>方法一: 在另一台机中 安装低版本gitlab 将低版本的备份程序采用低版本的gitlab恢复后再将低版本的gitlab升级到高版本, 再使用高版本的gitlab制作备份文件</li></ul></li></ul></blockquote><h3 id="5-2-开启yum缓存"><a href="#5-2-开启yum缓存" class="headerlink" title="5.2. 开启yum缓存"></a>5.2. 开启yum缓存</h3><ul><li><p>gitlab的每个安装包都接近1G大小，gitlab升级过程中可能需要反复恢复重试，如果不开启yum缓存，即每次执行yum install无论成功与否，安装包都会被清理掉，下次重试即使是相同的版本也会去服务器上重新下载，会特别慢，而且消耗服务器带宽，如果触发了镜像服务器的限流机制，升级可能会无法进行下去.</p></li><li><p>强烈建议开启yum缓存，等升级完成后再关闭缓存并手动清理 /var/cache/yum/x86_64/7/gitlab_gitlab-ee下的缓存．</p></li><li><p>开启yum 缓存步骤如下: 修改/etc/yum.conf, 将keepcache设置为1, 默认为0.<br>这样当再次重试相同版本时就可以使用-C 参数使用缓存(详细使用方法参考”开始升级章节”)，而不必去镜像服务器上重新下载．</p></li></ul><p>/etc/yum.conf</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="section">[main]</span></span><br><span class="line"><span class="attr">cachedir</span>=/var/cache/yum/<span class="variable">$basearch</span>/<span class="variable">$releasever</span></span><br><span class="line"><span class="attr">keepcache</span>=<span class="number">1</span>　<span class="comment"># 开启缓存, 1表示开启缓存, 0表示关闭缓存</span></span><br><span class="line"><span class="attr">debuglevel</span>=<span class="number">2</span></span><br><span class="line"><span class="attr">logfile</span>=/var/log/yum.log</span><br><span class="line"><span class="attr">exactarch</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">obsoletes</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">plugins</span>=<span class="number">0</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="5-3-开始升级"><a href="#5-3-开始升级" class="headerlink" title="5.3. 开始升级"></a>5.3. 开始升级</h3><ul><li>升级前需要了解升级路径，gitlab不能一次性从低版本升级到最新版，需要升级到必要的中间版本，然后一步步升级到最新版本．主要涉及到版本之间的数据的迁移(data migration)工作，所以必须经过其中关键的版本升级，才能顺利完成数据更新操作．<br>升级路径可以参考<a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/update/">官网</a> - <a target="_blank" rel="noopener" href="https://docs.gitlab.com/ee/update/#upgrade-paths">Upgrade paths</a>, 这里简要列举路径如下</li></ul><p>8.11.Z -&gt; 8.12.0 -&gt; 8.17.7 -&gt; 9.0.13 -&gt; 9.5.10 -&gt; 10.0.7 -&gt; 10.8.7-&gt; 11.0.6 -&gt; 11.11.8 -&gt; 12.0.12 -&gt; 12.1.17 -&gt; 12.10.14 -&gt; 13.0.14 -&gt; 13.1.11 -&gt; 13.8.8 -&gt; 13.12.15 -&gt; 14.0.12 -&gt; 14.3.6 -&gt; 14.9.5 -&gt; 14.10.5 -&gt; 15.0.5 -&gt; 15.1.6 (for GitLab instances with multiple web nodes) -&gt; 15.4.6 -&gt; 15.11.13 -&gt;<br>(only instances with lots of users or large pipeline variables history) &gt; 16.1 (instances with NPM packages in their package registry) &gt; 16.2.x (only instances with large pipeline variables history) &gt; 16.3 &gt; latest 16.Y.Z.</p><ul><li>首先确定gitlab版本信息, 然后再选择合适的升级路径<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">gitlab-rake gitlab:env:info</span><br><span class="line"></span><br><span class="line"><span class="comment"># 例如</span></span><br><span class="line">GitLab information</span><br><span class="line">Version:        14.4.1-ee</span><br><span class="line">Revision:       abc23a14bac</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><p>gitlab-rake中Rake并不是单词<a target="_blank" rel="noopener" href="https://philoenglish.com/query/rake">Rake</a>的意思, 它实际上是Ruby Make的简写形式, 是ruby种类似make的一种程序. 使用Rake可以做一些通用的管理和运维任务.</p><ul><li><p>升级前关闭gitlab的部分服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line">gitlab-ctl stop unicorn</span><br><span class="line">gitlab-ctl stop sidekiq</span><br><span class="line">gitlab-ctl stop nginx</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>升级命令</p><p>升级命令和安装命令是一样的, 将x.y.z-ee.0.el7替换成关键中间版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum update -y -C gitlab-ee-x.y.z-ee.0.el7</span><br></pre></td></tr></table></figure><blockquote><p>-C 参数使用缓存, 详细解释参考”开启yum缓存”</p></blockquote><p>升级完成后，<br>需要重新运行配置,否则启动会失败</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-ctl reconfigure</span><br></pre></td></tr></table></figure><p>如果有手动配置，需要重做一遍．</p><p>需要启动gitlab,等待数据迁移任务完成，然后再备份，再次进行下一个版本的升级．</p><p>如果遇到严重问题，需要回退到上一个版本，导入备份，解决问题后继续往后升级，所以备份数据很重要．</p><p>备份恢复命令如下：<br>其中636041545_2021_11_04_12.10.14为备份文件的名字，不包含文件名后缀．</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-rake gitlab:backup:restore BACKUP=1636041545_2021_11_04_12.10.14</span><br></pre></td></tr></table></figure></li><li><p>每个版本升级完成后，要启动gitlab等待数据迁移完成<br>查看数据迁移任务，有两种查看方式，可以通过web界面查看，也可以通过命令行来查看．</p><ul><li><p>web界面查看方式<br>查看迁移任务的状态，打开web界面:<br>在页面顶部, 选择 Menu &gt; Admin.<br>在页面左侧边栏，选择Monitoring &gt; Background Migrations.</p></li><li><p>命令行查看方式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-rails runner -e production <span class="string">&#x27;puts Gitlab::BackgroundMigration.remaining&#x27;</span></span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="6-gitlab迁移"><a href="#6-gitlab迁移" class="headerlink" title="6. gitlab迁移"></a>6. gitlab迁移</h2><ul><li><p>有时我们需要将gitlab迁移到新的性能更好的服务器．怎么进行迁移呢？当然方法很多，这里介绍其中的一种方式，即通过先备份，然后在新的服务器上进行还原操作．</p></li><li><p>说明: gitlab还原有一点需要注意，那就是备份文件只能是在与创建备份的gitlab版本相同的gitlab上才能恢复，备份文件的后八位即是创建该备份的gitlab的版本，该版本只能在这种版本下进行还原．</p></li></ul><h3 id="6-1-备份数据"><a href="#6-1-备份数据" class="headerlink" title="6.1. 备份数据"></a>6.1. 备份数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-rake gitlab:backup:create</span><br></pre></td></tr></table></figure><ul><li>备份文件默认(如果没有修改默认配置的情况下)保存在/var/opt/gitlab/backups目录下面．</li></ul><h3 id="6-2-在新服务器上安装gitlab"><a href="#6-2-在新服务器上安装gitlab" class="headerlink" title="6.2. 在新服务器上安装gitlab"></a>6.2. 在新服务器上安装gitlab</h3><ul><li>可以参考本文的安装部分进行安装</li></ul><h3 id="6-3-还原备份"><a href="#6-3-还原备份" class="headerlink" title="6.3. 还原备份"></a>6.3. 还原备份</h3><ul><li><p>将备份文件拷贝到新服务器的/var/opt/gitlab/backups目录下，执行恢复命令．备份文件参数，根据自己的实际情况进行修改．</p><p>首先要将旧服务器上的两个文件<code>/etc/gitlab/gitlab.rb</code>,<code>/etc/gitlab/gitlab-secrets.json</code>拷贝到新服务器, 否则后续会发现一些奇怪的问题.</p><p>并将/etc/gitlab/gitlab.rb 的external_url设置为正确的url</p><p>然后执行<code>gitlab-ctl reconfigure</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-rake gitlab:backup:restore BACKUP=1636041545_2021_11_04_12.10.14</span><br></pre></td></tr></table></figure><p>如果还原失败, 请先参考问题排查章节, 再在到网上查找解决办法.</p></li></ul><h2 id="7-如何彻底卸载gitlab"><a href="#7-如何彻底卸载gitlab" class="headerlink" title="7. 如何彻底卸载gitlab?"></a>7. 如何彻底卸载gitlab?</h2><ul><li>警告: 注意标题上彻底二字，在你不清楚卸载意味着会发生什么的时候，请不要执行以下任何步骤．</li></ul><h3 id="7-1-卸载前备份"><a href="#7-1-卸载前备份" class="headerlink" title="7.1. 卸载前备份"></a>7.1. 卸载前备份</h3><ul><li><p>卸载前执行一次备份，备份存放位置为/var/opt/gitlab/backups, 因为后续该目录也会被清除，所以请将备份拷贝到一个安全的位置，因为后续动作可能会永久的删除数据，以便后续发生问题或反悔的时候，可以从备份恢复数据．</p></li><li><p>备份数据</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-rake gitlab:backup:create</span><br></pre></td></tr></table></figure></li><li><p>备份敏感数据</p><p>手动备份两个具有敏感数据的文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp  /etc/gitlab/gitlab.rb  /var/opt/gitlab/backups</span><br><span class="line"><span class="comment"># and</span></span><br><span class="line">cp  /etc/gitlab/gitlab-secrets.json  /var/opt/gitlab/backups</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><h3 id="7-2-执行卸载"><a href="#7-2-执行卸载" class="headerlink" title="7.2. 执行卸载"></a>7.2. 执行卸载</h3><ul><li><p>关闭gitlab</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#关闭gtilab</span></span><br><span class="line">gitlab-ctl stop</span><br><span class="line"><span class="comment">#查看gitlab状态，确保已经关闭</span></span><br><span class="line">gitlab-ctl status</span><br></pre></td></tr></table></figure></li><li><p>卸载应用程序</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -e gitlab-ee</span><br></pre></td></tr></table></figure></li><li><p>删除数据残留<br>首先确认有哪些数据残留</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -name gitlab</span><br></pre></td></tr></table></figure><p>如果都是期望被删除的，那么开始执行删除操作，再次提醒将备份拷贝一份到安全位置．</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首先使用find命令查看一下有哪些数据残留</span></span><br><span class="line">find / -name gitlab </span><br><span class="line"><span class="comment"># 确定以上文件可以删除后使用删除命令进行删除</span></span><br><span class="line">find / -name gitlab | xargs rm -rf</span><br></pre></td></tr></table></figure></li></ul><h2 id="8-问题排查"><a href="#8-问题排查" class="headerlink" title="8. 问题排查"></a>8. 问题排查</h2><ul><li><p>问题 1:</p><p>从一台机迁移到另外一台机时报如下错错误</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Restoring PostgreSQL database gitlabhq_production ... ERROR:  must be owner of extension pg_trgm</span><br><span class="line">ERROR:  must be owner of extension btree_gist</span><br><span class="line">ERROR:  must be owner of extension btree_gist</span><br><span class="line">ERROR:  must be owner of extension pg_trgm</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>解决办法:</p><p>修改postgresql配置, 能从本地连接到postgresql</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ vim /var/opt/gitlab/postgresql/data/postgresql.conf</span><br><span class="line">listen_addresses = <span class="string">&#x27;*&#x27;</span></span><br><span class="line"><span class="comment"># 最下面新增两行</span></span><br><span class="line">$ vim /var/opt/gitlab/postgresql/data/pg_hba.conf</span><br><span class="line"><span class="built_in">local</span>   all         all                               trust</span><br><span class="line">host    all         all                               127.0.0.1/32 trust</span><br></pre></td></tr></table></figure><p>重启gitlab使得配置生效</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">gitlab-ctl restart</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>修改gitlab账号为超级用户</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ su - gitlab-psql</span><br><span class="line">$ /opt/gitlab/embedded/bin/psql -h 127.0.0.1 gitlabhq_production</span><br><span class="line">psql (9.2.8)</span><br><span class="line">Type <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> <span class="built_in">help</span>.</span><br><span class="line"></span><br><span class="line">gitlabhq_production=<span class="comment"># ALTER USER gitlab WITH SUPERUSER;</span></span><br><span class="line">ALTER ROLE</span><br><span class="line">gitlabhq_production=<span class="comment"># \q</span></span><br></pre></td></tr></table></figure><p>修改完gitlab用户权限后, 记得将postgresql的配置文件改回去</p><ol><li>保证安全性, 防止误操作</li><li>以免后续安装postgresql数据库是参数端口冲突</li></ol><p>参考文档: <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/09a2b0c25ecd">https://www.jianshu.com/p/09a2b0c25ecd</a></p></li><li><p>问题 2:</p><p>解决Gitlab迁移后，项目的 CI/ CD页面报500错误</p><p>原因是: gitlab默认的备份机制，是不会备份gitlab.rb和gitlab-secrets.json文件的,<br>如果这两文件还存在则将其拷贝到新的服务器, 如果不存在则将secrets 清除重设<br>参考: <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/c46aa8c8539c">https://www.jianshu.com/p/c46aa8c8539c</a></p></li></ul><h2 id="9-关联阅读"><a href="#9-关联阅读" class="headerlink" title="9. 关联阅读"></a>9. 关联阅读</h2><p><a href="https://www.pengtech.net/gitlab/gitlab_installation_upgrade.html">gitlab安装升级及迁移</a></p><p><a href="https://www.pengtech.net/gitlab/gitlab_issue_board.html">使用gitlab issue board的四种方式</a></p><p><a href="https://www.pengtech.net/gitlab/gitlab_plantuml_integration.html">GitLab集成PlantUML</a></p><p><a href="https://www.pengtech.net/gitlab/gitlab_runner_installation.html">gitlab-runner安装与配置</a></p><p><a href="https://www.pengtech.net/gitlab/gitlab_runner_on_fedora.html">fedora上安装gitlab-runner安装与配置</a></p><p><a href="https://www.pengtech.net/gitlab/gitlab_runner_on_macos.html">macOS上安装gitlab-runner安装与配置</a></p><p><a href="https://www.pengtech.net/gitlab/gitlab_runner_on_ubuntu.html">ubuntu上安装gitlab-runner安装与配置</a></p><p><a href="https://www.pengtech.net/gitlab/gitlab_runner_on_windows.html">windows上安装gitlab-runner</a></p><p><a href="https://www.pengtech.net/gitlab/gitlab_runner_on_windows.html">gitlab CICD基础</a></p></div><footer class="post-footer"><div class="reward-container"><div>您的支持是我创作深度好文的源动力!</div><button>赞赏</button><div class="post-reward"><div><img src="/imgs/rewards/wechatpay.jpg" alt="鹏叔 微信"> <span>微信</span></div><div><img src="/imgs/rewards/alipay.jpg" alt="鹏叔 支付宝"> <span>支付宝</span></div></div></div><div class="post-copyright"><ul><li class="post-copyright-author"><strong>本文作者： </strong>鹏叔</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://www.pengtech.net/gitlab/gitlab_installation_upgrade.html" title="gitlab安装升级及迁移">https://www.pengtech.net/gitlab/gitlab_installation_upgrade.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener external nofollow" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class="post-tags"><a href="/tags/gitlab/" rel="tag"><i class="fa fa-tag"></i> gitlab</a></div><div class="post-nav"><div class="post-nav-item"><a href="/gitlab/gitlab_runner_installation.html" rel="prev" title="gitlab-runner安装与配置"><i class="fa fa-chevron-left"></i> gitlab-runner安装与配置</a></div><div class="post-nav-item"><a href="/linux/linux-expect-explanation.html" rel="next" title="Linux expect 详解">Linux expect 详解 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments utterances-container"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">鹏叔</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span>站点总字数：</span> <span title="站点总字数">1.3m</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span>站点阅读时长 &asymp;</span> <span title="站点阅读时长">19:54</span></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div class="powered-by">由 <a href="https://hexo.io/" rel="noopener external nofollow" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener external nofollow" target="_blank">NexT.Mist</a> 强力驱动</div><div class="addthis_inline_share_toolbox"><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-615fe625918d4f20" async></script></div></div></footer><script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script><script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script><script src="/js/third-party/search/local-search.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.13.2/dist/mermaid.min.js","integrity":"sha256-UIQPVkGifpwMvDH5yGgORJ9sSTDq38zz6BGU6dNaKhM="}}</script><script src="/js/third-party/tags/mermaid.js"></script><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"guoapeng/guoapeng.github.io","issue_term":"pathname","theme":"github-light","cdn":"https://utteranc.es/client.js"}</script><script src="/js/third-party/comments/utterances.js"></script></body></html>